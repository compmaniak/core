<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - Dovecot coverage - lib-index/mail-index-transaction-export.c</title>
  <link rel="stylesheet" type="text/css" href="../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../index.html">top level</a> - <a href="index.html">lib-index</a> - mail-index-transaction-export.c<span style="font-size: 80%;"> (source / <a href="mail-index-transaction-export.c.func.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">Dovecot coverage</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">205</td>
            <td class="headerCovTableEntry">320</td>
            <td class="headerCovTableEntryLo">64.1 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2021-02-24</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">9</td>
            <td class="headerCovTableEntry">15</td>
            <td class="headerCovTableEntryLo">60.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Legend:</td>
            <td class="headerValueLeg">            Lines:
            <span class="coverLegendCov">hit</span>
            <span class="coverLegendNoCov">not hit</span>
</td>
            <td></td>
          </tr>
          <tr><td><img src="../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /* Copyright (c) 2003-2018 Dovecot authors, see the included COPYING file */</a>
<span class="lineNum">       2 </span>            : 
<span class="lineNum">       3 </span>            : #include &quot;lib.h&quot;
<span class="lineNum">       4 </span>            : #include &quot;array.h&quot;
<span class="lineNum">       5 </span>            : #include &quot;mail-index-private.h&quot;
<span class="lineNum">       6 </span>            : #include &quot;mail-index-modseq.h&quot;
<span class="lineNum">       7 </span>            : #include &quot;mail-transaction-log-private.h&quot;
<span class="lineNum">       8 </span>            : #include &quot;mail-index-transaction-private.h&quot;
<span class="lineNum">       9 </span>            : 
<span class="lineNum">      10 </span>            : struct mail_index_export_context {
<span class="lineNum">      11 </span>            :     struct mail_index_transaction *trans;
<span class="lineNum">      12 </span>            :     struct mail_transaction_log_append_ctx *append_ctx;
<span class="lineNum">      13 </span>            : };
<a name="14"><span class="lineNum">      14 </span>            : </a>
<span class="lineNum">      15 </span>            : static void
<span class="lineNum">      16 </span><span class="lineCov">         50 : log_append_buffer(struct mail_index_export_context *ctx,</span>
<span class="lineNum">      17 </span>            :           const buffer_t *buf, enum mail_transaction_type type)
<span class="lineNum">      18 </span>            : {
<span class="lineNum">      19 </span><span class="lineCov">         50 :     mail_transaction_log_append_add(ctx-&gt;append_ctx, type,</span>
<span class="lineNum">      20 </span>            :                     buf-&gt;data, buf-&gt;used);
<a name="21"><span class="lineNum">      21 </span><span class="lineCov">         50 : }</span></a>
<span class="lineNum">      22 </span>            : 
<span class="lineNum">      23 </span><span class="lineCov">         11 : static void log_append_flag_updates(struct mail_index_export_context *ctx,</span>
<span class="lineNum">      24 </span>            :                     struct mail_index_transaction *t)
<span class="lineNum">      25 </span>            : {
<span class="lineNum">      26 </span>            :     ARRAY(struct mail_transaction_flag_update) log_updates;
<span class="lineNum">      27 </span>            :     const struct mail_index_flag_update *updates;
<span class="lineNum">      28 </span>            :     struct mail_transaction_flag_update *log_update;
<span class="lineNum">      29 </span>            :     unsigned int i, count;
<span class="lineNum">      30 </span>            : 
<span class="lineNum">      31 </span><span class="lineCov">         11 :     updates = array_get(&amp;t-&gt;updates, &amp;count);</span>
<span class="lineNum">      32 </span><span class="lineCov">         11 :     if (count == 0)</span>
<span class="lineNum">      33 </span><span class="lineCov">         11 :         return;</span>
<span class="lineNum">      34 </span>            : 
<span class="lineNum">      35 </span><span class="lineCov">         11 :     i_array_init(&amp;log_updates, count);</span>
<span class="lineNum">      36 </span>            : 
<span class="lineNum">      37 </span><span class="lineCov">         22 :     for (i = 0; i &lt; count; i++) {</span>
<span class="lineNum">      38 </span><span class="lineCov">         11 :         log_update = array_append_space(&amp;log_updates);</span>
<span class="lineNum">      39 </span><span class="lineCov">         11 :         log_update-&gt;uid1 = updates[i].uid1;</span>
<span class="lineNum">      40 </span><span class="lineCov">         11 :         log_update-&gt;uid2 = updates[i].uid2;</span>
<span class="lineNum">      41 </span><span class="lineCov">         11 :         log_update-&gt;add_flags = updates[i].add_flags &amp; 0xff;</span>
<span class="lineNum">      42 </span><span class="lineCov">         11 :         log_update-&gt;remove_flags = updates[i].remove_flags &amp; 0xff;</span>
<span class="lineNum">      43 </span><span class="lineCov">         11 :         if ((updates[i].add_flags &amp; MAIL_INDEX_MAIL_FLAG_UPDATE_MODSEQ) != 0)</span>
<span class="lineNum">      44 </span><span class="lineNoCov">          0 :             log_update-&gt;modseq_inc_flag = 1;</span>
<span class="lineNum">      45 </span>            :     }
<span class="lineNum">      46 </span><span class="lineCov">         11 :     log_append_buffer(ctx, log_updates.arr.buffer,</span>
<span class="lineNum">      47 </span>            :               MAIL_TRANSACTION_FLAG_UPDATE);
<span class="lineNum">      48 </span><span class="lineCov">         11 :     array_free(&amp;log_updates);</span>
<span class="lineNum">      49 </span>            : }
<a name="50"><span class="lineNum">      50 </span>            : </a>
<span class="lineNum">      51 </span>            : static const buffer_t *
<span class="lineNum">      52 </span><span class="lineCov">          5 : log_get_hdr_update_buffer(struct mail_index_transaction *t, bool prepend)</span>
<span class="lineNum">      53 </span>            : {
<span class="lineNum">      54 </span>            :     buffer_t *buf;
<span class="lineNum">      55 </span>            :     const unsigned char *data, *mask;
<span class="lineNum">      56 </span>            :     struct mail_transaction_header_update u;
<span class="lineNum">      57 </span>            :     uint16_t offset;
<span class="lineNum">      58 </span><span class="lineCov">          5 :     int state = 0;</span>
<span class="lineNum">      59 </span>            : 
<span class="lineNum">      60 </span><span class="lineCov">          5 :     i_zero(&amp;u);</span>
<span class="lineNum">      61 </span>            : 
<span class="lineNum">      62 </span><span class="lineCov">          5 :     data = prepend ? t-&gt;pre_hdr_change : t-&gt;post_hdr_change;</span>
<span class="lineNum">      63 </span><span class="lineCov">          5 :     mask = prepend ? t-&gt;pre_hdr_mask : t-&gt;post_hdr_mask;</span>
<span class="lineNum">      64 </span>            : 
<span class="lineNum">      65 </span><span class="lineCov">          5 :     buf = t_buffer_create(256);</span>
<span class="lineNum">      66 </span><span class="lineCov">        610 :     for (offset = 0; offset &lt;= sizeof(t-&gt;pre_hdr_change); offset++) {</span>
<span class="lineNum">      67 </span><span class="lineCov">        605 :         if (offset &lt; sizeof(t-&gt;pre_hdr_change) &amp;&amp; mask[offset] != 0) {</span>
<span class="lineNum">      68 </span><span class="lineCov">        112 :             if (state == 0) {</span>
<span class="lineNum">      69 </span><span class="lineCov">          6 :                 u.offset = offset;</span>
<span class="lineNum">      70 </span><span class="lineCov">          6 :                 state++;</span>
<span class="lineNum">      71 </span>            :             }
<span class="lineNum">      72 </span>            :         } else {
<span class="lineNum">      73 </span><span class="lineCov">        549 :             if (state &gt; 0) {</span>
<span class="lineNum">      74 </span><span class="lineCov">          6 :                 u.size = offset - u.offset;</span>
<span class="lineNum">      75 </span><span class="lineCov">          6 :                 buffer_append(buf, &amp;u, sizeof(u));</span>
<span class="lineNum">      76 </span><span class="lineCov">          6 :                 buffer_append(buf, data + u.offset, u.size);</span>
<span class="lineNum">      77 </span><span class="lineCov">          6 :                 state = 0;</span>
<span class="lineNum">      78 </span>            :             }
<span class="lineNum">      79 </span>            :         }
<span class="lineNum">      80 </span>            :     }
<span class="lineNum">      81 </span><span class="lineCov">          5 :     return buf;</span>
<span class="lineNum">      82 </span>            : }
<a name="83"><span class="lineNum">      83 </span>            : </a>
<span class="lineNum">      84 </span>            : static unsigned int
<span class="lineNum">      85 </span><span class="lineCov">          4 : ext_hdr_update_get_size(const struct mail_index_transaction_ext_hdr_update *hu)</span>
<span class="lineNum">      86 </span>            : {
<span class="lineNum">      87 </span>            :     unsigned int i;
<span class="lineNum">      88 </span>            : 
<span class="lineNum">      89 </span><span class="lineCov">          5 :     for (i = hu-&gt;alloc_size; i &gt; 0; i--) {</span>
<span class="lineNum">      90 </span><span class="lineCov">          5 :         if (hu-&gt;mask[i-1] != 0)</span>
<span class="lineNum">      91 </span><span class="lineCov">          4 :             return i;</span>
<span class="lineNum">      92 </span>            :     }
<span class="lineNum">      93 </span><span class="lineNoCov">          0 :     return 0;</span>
<a name="94"><span class="lineNum">      94 </span>            : }</a>
<span class="lineNum">      95 </span>            : 
<span class="lineNum">      96 </span><span class="lineCov">          5 : static void log_append_ext_intro(struct mail_index_export_context *ctx,</span>
<span class="lineNum">      97 </span>            :                  uint32_t ext_id, uint32_t reset_id,
<span class="lineNum">      98 </span>            :                  unsigned int *hdr_size_r)
<span class="lineNum">      99 </span>            : {
<span class="lineNum">     100 </span><span class="lineCov">          5 :     struct mail_index_transaction *t = ctx-&gt;trans;</span>
<span class="lineNum">     101 </span>            :     const struct mail_index_registered_ext *rext;
<span class="lineNum">     102 </span>            :     const struct mail_index_ext *ext;
<span class="lineNum">     103 </span>            :         struct mail_transaction_ext_intro *intro, *resizes;
<span class="lineNum">     104 </span>            :     buffer_t *buf;
<span class="lineNum">     105 </span>            :     uint32_t idx;
<span class="lineNum">     106 </span>            :     unsigned int count;
<span class="lineNum">     107 </span>            : 
<span class="lineNum">     108 </span><span class="lineCov">          5 :     i_assert(ext_id != (uint32_t)-1);</span>
<span class="lineNum">     109 </span>            : 
<span class="lineNum">     110 </span><span class="lineCov">         10 :     if (t-&gt;reset ||</span>
<span class="lineNum">     111 </span><span class="lineCov">          5 :         !mail_index_map_get_ext_idx(t-&gt;view-&gt;index-&gt;map, ext_id, &amp;idx)) {</span>
<span class="lineNum">     112 </span>            :         /* new extension */
<span class="lineNum">     113 </span><span class="lineCov">          3 :         idx = (uint32_t)-1;</span>
<span class="lineNum">     114 </span>            :     }
<span class="lineNum">     115 </span>            : 
<span class="lineNum">     116 </span><span class="lineCov">          5 :     rext = array_idx(&amp;t-&gt;view-&gt;index-&gt;extensions, ext_id);</span>
<span class="lineNum">     117 </span><span class="lineCov">          5 :     if (!array_is_created(&amp;t-&gt;ext_resizes)) {</span>
<span class="lineNum">     118 </span><span class="lineCov">          3 :         resizes = NULL;</span>
<span class="lineNum">     119 </span><span class="lineCov">          3 :         count = 0;</span>
<span class="lineNum">     120 </span>            :     } else {
<span class="lineNum">     121 </span><span class="lineCov">          2 :         resizes = array_get_modifiable(&amp;t-&gt;ext_resizes, &amp;count);</span>
<span class="lineNum">     122 </span>            :     }
<span class="lineNum">     123 </span>            : 
<span class="lineNum">     124 </span><span class="lineCov">          5 :     buf = t_buffer_create(128);</span>
<span class="lineNum">     125 </span><span class="lineCov">          5 :     if (ext_id &lt; count &amp;&amp; resizes[ext_id].name_size != 0) {</span>
<span class="lineNum">     126 </span>            :         /* we're resizing the extension. use the resize struct. */
<span class="lineNum">     127 </span><span class="lineCov">          1 :         intro = &amp;resizes[ext_id];</span>
<span class="lineNum">     128 </span>            : 
<span class="lineNum">     129 </span><span class="lineCov">          1 :         if (idx != (uint32_t)-1) {</span>
<span class="lineNum">     130 </span><span class="lineCov">          1 :             intro-&gt;ext_id = idx;</span>
<span class="lineNum">     131 </span><span class="lineCov">          1 :             intro-&gt;name_size = 0;</span>
<span class="lineNum">     132 </span>            :         } else {
<span class="lineNum">     133 </span><span class="lineNoCov">          0 :             intro-&gt;ext_id = (uint32_t)-1;</span>
<span class="lineNum">     134 </span><span class="lineNoCov">          0 :             intro-&gt;name_size = strlen(rext-&gt;name);</span>
<span class="lineNum">     135 </span>            :         }
<span class="lineNum">     136 </span><span class="lineCov">          1 :         buffer_append(buf, intro, sizeof(*intro));</span>
<span class="lineNum">     137 </span>            :     } else {
<span class="lineNum">     138 </span>            :         /* generate a new intro structure */
<span class="lineNum">     139 </span><span class="lineCov">          4 :         intro = buffer_append_space_unsafe(buf, sizeof(*intro));</span>
<span class="lineNum">     140 </span><span class="lineCov">          4 :         intro-&gt;ext_id = idx;</span>
<span class="lineNum">     141 </span><span class="lineCov">          4 :         intro-&gt;record_size = rext-&gt;record_size;</span>
<span class="lineNum">     142 </span><span class="lineCov">          4 :         intro-&gt;record_align = rext-&gt;record_align;</span>
<span class="lineNum">     143 </span><span class="lineCov">          4 :         if (idx == (uint32_t)-1) {</span>
<span class="lineNum">     144 </span><span class="lineCov">          3 :             intro-&gt;hdr_size = rext-&gt;hdr_size;</span>
<span class="lineNum">     145 </span><span class="lineCov">          3 :             intro-&gt;name_size = strlen(rext-&gt;name);</span>
<span class="lineNum">     146 </span>            :         } else {
<span class="lineNum">     147 </span><span class="lineCov">          1 :             ext = array_idx(&amp;t-&gt;view-&gt;index-&gt;map-&gt;extensions, idx);</span>
<span class="lineNum">     148 </span><span class="lineCov">          1 :             intro-&gt;hdr_size = ext-&gt;hdr_size;</span>
<span class="lineNum">     149 </span><span class="lineCov">          1 :             intro-&gt;name_size = 0;</span>
<span class="lineNum">     150 </span>            :         }
<span class="lineNum">     151 </span><span class="lineCov">          4 :         intro-&gt;flags = MAIL_TRANSACTION_EXT_INTRO_FLAG_NO_SHRINK;</span>
<span class="lineNum">     152 </span>            : 
<span class="lineNum">     153 </span>            :         /* handle increasing header size automatically */
<span class="lineNum">     154 </span><span class="lineCov">          8 :         if (array_is_created(&amp;t-&gt;ext_hdr_updates) &amp;&amp;</span>
<span class="lineNum">     155 </span><span class="lineCov">          4 :             ext_id &lt; array_count(&amp;t-&gt;ext_hdr_updates)) {</span>
<span class="lineNum">     156 </span>            :             const struct mail_index_transaction_ext_hdr_update *hu;
<span class="lineNum">     157 </span>            :             unsigned int hdr_update_size;
<span class="lineNum">     158 </span>            : 
<span class="lineNum">     159 </span><span class="lineCov">          4 :             hu = array_idx(&amp;t-&gt;ext_hdr_updates, ext_id);</span>
<span class="lineNum">     160 </span><span class="lineCov">          4 :             hdr_update_size = ext_hdr_update_get_size(hu);</span>
<span class="lineNum">     161 </span><span class="lineCov">          4 :             if (intro-&gt;hdr_size &lt; hdr_update_size)</span>
<span class="lineNum">     162 </span><span class="lineCov">          1 :                 intro-&gt;hdr_size = hdr_update_size;</span>
<span class="lineNum">     163 </span>            :         }
<span class="lineNum">     164 </span>            :     }
<span class="lineNum">     165 </span><span class="lineCov">          5 :     i_assert(intro-&gt;record_size != 0 || intro-&gt;hdr_size != 0);</span>
<span class="lineNum">     166 </span><span class="lineCov">          5 :     if (reset_id != 0) {</span>
<span class="lineNum">     167 </span>            :         /* we're going to reset this extension in this transaction */
<span class="lineNum">     168 </span><span class="lineNoCov">          0 :         intro-&gt;reset_id = reset_id;</span>
<span class="lineNum">     169 </span><span class="lineCov">          5 :     } else if (idx != (uint32_t)-1) {</span>
<span class="lineNum">     170 </span>            :         /* use the existing reset_id */
<span class="lineNum">     171 </span><span class="lineCov">          2 :         const struct mail_index_ext *map_ext =</span>
<span class="lineNum">     172 </span><span class="lineCov">          2 :             array_idx(&amp;t-&gt;view-&gt;index-&gt;map-&gt;extensions, idx);</span>
<span class="lineNum">     173 </span><span class="lineCov">          2 :         intro-&gt;reset_id = map_ext-&gt;reset_id;</span>
<span class="lineNum">     174 </span>            :     } else {
<span class="lineNum">     175 </span>            :         /* new extension, reset_id defaults to 0 */
<span class="lineNum">     176 </span>            :     }
<span class="lineNum">     177 </span><span class="lineCov">          5 :     buffer_append(buf, rext-&gt;name, intro-&gt;name_size);</span>
<span class="lineNum">     178 </span><span class="lineCov">          5 :     if ((buf-&gt;used % 4) != 0)</span>
<span class="lineNum">     179 </span><span class="lineCov">          2 :         buffer_append_zero(buf, 4 - (buf-&gt;used % 4));</span>
<span class="lineNum">     180 </span>            : 
<span class="lineNum">     181 </span><span class="lineCov">          5 :     if (ctx-&gt;append_ctx-&gt;new_highest_modseq == 0 &amp;&amp;</span>
<span class="lineNum">     182 </span><span class="lineNoCov">          0 :         strcmp(rext-&gt;name, MAIL_INDEX_MODSEQ_EXT_NAME) == 0) {</span>
<span class="lineNum">     183 </span>            :         /* modseq tracking started */
<span class="lineNum">     184 </span><span class="lineNoCov">          0 :         ctx-&gt;append_ctx-&gt;new_highest_modseq = 1;</span>
<span class="lineNum">     185 </span>            :     }
<span class="lineNum">     186 </span>            : 
<span class="lineNum">     187 </span><span class="lineCov">          5 :     log_append_buffer(ctx, buf, MAIL_TRANSACTION_EXT_INTRO);</span>
<span class="lineNum">     188 </span><span class="lineCov">          5 :     *hdr_size_r = intro-&gt;hdr_size;</span>
<span class="lineNum">     189 </span><span class="lineCov">          5 : }</span>
<a name="190"><span class="lineNum">     190 </span>            : </a>
<span class="lineNum">     191 </span>            : static void
<span class="lineNum">     192 </span><span class="lineCov">          4 : log_append_ext_hdr_update(struct mail_index_export_context *ctx,</span>
<span class="lineNum">     193 </span>            :               const struct mail_index_transaction_ext_hdr_update *hdr,
<span class="lineNum">     194 </span>            :               unsigned int ext_hdr_size)
<span class="lineNum">     195 </span>            : {
<span class="lineNum">     196 </span>            :     buffer_t *buf;
<span class="lineNum">     197 </span>            :     const unsigned char *data, *mask;
<span class="lineNum">     198 </span>            :     struct mail_transaction_ext_hdr_update u;
<span class="lineNum">     199 </span>            :     struct mail_transaction_ext_hdr_update32 u32;
<span class="lineNum">     200 </span>            :     size_t offset;
<span class="lineNum">     201 </span><span class="lineCov">          4 :     bool started = FALSE, use_32 = hdr-&gt;alloc_size &gt;= 65536;</span>
<span class="lineNum">     202 </span>            : 
<span class="lineNum">     203 </span><span class="lineCov">          4 :     i_zero(&amp;u);</span>
<span class="lineNum">     204 </span><span class="lineCov">          4 :     i_zero(&amp;u32);</span>
<span class="lineNum">     205 </span>            : 
<span class="lineNum">     206 </span><span class="lineCov">          4 :     data = hdr-&gt;data;</span>
<span class="lineNum">     207 </span><span class="lineCov">          4 :     mask = hdr-&gt;mask;</span>
<span class="lineNum">     208 </span>            : 
<span class="lineNum">     209 </span><span class="lineCov">          4 :     buf = t_buffer_create(256);</span>
<span class="lineNum">     210 </span><span class="lineCov">         45 :     for (offset = 0; offset &lt;= hdr-&gt;alloc_size; offset++) {</span>
<span class="lineNum">     211 </span><span class="lineCov">         41 :         if (offset &lt; hdr-&gt;alloc_size &amp;&amp; mask[offset] != 0) {</span>
<span class="lineNum">     212 </span><span class="lineCov">         72 :             if (!started) {</span>
<span class="lineNum">     213 </span><span class="lineCov">          4 :                 u32.offset = offset;</span>
<span class="lineNum">     214 </span><span class="lineCov">          4 :                 started = TRUE;</span>
<span class="lineNum">     215 </span>            :             }
<span class="lineNum">     216 </span>            :         } else {
<span class="lineNum">     217 </span><span class="lineCov">          5 :             if (started) {</span>
<span class="lineNum">     218 </span><span class="lineCov">          4 :                 u32.size = offset - u32.offset;</span>
<span class="lineNum">     219 </span><span class="lineCov">          4 :                 if (use_32)</span>
<span class="lineNum">     220 </span><span class="lineNoCov">          0 :                     buffer_append(buf, &amp;u32, sizeof(u32));</span>
<span class="lineNum">     221 </span>            :                 else {
<span class="lineNum">     222 </span><span class="lineCov">          4 :                     u.offset = u32.offset;</span>
<span class="lineNum">     223 </span><span class="lineCov">          4 :                     u.size = u32.size;</span>
<span class="lineNum">     224 </span><span class="lineCov">          4 :                     buffer_append(buf, &amp;u, sizeof(u));</span>
<span class="lineNum">     225 </span>            :                 }
<span class="lineNum">     226 </span><span class="lineCov">          4 :                 i_assert(u32.offset + u32.size &lt;= ext_hdr_size);</span>
<span class="lineNum">     227 </span><span class="lineCov">          4 :                 buffer_append(buf, data + u32.offset, u32.size);</span>
<span class="lineNum">     228 </span><span class="lineCov">          4 :                 started = FALSE;</span>
<span class="lineNum">     229 </span>            :             }
<span class="lineNum">     230 </span>            :         }
<span class="lineNum">     231 </span>            :     }
<span class="lineNum">     232 </span><span class="lineCov">          4 :     if (buf-&gt;used % 4 != 0)</span>
<span class="lineNum">     233 </span><span class="lineCov">          2 :         buffer_append_zero(buf, 4 - buf-&gt;used % 4);</span>
<span class="lineNum">     234 </span><span class="lineCov">          4 :     log_append_buffer(ctx, buf, use_32 ? MAIL_TRANSACTION_EXT_HDR_UPDATE32 :</span>
<span class="lineNum">     235 </span>            :               MAIL_TRANSACTION_EXT_HDR_UPDATE);
<span class="lineNum">     236 </span><span class="lineCov">          4 : }</span>
<a name="237"><span class="lineNum">     237 </span>            : </a>
<span class="lineNum">     238 </span>            : static void
<span class="lineNum">     239 </span><span class="lineCov">         41 : mail_transaction_log_append_ext_intros(struct mail_index_export_context *ctx)</span>
<span class="lineNum">     240 </span>            : {
<span class="lineNum">     241 </span><span class="lineCov">         41 :     struct mail_index_transaction *t = ctx-&gt;trans;</span>
<span class="lineNum">     242 </span>            :         const struct mail_transaction_ext_intro *resize;
<span class="lineNum">     243 </span>            :     const struct mail_index_transaction_ext_hdr_update *hdrs;
<span class="lineNum">     244 </span>            :     struct mail_transaction_ext_reset ext_reset;
<span class="lineNum">     245 </span><span class="lineCov">         41 :     unsigned int resize_count, ext_count = 0;</span>
<span class="lineNum">     246 </span>            :     unsigned int hdrs_count, reset_id_count, reset_count, hdr_size;
<span class="lineNum">     247 </span>            :     uint32_t ext_id, reset_id;
<span class="lineNum">     248 </span>            :     const struct mail_transaction_ext_reset *reset;
<span class="lineNum">     249 </span>            :     const uint32_t *reset_ids;
<span class="lineNum">     250 </span>            :     buffer_t reset_buf;
<span class="lineNum">     251 </span>            : 
<span class="lineNum">     252 </span><span class="lineCov">         41 :     if (!array_is_created(&amp;t-&gt;ext_resizes)) {</span>
<span class="lineNum">     253 </span><span class="lineCov">         40 :         resize = NULL;</span>
<span class="lineNum">     254 </span><span class="lineCov">         40 :         resize_count = 0;</span>
<span class="lineNum">     255 </span>            :     } else {
<span class="lineNum">     256 </span><span class="lineCov">          1 :         resize = array_get(&amp;t-&gt;ext_resizes, &amp;resize_count);</span>
<span class="lineNum">     257 </span><span class="lineCov">          1 :         if (ext_count &lt; resize_count)</span>
<span class="lineNum">     258 </span><span class="lineCov">          1 :             ext_count = resize_count;</span>
<span class="lineNum">     259 </span>            :     }
<span class="lineNum">     260 </span>            : 
<span class="lineNum">     261 </span><span class="lineCov">         41 :     if (!array_is_created(&amp;t-&gt;ext_reset_ids)) {</span>
<span class="lineNum">     262 </span><span class="lineCov">         41 :         reset_ids = NULL;</span>
<span class="lineNum">     263 </span><span class="lineCov">         41 :         reset_id_count = 0;</span>
<span class="lineNum">     264 </span>            :     } else {
<span class="lineNum">     265 </span><span class="lineNoCov">          0 :         reset_ids = array_get(&amp;t-&gt;ext_reset_ids, &amp;reset_id_count);</span>
<span class="lineNum">     266 </span>            :     }
<span class="lineNum">     267 </span>            : 
<span class="lineNum">     268 </span><span class="lineCov">         41 :     if (!array_is_created(&amp;t-&gt;ext_resets)) {</span>
<span class="lineNum">     269 </span><span class="lineCov">         41 :         reset = NULL;</span>
<span class="lineNum">     270 </span><span class="lineCov">         41 :         reset_count = 0;</span>
<span class="lineNum">     271 </span>            :     } else {
<span class="lineNum">     272 </span><span class="lineNoCov">          0 :         reset = array_get(&amp;t-&gt;ext_resets, &amp;reset_count);</span>
<span class="lineNum">     273 </span><span class="lineNoCov">          0 :         if (ext_count &lt; reset_count)</span>
<span class="lineNum">     274 </span><span class="lineNoCov">          0 :             ext_count = reset_count;</span>
<span class="lineNum">     275 </span>            :     }
<span class="lineNum">     276 </span>            : 
<span class="lineNum">     277 </span><span class="lineCov">         41 :     if (!array_is_created(&amp;t-&gt;ext_hdr_updates)) {</span>
<span class="lineNum">     278 </span><span class="lineCov">         37 :         hdrs = NULL;</span>
<span class="lineNum">     279 </span><span class="lineCov">         37 :         hdrs_count = 0;</span>
<span class="lineNum">     280 </span>            :     } else {
<span class="lineNum">     281 </span><span class="lineCov">          4 :         hdrs = array_get(&amp;t-&gt;ext_hdr_updates, &amp;hdrs_count);</span>
<span class="lineNum">     282 </span><span class="lineCov">          4 :         if (ext_count &lt; hdrs_count)</span>
<span class="lineNum">     283 </span><span class="lineCov">          3 :             ext_count = hdrs_count;</span>
<span class="lineNum">     284 </span>            :     }
<span class="lineNum">     285 </span>            : 
<span class="lineNum">     286 </span><span class="lineCov">         41 :     i_zero(&amp;ext_reset);</span>
<span class="lineNum">     287 </span><span class="lineCov">         41 :     buffer_create_from_data(&amp;reset_buf, &amp;ext_reset, sizeof(ext_reset));</span>
<span class="lineNum">     288 </span><span class="lineCov">         41 :     buffer_set_used_size(&amp;reset_buf, sizeof(ext_reset));</span>
<span class="lineNum">     289 </span>            : 
<span class="lineNum">     290 </span><span class="lineCov">         54 :     for (ext_id = 0; ext_id &lt; ext_count; ext_id++) {</span>
<span class="lineNum">     291 </span><span class="lineCov">         13 :         if (ext_id &lt; reset_count)</span>
<span class="lineNum">     292 </span><span class="lineNoCov">          0 :             ext_reset = reset[ext_id];</span>
<span class="lineNum">     293 </span>            :         else
<span class="lineNum">     294 </span><span class="lineCov">         13 :             ext_reset.new_reset_id = 0;</span>
<span class="lineNum">     295 </span><span class="lineCov">         25 :         if ((ext_id &lt; resize_count &amp;&amp; resize[ext_id].name_size &gt; 0) ||</span>
<span class="lineNum">     296 </span><span class="lineCov">         24 :             ext_reset.new_reset_id != 0 ||</span>
<span class="lineNum">     297 </span><span class="lineCov">         24 :             (ext_id &lt; hdrs_count &amp;&amp; hdrs[ext_id].alloc_size &gt; 0)) {</span>
<span class="lineNum">     298 </span><span class="lineCov">          4 :             if (ext_reset.new_reset_id != 0) {</span>
<span class="lineNum">     299 </span>            :                 /* we're going to reset this extension
<span class="lineNum">     300 </span>            :                    immediately after the intro */
<span class="lineNum">     301 </span><span class="lineNoCov">          0 :                 reset_id = 0;</span>
<span class="lineNum">     302 </span>            :             } else {
<span class="lineNum">     303 </span><span class="lineCov">          8 :                 reset_id = ext_id &lt; reset_id_count ?</span>
<span class="lineNum">     304 </span><span class="lineCov">          4 :                     reset_ids[ext_id] : 0;</span>
<span class="lineNum">     305 </span>            :             }
<span class="lineNum">     306 </span><span class="lineCov">          4 :             log_append_ext_intro(ctx, ext_id, reset_id, &amp;hdr_size);</span>
<span class="lineNum">     307 </span>            :         } else {
<span class="lineNum">     308 </span><span class="lineCov">          9 :             hdr_size = 0;</span>
<span class="lineNum">     309 </span>            :         }
<span class="lineNum">     310 </span><span class="lineCov">         13 :         if (ext_reset.new_reset_id != 0) {</span>
<span class="lineNum">     311 </span><span class="lineNoCov">          0 :             i_assert(ext_id &lt; reset_id_count &amp;&amp;</span>
<span class="lineNum">     312 </span>            :                  ext_reset.new_reset_id == reset_ids[ext_id]);
<span class="lineNum">     313 </span><span class="lineNoCov">          0 :             log_append_buffer(ctx, &amp;reset_buf,</span>
<span class="lineNum">     314 </span>            :                       MAIL_TRANSACTION_EXT_RESET);
<span class="lineNum">     315 </span>            :         }
<span class="lineNum">     316 </span><span class="lineCov">         13 :         if (ext_id &lt; hdrs_count &amp;&amp; hdrs[ext_id].alloc_size &gt; 0) {</span>
<span class="lineNum">     317 </span><span class="lineCov">          4 :             T_BEGIN {</span>
<span class="lineNum">     318 </span><span class="lineCov">          4 :                 log_append_ext_hdr_update(ctx, &amp;hdrs[ext_id],</span>
<span class="lineNum">     319 </span>            :                               hdr_size);
<span class="lineNum">     320 </span><span class="lineCov">          4 :             } T_END;</span>
<span class="lineNum">     321 </span>            :         }
<span class="lineNum">     322 </span>            :     }
<a name="323"><span class="lineNum">     323 </span><span class="lineCov">         41 : }</span></a>
<span class="lineNum">     324 </span>            : 
<span class="lineNum">     325 </span><span class="lineCov">          1 : static void log_append_ext_recs(struct mail_index_export_context *ctx,</span>
<span class="lineNum">     326 </span>            :                 const ARRAY_TYPE(seq_array_array) *arr,
<span class="lineNum">     327 </span>            :                 enum mail_transaction_type type)
<span class="lineNum">     328 </span>            : {
<span class="lineNum">     329 </span><span class="lineCov">          1 :     struct mail_index_transaction *t = ctx-&gt;trans;</span>
<span class="lineNum">     330 </span>            :     const ARRAY_TYPE(seq_array) *updates;
<span class="lineNum">     331 </span>            :     const uint32_t *reset_ids;
<span class="lineNum">     332 </span>            :     unsigned int ext_id, count, reset_id_count, hdr_size;
<span class="lineNum">     333 </span>            :     uint32_t reset_id;
<span class="lineNum">     334 </span>            : 
<span class="lineNum">     335 </span><span class="lineCov">          1 :     if (!array_is_created(&amp;t-&gt;ext_reset_ids)) {</span>
<span class="lineNum">     336 </span><span class="lineCov">          1 :         reset_ids = NULL;</span>
<span class="lineNum">     337 </span><span class="lineCov">          1 :         reset_id_count = 0;</span>
<span class="lineNum">     338 </span>            :     } else {
<span class="lineNum">     339 </span><span class="lineNoCov">          0 :         reset_ids = array_get_modifiable(&amp;t-&gt;ext_reset_ids,</span>
<span class="lineNum">     340 </span>            :                          &amp;reset_id_count);
<span class="lineNum">     341 </span>            :     }
<span class="lineNum">     342 </span>            : 
<span class="lineNum">     343 </span><span class="lineCov">          1 :     updates = array_get(arr, &amp;count);</span>
<span class="lineNum">     344 </span><span class="lineCov">          4 :     for (ext_id = 0; ext_id &lt; count; ext_id++) {</span>
<span class="lineNum">     345 </span><span class="lineCov">          3 :         if (!array_is_created(&amp;updates[ext_id]))</span>
<span class="lineNum">     346 </span><span class="lineCov">          2 :             continue;</span>
<span class="lineNum">     347 </span>            : 
<span class="lineNum">     348 </span><span class="lineCov">          1 :         reset_id = ext_id &lt; reset_id_count ? reset_ids[ext_id] : 0;</span>
<span class="lineNum">     349 </span><span class="lineCov">          1 :         log_append_ext_intro(ctx, ext_id, reset_id, &amp;hdr_size);</span>
<span class="lineNum">     350 </span>            : 
<span class="lineNum">     351 </span><span class="lineCov">          1 :         log_append_buffer(ctx, updates[ext_id].arr.buffer, type);</span>
<span class="lineNum">     352 </span>            :     }
<span class="lineNum">     353 </span><span class="lineCov">          1 : }</span>
<a name="354"><span class="lineNum">     354 </span>            : </a>
<span class="lineNum">     355 </span>            : static void
<span class="lineNum">     356 </span><span class="lineNoCov">          0 : log_append_keyword_update(struct mail_index_export_context *ctx,</span>
<span class="lineNum">     357 </span>            :               buffer_t *tmp_buf, enum modify_type modify_type,
<span class="lineNum">     358 </span>            :               const char *keyword, const buffer_t *uid_buffer)
<span class="lineNum">     359 </span>            : {
<span class="lineNum">     360 </span>            :     struct mail_transaction_keyword_update kt_hdr;
<span class="lineNum">     361 </span>            : 
<span class="lineNum">     362 </span><span class="lineNoCov">          0 :     i_assert(uid_buffer-&gt;used &gt; 0);</span>
<span class="lineNum">     363 </span>            : 
<span class="lineNum">     364 </span><span class="lineNoCov">          0 :     i_zero(&amp;kt_hdr);</span>
<span class="lineNum">     365 </span><span class="lineNoCov">          0 :     kt_hdr.modify_type = modify_type;</span>
<span class="lineNum">     366 </span><span class="lineNoCov">          0 :     kt_hdr.name_size = strlen(keyword);</span>
<span class="lineNum">     367 </span>            : 
<span class="lineNum">     368 </span><span class="lineNoCov">          0 :     buffer_set_used_size(tmp_buf, 0);</span>
<span class="lineNum">     369 </span><span class="lineNoCov">          0 :     buffer_append(tmp_buf, &amp;kt_hdr, sizeof(kt_hdr));</span>
<span class="lineNum">     370 </span><span class="lineNoCov">          0 :     buffer_append(tmp_buf, keyword, kt_hdr.name_size);</span>
<span class="lineNum">     371 </span><span class="lineNoCov">          0 :     if ((tmp_buf-&gt;used % 4) != 0)</span>
<span class="lineNum">     372 </span><span class="lineNoCov">          0 :         buffer_append_zero(tmp_buf, 4 - (tmp_buf-&gt;used % 4));</span>
<span class="lineNum">     373 </span><span class="lineNoCov">          0 :     buffer_append(tmp_buf, uid_buffer-&gt;data, uid_buffer-&gt;used);</span>
<span class="lineNum">     374 </span>            : 
<span class="lineNum">     375 </span><span class="lineNoCov">          0 :     log_append_buffer(ctx, tmp_buf, MAIL_TRANSACTION_KEYWORD_UPDATE);</span>
<span class="lineNum">     376 </span><span class="lineNoCov">          0 : }</span>
<a name="377"><span class="lineNum">     377 </span>            : </a>
<span class="lineNum">     378 </span>            : static enum mail_index_fsync_mask
<span class="lineNum">     379 </span><span class="lineNoCov">          0 : log_append_keyword_updates(struct mail_index_export_context *ctx)</span>
<span class="lineNum">     380 </span>            : {
<span class="lineNum">     381 </span>            :         const struct mail_index_transaction_keyword_update *updates;
<span class="lineNum">     382 </span>            :     const char *const *keywords;
<span class="lineNum">     383 </span>            :     buffer_t *tmp_buf;
<span class="lineNum">     384 </span><span class="lineNoCov">          0 :     enum mail_index_fsync_mask change_mask = 0;</span>
<span class="lineNum">     385 </span>            :     unsigned int i, count, keywords_count;
<span class="lineNum">     386 </span>            : 
<span class="lineNum">     387 </span><span class="lineNoCov">          0 :     tmp_buf = t_buffer_create(64);</span>
<span class="lineNum">     388 </span>            : 
<span class="lineNum">     389 </span><span class="lineNoCov">          0 :     keywords = array_get_modifiable(&amp;ctx-&gt;trans-&gt;view-&gt;index-&gt;keywords,</span>
<span class="lineNum">     390 </span>            :                     &amp;keywords_count);
<span class="lineNum">     391 </span><span class="lineNoCov">          0 :     updates = array_get_modifiable(&amp;ctx-&gt;trans-&gt;keyword_updates, &amp;count);</span>
<span class="lineNum">     392 </span><span class="lineNoCov">          0 :     i_assert(count &lt;= keywords_count);</span>
<span class="lineNum">     393 </span>            : 
<span class="lineNum">     394 </span><span class="lineNoCov">          0 :     for (i = 0; i &lt; count; i++) {</span>
<span class="lineNum">     395 </span><span class="lineNoCov">          0 :         if (array_is_created(&amp;updates[i].add_seq) &amp;&amp;</span>
<span class="lineNum">     396 </span><span class="lineNoCov">          0 :             array_count(&amp;updates[i].add_seq) &gt; 0) {</span>
<span class="lineNum">     397 </span><span class="lineNoCov">          0 :             change_mask |= MAIL_INDEX_FSYNC_MASK_KEYWORDS;</span>
<span class="lineNum">     398 </span><span class="lineNoCov">          0 :             log_append_keyword_update(ctx, tmp_buf,</span>
<span class="lineNum">     399 </span><span class="lineNoCov">          0 :                     MODIFY_ADD, keywords[i],</span>
<span class="lineNum">     400 </span><span class="lineNoCov">          0 :                     updates[i].add_seq.arr.buffer);</span>
<span class="lineNum">     401 </span>            :         }
<span class="lineNum">     402 </span><span class="lineNoCov">          0 :         if (array_is_created(&amp;updates[i].remove_seq) &amp;&amp;</span>
<span class="lineNum">     403 </span><span class="lineNoCov">          0 :             array_count(&amp;updates[i].remove_seq) &gt; 0) {</span>
<span class="lineNum">     404 </span><span class="lineNoCov">          0 :             change_mask |= MAIL_INDEX_FSYNC_MASK_KEYWORDS;</span>
<span class="lineNum">     405 </span><span class="lineNoCov">          0 :             log_append_keyword_update(ctx, tmp_buf,</span>
<span class="lineNum">     406 </span><span class="lineNoCov">          0 :                     MODIFY_REMOVE, keywords[i],</span>
<span class="lineNum">     407 </span><span class="lineNoCov">          0 :                     updates[i].remove_seq.arr.buffer);</span>
<span class="lineNum">     408 </span>            :         }
<span class="lineNum">     409 </span>            :     }
<span class="lineNum">     410 </span><span class="lineNoCov">          0 :     return change_mask;</span>
<a name="411"><span class="lineNum">     411 </span>            : }</a>
<span class="lineNum">     412 </span>            : 
<span class="lineNum">     413 </span><span class="lineCov">         41 : void mail_index_transaction_export(struct mail_index_transaction *t,</span>
<span class="lineNum">     414 </span>            :                    struct mail_transaction_log_append_ctx *append_ctx)
<span class="lineNum">     415 </span>            : {
<span class="lineNum">     416 </span>            :     static uint8_t null4[4] = { 0, 0, 0, 0 };
<span class="lineNum">     417 </span><span class="lineCov">         41 :     enum mail_index_fsync_mask change_mask = 0;</span>
<span class="lineNum">     418 </span>            :     struct mail_index_export_context ctx;
<span class="lineNum">     419 </span>            : 
<span class="lineNum">     420 </span><span class="lineCov">         41 :     i_zero(&amp;ctx);</span>
<span class="lineNum">     421 </span><span class="lineCov">         41 :     ctx.trans = t;</span>
<span class="lineNum">     422 </span><span class="lineCov">         41 :     ctx.append_ctx = append_ctx;</span>
<span class="lineNum">     423 </span>            : 
<span class="lineNum">     424 </span><span class="lineCov">         41 :     if (t-&gt;index_undeleted) {</span>
<span class="lineNum">     425 </span><span class="lineNoCov">          0 :         i_assert(!t-&gt;index_deleted);</span>
<span class="lineNum">     426 </span><span class="lineNoCov">          0 :         mail_transaction_log_append_add(ctx.append_ctx,</span>
<span class="lineNum">     427 </span>            :             MAIL_TRANSACTION_INDEX_UNDELETED, &amp;null4, 4);
<span class="lineNum">     428 </span>            :     }
<span class="lineNum">     429 </span>            : 
<span class="lineNum">     430 </span>            :     /* send all extension introductions and resizes before appends
<span class="lineNum">     431 </span>            :        to avoid resize overhead as much as possible */
<span class="lineNum">     432 </span><span class="lineCov">         41 :         mail_transaction_log_append_ext_intros(&amp;ctx);</span>
<span class="lineNum">     433 </span>            : 
<span class="lineNum">     434 </span><span class="lineCov">         41 :     if (t-&gt;pre_hdr_changed) {</span>
<span class="lineNum">     435 </span><span class="lineCov">          4 :         log_append_buffer(&amp;ctx, log_get_hdr_update_buffer(t, TRUE),</span>
<span class="lineNum">     436 </span>            :                   MAIL_TRANSACTION_HEADER_UPDATE);
<span class="lineNum">     437 </span>            :     }
<span class="lineNum">     438 </span><span class="lineCov">         41 :     if (t-&gt;attribute_updates != NULL) {</span>
<span class="lineNum">     439 </span><span class="lineCov">          5 :         buffer_append_c(t-&gt;attribute_updates, '\0');</span>
<span class="lineNum">     440 </span>            :         /* need to have 32bit alignment */
<span class="lineNum">     441 </span><span class="lineCov">          5 :         if (t-&gt;attribute_updates-&gt;used % 4 != 0) {</span>
<span class="lineNum">     442 </span><span class="lineCov">          5 :             buffer_append_zero(t-&gt;attribute_updates,</span>
<span class="lineNum">     443 </span><span class="lineCov">          5 :                        4 - t-&gt;attribute_updates-&gt;used % 4);</span>
<span class="lineNum">     444 </span>            :         }
<span class="lineNum">     445 </span>            :         /* append the timestamp and value lengths */
<span class="lineNum">     446 </span><span class="lineCov">         10 :         buffer_append(t-&gt;attribute_updates,</span>
<span class="lineNum">     447 </span><span class="lineCov">          5 :                   t-&gt;attribute_updates_suffix-&gt;data,</span>
<span class="lineNum">     448 </span><span class="lineCov">          5 :                   t-&gt;attribute_updates_suffix-&gt;used);</span>
<span class="lineNum">     449 </span><span class="lineCov">          5 :         i_assert(t-&gt;attribute_updates-&gt;used % 4 == 0);</span>
<span class="lineNum">     450 </span><span class="lineCov">          5 :         log_append_buffer(&amp;ctx, t-&gt;attribute_updates,</span>
<span class="lineNum">     451 </span>            :                   MAIL_TRANSACTION_ATTRIBUTE_UPDATE);
<span class="lineNum">     452 </span>            :     }
<span class="lineNum">     453 </span><span class="lineCov">         41 :     if (array_is_created(&amp;t-&gt;appends)) {</span>
<span class="lineNum">     454 </span><span class="lineCov">         19 :         change_mask |= MAIL_INDEX_FSYNC_MASK_APPENDS;</span>
<span class="lineNum">     455 </span><span class="lineCov">         19 :         log_append_buffer(&amp;ctx, t-&gt;appends.arr.buffer,</span>
<span class="lineNum">     456 </span>            :                   MAIL_TRANSACTION_APPEND);
<span class="lineNum">     457 </span>            :     }
<span class="lineNum">     458 </span>            : 
<span class="lineNum">     459 </span><span class="lineCov">         41 :     if (array_is_created(&amp;t-&gt;updates)) {</span>
<span class="lineNum">     460 </span><span class="lineCov">         11 :         change_mask |= MAIL_INDEX_FSYNC_MASK_FLAGS;</span>
<span class="lineNum">     461 </span><span class="lineCov">         11 :         log_append_flag_updates(&amp;ctx, t);</span>
<span class="lineNum">     462 </span>            :     }
<span class="lineNum">     463 </span>            : 
<span class="lineNum">     464 </span><span class="lineCov">         41 :     if (array_is_created(&amp;t-&gt;ext_rec_updates)) {</span>
<span class="lineNum">     465 </span><span class="lineCov">          1 :         log_append_ext_recs(&amp;ctx, &amp;t-&gt;ext_rec_updates,</span>
<span class="lineNum">     466 </span>            :                     MAIL_TRANSACTION_EXT_REC_UPDATE);
<span class="lineNum">     467 </span>            :     }
<span class="lineNum">     468 </span><span class="lineCov">         41 :     if (array_is_created(&amp;t-&gt;ext_rec_atomics)) {</span>
<span class="lineNum">     469 </span><span class="lineNoCov">          0 :         log_append_ext_recs(&amp;ctx, &amp;t-&gt;ext_rec_atomics,</span>
<span class="lineNum">     470 </span>            :                     MAIL_TRANSACTION_EXT_ATOMIC_INC);
<span class="lineNum">     471 </span>            :     }
<span class="lineNum">     472 </span>            : 
<span class="lineNum">     473 </span><span class="lineCov">         41 :     if (array_is_created(&amp;t-&gt;keyword_updates))</span>
<span class="lineNum">     474 </span><span class="lineNoCov">          0 :         change_mask |= log_append_keyword_updates(&amp;ctx);</span>
<span class="lineNum">     475 </span>            :     /* keep modseq updates almost last */
<span class="lineNum">     476 </span><span class="lineCov">         41 :     if (array_is_created(&amp;t-&gt;modseq_updates)) {</span>
<span class="lineNum">     477 </span><span class="lineNoCov">          0 :         log_append_buffer(&amp;ctx, t-&gt;modseq_updates.arr.buffer,</span>
<span class="lineNum">     478 </span>            :                   MAIL_TRANSACTION_MODSEQ_UPDATE);
<span class="lineNum">     479 </span>            :     }
<span class="lineNum">     480 </span>            : 
<span class="lineNum">     481 </span><span class="lineCov">         41 :     if (array_is_created(&amp;t-&gt;expunges)) {</span>
<span class="lineNum">     482 </span>            :         /* non-external expunges are only requests, ignore them when
<span class="lineNum">     483 </span>            :            checking fsync_mask */
<span class="lineNum">     484 </span><span class="lineNoCov">          0 :         if ((t-&gt;flags &amp; MAIL_INDEX_TRANSACTION_FLAG_EXTERNAL) != 0)</span>
<span class="lineNum">     485 </span><span class="lineNoCov">          0 :             change_mask |= MAIL_INDEX_FSYNC_MASK_EXPUNGES;</span>
<span class="lineNum">     486 </span><span class="lineNoCov">          0 :         log_append_buffer(&amp;ctx, t-&gt;expunges.arr.buffer,</span>
<span class="lineNum">     487 </span>            :                   MAIL_TRANSACTION_EXPUNGE_GUID);
<span class="lineNum">     488 </span>            :     }
<span class="lineNum">     489 </span>            : 
<span class="lineNum">     490 </span><span class="lineCov">         41 :     if (t-&gt;post_hdr_changed) {</span>
<span class="lineNum">     491 </span><span class="lineCov">          1 :         log_append_buffer(&amp;ctx, log_get_hdr_update_buffer(t, FALSE),</span>
<span class="lineNum">     492 </span>            :                   MAIL_TRANSACTION_HEADER_UPDATE);
<span class="lineNum">     493 </span>            :     }
<span class="lineNum">     494 </span>            : 
<span class="lineNum">     495 </span><span class="lineCov">         41 :     if (t-&gt;index_deleted) {</span>
<span class="lineNum">     496 </span><span class="lineNoCov">          0 :         i_assert(!t-&gt;index_undeleted);</span>
<span class="lineNum">     497 </span><span class="lineNoCov">          0 :         mail_transaction_log_append_add(ctx.append_ctx,</span>
<span class="lineNum">     498 </span>            :                         MAIL_TRANSACTION_INDEX_DELETED,
<span class="lineNum">     499 </span>            :                         &amp;null4, 4);
<span class="lineNum">     500 </span>            :     }
<span class="lineNum">     501 </span>            : 
<span class="lineNum">     502 </span><span class="lineCov">         41 :     append_ctx-&gt;index_sync_transaction = t-&gt;sync_transaction;</span>
<span class="lineNum">     503 </span><span class="lineCov">         41 :     append_ctx-&gt;tail_offset_changed = t-&gt;tail_offset_changed;</span>
<span class="lineNum">     504 </span><span class="lineCov">         41 :     append_ctx-&gt;want_fsync =</span>
<span class="lineNum">     505 </span><span class="lineCov">         82 :         (t-&gt;view-&gt;index-&gt;fsync_mask &amp; change_mask) != 0 ||</span>
<span class="lineNum">     506 </span><span class="lineCov">         41 :         (t-&gt;flags &amp; MAIL_INDEX_TRANSACTION_FLAG_FSYNC) != 0;</span>
<span class="lineNum">     507 </span><span class="lineCov">         41 : }</span>
<a name="508"><span class="lineNum">     508 </span>            : </a>
<span class="lineNum">     509 </span>            : static unsigned int
<span class="lineNum">     510 </span><span class="lineNoCov">          0 : count_modseq_incs_with(struct mail_index_transaction *t,</span>
<span class="lineNum">     511 </span>            :                ARRAY_TYPE(seq_range) *tmp_seqs,
<span class="lineNum">     512 </span>            :                const ARRAY_TYPE(seq_range) *orig_seqs)
<span class="lineNum">     513 </span>            : {
<span class="lineNum">     514 </span><span class="lineNoCov">          0 :     if (!array_is_created(orig_seqs))</span>
<span class="lineNum">     515 </span><span class="lineNoCov">          0 :         return 0;</span>
<span class="lineNum">     516 </span>            : 
<span class="lineNum">     517 </span><span class="lineNoCov">          0 :     array_clear(tmp_seqs);</span>
<span class="lineNum">     518 </span><span class="lineNoCov">          0 :     array_append_array(tmp_seqs, orig_seqs);</span>
<span class="lineNum">     519 </span><span class="lineNoCov">          0 :     mail_index_transaction_seq_range_to_uid(t, tmp_seqs);</span>
<span class="lineNum">     520 </span><span class="lineNoCov">          0 :     return array_count(tmp_seqs) &gt; 0 ? 1 : 0;</span>
<span class="lineNum">     521 </span>            : }
<a name="522"><span class="lineNum">     522 </span>            : </a>
<span class="lineNum">     523 </span>            : static unsigned int
<span class="lineNum">     524 </span><span class="lineNoCov">          0 : mail_index_transaction_keywords_count_modseq_incs(struct mail_index_transaction *t)</span>
<span class="lineNum">     525 </span>            : {
<span class="lineNum">     526 </span>            :         const struct mail_index_transaction_keyword_update *update;
<span class="lineNum">     527 </span>            :     ARRAY_TYPE(seq_range) tmp_seqs;
<span class="lineNum">     528 </span><span class="lineNoCov">          0 :     unsigned int count = 0;</span>
<span class="lineNum">     529 </span>            : 
<span class="lineNum">     530 </span><span class="lineNoCov">          0 :     i_array_init(&amp;tmp_seqs, 64);</span>
<span class="lineNum">     531 </span><span class="lineNoCov">          0 :     array_foreach_modifiable(&amp;t-&gt;keyword_updates, update) {</span>
<span class="lineNum">     532 </span><span class="lineNoCov">          0 :         count += count_modseq_incs_with(t, &amp;tmp_seqs, &amp;update-&gt;add_seq);</span>
<span class="lineNum">     533 </span><span class="lineNoCov">          0 :         count += count_modseq_incs_with(t, &amp;tmp_seqs, &amp;update-&gt;remove_seq);</span>
<span class="lineNum">     534 </span>            :     }
<span class="lineNum">     535 </span><span class="lineNoCov">          0 :     array_free(&amp;tmp_seqs);</span>
<span class="lineNum">     536 </span><span class="lineNoCov">          0 :     return count;</span>
<span class="lineNum">     537 </span>            : }
<a name="538"><span class="lineNum">     538 </span>            : </a>
<span class="lineNum">     539 </span>            : static bool
<span class="lineNum">     540 </span><span class="lineNoCov">          0 : transaction_flag_updates_have_non_internal(struct mail_index_transaction *t)</span>
<span class="lineNum">     541 </span>            : {
<span class="lineNum">     542 </span><span class="lineNoCov">          0 :     struct mail_transaction_log_file *file = t-&gt;view-&gt;index-&gt;log-&gt;head;</span>
<span class="lineNum">     543 </span><span class="lineNoCov">          0 :     const uint8_t internal_flags =</span>
<span class="lineNum">     544 </span>            :         MAIL_INDEX_MAIL_FLAG_BACKEND | MAIL_INDEX_MAIL_FLAG_DIRTY;
<span class="lineNum">     545 </span>            :     const struct mail_index_flag_update *u;
<span class="lineNum">     546 </span><span class="lineNoCov">          0 :     const unsigned int hdr_version =</span>
<span class="lineNum">     547 </span><span class="lineNoCov">          0 :         MAIL_TRANSACTION_LOG_HDR_VERSION(&amp;file-&gt;hdr);</span>
<span class="lineNum">     548 </span>            : 
<span class="lineNum">     549 </span><span class="lineNoCov">          0 :     if (!MAIL_TRANSACTION_LOG_VERSION_HAVE(hdr_version, HIDE_INTERNAL_MODSEQS)) {</span>
<span class="lineNum">     550 </span>            :         /* this check can be a bit racy if the call isn't done while
<span class="lineNum">     551 </span>            :            transaction log is locked. practically it won't matter
<span class="lineNum">     552 </span>            :            now though. */
<span class="lineNum">     553 </span><span class="lineNoCov">          0 :         return array_count(&amp;t-&gt;updates) &gt; 0;</span>
<span class="lineNum">     554 </span>            :     }
<span class="lineNum">     555 </span>            : 
<span class="lineNum">     556 </span><span class="lineNoCov">          0 :     array_foreach(&amp;t-&gt;updates, u) {</span>
<span class="lineNum">     557 </span><span class="lineNoCov">          0 :         uint8_t changed_flags = u-&gt;add_flags | u-&gt;remove_flags;</span>
<span class="lineNum">     558 </span>            : 
<span class="lineNum">     559 </span><span class="lineNoCov">          0 :         if ((changed_flags &amp; ~internal_flags) != 0)</span>
<span class="lineNum">     560 </span><span class="lineNoCov">          0 :             return TRUE;</span>
<span class="lineNum">     561 </span>            :     }
<span class="lineNum">     562 </span><span class="lineNoCov">          0 :     return FALSE;</span>
<a name="563"><span class="lineNum">     563 </span>            : }</a>
<span class="lineNum">     564 </span>            : 
<span class="lineNum">     565 </span><span class="lineNoCov">          0 : uint64_t mail_index_transaction_get_highest_modseq(struct mail_index_transaction *t)</span>
<span class="lineNum">     566 </span>            : {
<span class="lineNum">     567 </span><span class="lineNoCov">          0 :     struct mail_transaction_log_file *file = t-&gt;view-&gt;index-&gt;log-&gt;head;</span>
<span class="lineNum">     568 </span><span class="lineNoCov">          0 :     uint64_t new_highest_modseq = file-&gt;sync_highest_modseq;</span>
<span class="lineNum">     569 </span>            : 
<span class="lineNum">     570 </span><span class="lineNoCov">          0 :     i_assert(file-&gt;locked);</span>
<span class="lineNum">     571 </span>            : 
<span class="lineNum">     572 </span><span class="lineNoCov">          0 :     if (new_highest_modseq == 0) {</span>
<span class="lineNum">     573 </span>            :         /* highest-modseq tracking isn't enabled in this transaction
<span class="lineNum">     574 </span>            :            log file. This shouldn't happen with logs created since
<span class="lineNum">     575 </span>            :            v2.2.26+, because initial_modseq is always set. We don't
<span class="lineNum">     576 </span>            :            also bother checking if this transaction itself enables the
<span class="lineNum">     577 </span>            :            highest-modseq tracking, because it's always done as a
<span class="lineNum">     578 </span>            :            standalone transaction in mail_index_modseq_enable(),
<span class="lineNum">     579 </span>            :            which doesn't care about this function. */
<span class="lineNum">     580 </span><span class="lineNoCov">          0 :         i_warning(&quot;%s: Requested highest-modseq for transaction, &quot;</span>
<span class="lineNum">     581 </span>            :               &quot;but modseq tracking isn't enabled for the file &quot;
<span class="lineNum">     582 </span>            :               &quot;(this shouldn't happen)&quot;, file-&gt;filepath);
<span class="lineNum">     583 </span><span class="lineNoCov">          0 :         return 0;</span>
<span class="lineNum">     584 </span>            :     }
<span class="lineNum">     585 </span>            : 
<span class="lineNum">     586 </span>            :     /* finish everything that can affect highest-modseq */
<span class="lineNum">     587 </span><span class="lineNoCov">          0 :     mail_index_transaction_finish_so_far(t);</span>
<span class="lineNum">     588 </span>            : 
<span class="lineNum">     589 </span>            :     /* NOTE: keep in sync with mail_transaction_update_modseq() */
<span class="lineNum">     590 </span><span class="lineNoCov">          0 :     if (array_is_created(&amp;t-&gt;appends) &amp;&amp; array_count(&amp;t-&gt;appends) &gt; 0) {</span>
<span class="lineNum">     591 </span>            :         /* sorting may change the order of keyword_updates,  */
<span class="lineNum">     592 </span><span class="lineNoCov">          0 :         new_highest_modseq++;</span>
<span class="lineNum">     593 </span>            :     }
<span class="lineNum">     594 </span><span class="lineNoCov">          0 :     if (array_is_created(&amp;t-&gt;updates) &amp;&amp;</span>
<span class="lineNum">     595 </span><span class="lineNoCov">          0 :         transaction_flag_updates_have_non_internal(t))</span>
<span class="lineNum">     596 </span><span class="lineNoCov">          0 :         new_highest_modseq++;</span>
<span class="lineNum">     597 </span><span class="lineNoCov">          0 :     if (array_is_created(&amp;t-&gt;keyword_updates)) {</span>
<span class="lineNum">     598 </span><span class="lineNoCov">          0 :         new_highest_modseq +=</span>
<span class="lineNum">     599 </span><span class="lineNoCov">          0 :             mail_index_transaction_keywords_count_modseq_incs(t);</span>
<span class="lineNum">     600 </span>            :     }
<span class="lineNum">     601 </span><span class="lineNoCov">          0 :     if (t-&gt;attribute_updates != NULL)</span>
<span class="lineNum">     602 </span><span class="lineNoCov">          0 :         new_highest_modseq++;</span>
<span class="lineNum">     603 </span>            :     /* NOTE: the order of modseq_updates and everything following it
<span class="lineNum">     604 </span>            :        must match mail_index_transaction_export(). */
<span class="lineNum">     605 </span><span class="lineNoCov">          0 :     if (array_is_created(&amp;t-&gt;modseq_updates)) {</span>
<span class="lineNum">     606 </span>            :         const struct mail_transaction_modseq_update *mu;
<span class="lineNum">     607 </span>            : 
<span class="lineNum">     608 </span>            :         /* mail_index_update_highest_modseq() is handled here also,
<span class="lineNum">     609 </span>            :            as a special case of uid==0. */
<span class="lineNum">     610 </span><span class="lineNoCov">          0 :         array_foreach(&amp;t-&gt;modseq_updates, mu) {</span>
<span class="lineNum">     611 </span><span class="lineNoCov">          0 :             uint64_t modseq = ((uint64_t)mu-&gt;modseq_high32 &lt;&lt; 32) |</span>
<span class="lineNum">     612 </span><span class="lineNoCov">          0 :                 mu-&gt;modseq_low32;</span>
<span class="lineNum">     613 </span><span class="lineNoCov">          0 :             if (new_highest_modseq &lt; modseq)</span>
<span class="lineNum">     614 </span><span class="lineNoCov">          0 :                 new_highest_modseq = modseq;</span>
<span class="lineNum">     615 </span>            :         }
<span class="lineNum">     616 </span>            :     }
<span class="lineNum">     617 </span><span class="lineNoCov">          0 :     if (array_is_created(&amp;t-&gt;expunges) &amp;&amp; array_count(&amp;t-&gt;expunges) &gt; 0 &amp;&amp;</span>
<span class="lineNum">     618 </span><span class="lineNoCov">          0 :         (t-&gt;flags &amp; MAIL_INDEX_TRANSACTION_FLAG_EXTERNAL) != 0)</span>
<span class="lineNum">     619 </span><span class="lineNoCov">          0 :         new_highest_modseq++;</span>
<span class="lineNum">     620 </span><span class="lineNoCov">          0 :     return new_highest_modseq;</span>
<span class="lineNum">     621 </span>            : }
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.10</a></td></tr>
  </table>
  <br>

</body>
</html>
