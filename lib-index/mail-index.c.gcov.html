<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - Dovecot coverage - lib-index/mail-index.c</title>
  <link rel="stylesheet" type="text/css" href="../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../index.html">top level</a> - <a href="index.html">lib-index</a> - mail-index.c<span style="font-size: 80%;"> (source / <a href="mail-index.c.func.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">Dovecot coverage</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">306</td>
            <td class="headerCovTableEntry">580</td>
            <td class="headerCovTableEntryLo">52.8 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2021-02-24</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">33</td>
            <td class="headerCovTableEntry">53</td>
            <td class="headerCovTableEntryLo">62.3 %</td>
          </tr>
          <tr>
            <td class="headerItem">Legend:</td>
            <td class="headerValueLeg">            Lines:
            <span class="coverLegendCov">hit</span>
            <span class="coverLegendNoCov">not hit</span>
</td>
            <td></td>
          </tr>
          <tr><td><img src="../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /* Copyright (c) 2003-2018 Dovecot authors, see the included COPYING file */</a>
<span class="lineNum">       2 </span>            : 
<span class="lineNum">       3 </span>            : #include &quot;lib.h&quot;
<span class="lineNum">       4 </span>            : #include &quot;ioloop.h&quot;
<span class="lineNum">       5 </span>            : #include &quot;array.h&quot;
<span class="lineNum">       6 </span>            : #include &quot;buffer.h&quot;
<span class="lineNum">       7 </span>            : #include &quot;eacces-error.h&quot;
<span class="lineNum">       8 </span>            : #include &quot;hash.h&quot;
<span class="lineNum">       9 </span>            : #include &quot;str-sanitize.h&quot;
<span class="lineNum">      10 </span>            : #include &quot;mmap-util.h&quot;
<span class="lineNum">      11 </span>            : #include &quot;nfs-workarounds.h&quot;
<span class="lineNum">      12 </span>            : #include &quot;read-full.h&quot;
<span class="lineNum">      13 </span>            : #include &quot;write-full.h&quot;
<span class="lineNum">      14 </span>            : #include &quot;mail-index-alloc-cache.h&quot;
<span class="lineNum">      15 </span>            : #include &quot;mail-index-private.h&quot;
<span class="lineNum">      16 </span>            : #include &quot;mail-index-view-private.h&quot;
<span class="lineNum">      17 </span>            : #include &quot;mail-index-sync-private.h&quot;
<span class="lineNum">      18 </span>            : #include &quot;mail-index-modseq.h&quot;
<span class="lineNum">      19 </span>            : #include &quot;mail-transaction-log-private.h&quot;
<span class="lineNum">      20 </span>            : #include &quot;mail-transaction-log-view-private.h&quot;
<span class="lineNum">      21 </span>            : #include &quot;mail-cache.h&quot;
<span class="lineNum">      22 </span>            : 
<span class="lineNum">      23 </span>            : #include &lt;stdio.h&gt;
<span class="lineNum">      24 </span>            : #include &lt;stddef.h&gt;
<span class="lineNum">      25 </span>            : #include &lt;time.h&gt;
<span class="lineNum">      26 </span>            : #include &lt;sys/stat.h&gt;
<span class="lineNum">      27 </span>            : 
<span class="lineNum">      28 </span>            : struct mail_index_module_register mail_index_module_register = { 0 };
<span class="lineNum">      29 </span>            : 
<span class="lineNum">      30 </span>            : struct event_category event_category_index = {
<span class="lineNum">      31 </span>            :     .name = &quot;index&quot;,
<span class="lineNum">      32 </span>            : };
<span class="lineNum">      33 </span>            : 
<span class="lineNum">      34 </span>            : static void mail_index_close_nonopened(struct mail_index *index);
<span class="lineNum">      35 </span>            : 
<span class="lineNum">      36 </span>            : static const struct mail_index_optimization_settings default_optimization_set = {
<span class="lineNum">      37 </span>            :     .index = {
<span class="lineNum">      38 </span>            :         .rewrite_min_log_bytes = 8 * 1024,
<span class="lineNum">      39 </span>            :         .rewrite_max_log_bytes = 128 * 1024,
<span class="lineNum">      40 </span>            :     },
<span class="lineNum">      41 </span>            :     .log = {
<span class="lineNum">      42 </span>            :         .min_size = 32 * 1024,
<span class="lineNum">      43 </span>            :         .max_size = 1024 * 1024,
<span class="lineNum">      44 </span>            :         .min_age_secs = 5 * 60,
<span class="lineNum">      45 </span>            :         .log2_max_age_secs = 3600 * 24 * 2,
<span class="lineNum">      46 </span>            :     },
<span class="lineNum">      47 </span>            :     .cache = {
<span class="lineNum">      48 </span>            :         .unaccessed_field_drop_secs = 3600 * 24 * 30,
<span class="lineNum">      49 </span>            :         .record_max_size = 64 * 1024,
<span class="lineNum">      50 </span>            :         .compress_min_size = 32 * 1024,
<span class="lineNum">      51 </span>            :         .compress_delete_percentage = 20,
<span class="lineNum">      52 </span>            :         .compress_continued_percentage = 200,
<span class="lineNum">      53 </span>            :         .compress_header_continue_count = 4,
<span class="lineNum">      54 </span>            :     },
<a name="55"><span class="lineNum">      55 </span>            : };</a>
<span class="lineNum">      56 </span>            : 
<span class="lineNum">      57 </span><span class="lineCov">          6 : struct mail_index *mail_index_alloc(struct event *parent_event,</span>
<span class="lineNum">      58 </span>            :                     const char *dir, const char *prefix)
<span class="lineNum">      59 </span>            : {
<span class="lineNum">      60 </span>            :     struct mail_index *index;
<span class="lineNum">      61 </span>            : 
<span class="lineNum">      62 </span><span class="lineCov">          6 :     index = i_new(struct mail_index, 1);</span>
<span class="lineNum">      63 </span><span class="lineCov">          6 :     index-&gt;dir = i_strdup(dir);</span>
<span class="lineNum">      64 </span><span class="lineCov">          6 :     index-&gt;prefix = i_strdup(prefix);</span>
<span class="lineNum">      65 </span><span class="lineCov">          6 :     index-&gt;fd = -1;</span>
<span class="lineNum">      66 </span><span class="lineCov">          6 :     index-&gt;event = event_create(parent_event);</span>
<span class="lineNum">      67 </span><span class="lineCov">          6 :     event_add_category(index-&gt;event, &amp;event_category_index);</span>
<span class="lineNum">      68 </span>            : 
<span class="lineNum">      69 </span><span class="lineCov">          6 :     index-&gt;extension_pool =</span>
<span class="lineNum">      70 </span><span class="lineCov">          6 :         pool_alloconly_create(MEMPOOL_GROWING&quot;index extension&quot;, 1024);</span>
<span class="lineNum">      71 </span><span class="lineCov">          6 :     p_array_init(&amp;index-&gt;extensions, index-&gt;extension_pool, 5);</span>
<span class="lineNum">      72 </span><span class="lineCov">          6 :     i_array_init(&amp;index-&gt;sync_lost_handlers, 4);</span>
<span class="lineNum">      73 </span><span class="lineCov">          6 :     i_array_init(&amp;index-&gt;module_contexts,</span>
<span class="lineNum">      74 </span>            :              I_MIN(5, mail_index_module_register.id));
<span class="lineNum">      75 </span>            : 
<span class="lineNum">      76 </span><span class="lineCov">          6 :     index-&gt;mode = 0600;</span>
<span class="lineNum">      77 </span><span class="lineCov">          6 :     index-&gt;gid = (gid_t)-1;</span>
<span class="lineNum">      78 </span><span class="lineCov">          6 :     index-&gt;lock_method = FILE_LOCK_METHOD_FCNTL;</span>
<span class="lineNum">      79 </span><span class="lineCov">          6 :     index-&gt;max_lock_timeout_secs = UINT_MAX;</span>
<span class="lineNum">      80 </span><span class="lineCov">          6 :     index-&gt;optimization_set = default_optimization_set;</span>
<span class="lineNum">      81 </span>            : 
<span class="lineNum">      82 </span><span class="lineCov">          6 :     index-&gt;keywords_ext_id =</span>
<span class="lineNum">      83 </span><span class="lineCov">          6 :         mail_index_ext_register(index, MAIL_INDEX_EXT_KEYWORDS,</span>
<span class="lineNum">      84 </span>            :                     128, 2, 1);
<span class="lineNum">      85 </span><span class="lineCov">          6 :     index-&gt;keywords_pool = pool_alloconly_create(&quot;keywords&quot;, 512);</span>
<span class="lineNum">      86 </span><span class="lineCov">          6 :     i_array_init(&amp;index-&gt;keywords, 16);</span>
<span class="lineNum">      87 </span><span class="lineCov">          6 :     hash_table_create(&amp;index-&gt;keywords_hash, index-&gt;keywords_pool, 0,</span>
<span class="lineNum">      88 </span>            :               strcase_hash, strcasecmp);
<span class="lineNum">      89 </span><span class="lineCov">          6 :     index-&gt;log = mail_transaction_log_alloc(index);</span>
<span class="lineNum">      90 </span><span class="lineCov">          6 :     mail_index_modseq_init(index);</span>
<span class="lineNum">      91 </span><span class="lineCov">          6 :     return index;</span>
<a name="92"><span class="lineNum">      92 </span>            : }</a>
<span class="lineNum">      93 </span>            : 
<span class="lineNum">      94 </span><span class="lineCov">          6 : void mail_index_free(struct mail_index **_index)</span>
<span class="lineNum">      95 </span>            : {
<span class="lineNum">      96 </span><span class="lineCov">          6 :     struct mail_index *index = *_index;</span>
<span class="lineNum">      97 </span>            : 
<span class="lineNum">      98 </span><span class="lineCov">          6 :     *_index = NULL;</span>
<span class="lineNum">      99 </span>            : 
<span class="lineNum">     100 </span><span class="lineCov">          6 :     i_assert(index-&gt;open_count == 0);</span>
<span class="lineNum">     101 </span>            : 
<span class="lineNum">     102 </span><span class="lineCov">          6 :     mail_transaction_log_free(&amp;index-&gt;log);</span>
<span class="lineNum">     103 </span><span class="lineCov">          6 :     hash_table_destroy(&amp;index-&gt;keywords_hash);</span>
<span class="lineNum">     104 </span><span class="lineCov">          6 :     pool_unref(&amp;index-&gt;extension_pool);</span>
<span class="lineNum">     105 </span><span class="lineCov">          6 :     pool_unref(&amp;index-&gt;keywords_pool);</span>
<span class="lineNum">     106 </span>            : 
<span class="lineNum">     107 </span><span class="lineCov">          6 :     array_free(&amp;index-&gt;sync_lost_handlers);</span>
<span class="lineNum">     108 </span><span class="lineCov">          6 :     array_free(&amp;index-&gt;keywords);</span>
<span class="lineNum">     109 </span><span class="lineCov">          6 :     array_free(&amp;index-&gt;module_contexts);</span>
<span class="lineNum">     110 </span>            : 
<span class="lineNum">     111 </span><span class="lineCov">          6 :     event_unref(&amp;index-&gt;event);</span>
<span class="lineNum">     112 </span><span class="lineCov">          6 :     i_free(index-&gt;cache_dir);</span>
<span class="lineNum">     113 </span><span class="lineCov">          6 :     i_free(index-&gt;ext_hdr_init_data);</span>
<span class="lineNum">     114 </span><span class="lineCov">          6 :     i_free(index-&gt;gid_origin);</span>
<span class="lineNum">     115 </span><span class="lineCov">          6 :     i_free(index-&gt;error);</span>
<span class="lineNum">     116 </span><span class="lineCov">          6 :     i_free(index-&gt;dir);</span>
<span class="lineNum">     117 </span><span class="lineCov">          6 :     i_free(index-&gt;prefix);</span>
<span class="lineNum">     118 </span><span class="lineCov">          6 :     i_free(index);</span>
<a name="119"><span class="lineNum">     119 </span><span class="lineCov">          6 : }</span></a>
<span class="lineNum">     120 </span>            : 
<span class="lineNum">     121 </span><span class="lineCov">         11 : void mail_index_set_cache_dir(struct mail_index *index, const char *dir)</span>
<span class="lineNum">     122 </span>            : {
<span class="lineNum">     123 </span><span class="lineCov">         11 :     i_free(index-&gt;cache_dir);</span>
<span class="lineNum">     124 </span><span class="lineCov">         11 :     index-&gt;cache_dir = i_strdup(dir);</span>
<a name="125"><span class="lineNum">     125 </span><span class="lineCov">         11 : }</span></a>
<span class="lineNum">     126 </span>            : 
<span class="lineNum">     127 </span><span class="lineCov">          1 : void mail_index_set_fsync_mode(struct mail_index *index,</span>
<span class="lineNum">     128 </span>            :                    enum fsync_mode mode,
<span class="lineNum">     129 </span>            :                    enum mail_index_fsync_mask mask)
<span class="lineNum">     130 </span>            : {
<span class="lineNum">     131 </span><span class="lineCov">          1 :     index-&gt;fsync_mode = mode;</span>
<span class="lineNum">     132 </span><span class="lineCov">          1 :     index-&gt;fsync_mask = mask;</span>
<a name="133"><span class="lineNum">     133 </span><span class="lineCov">          1 : }</span></a>
<span class="lineNum">     134 </span>            : 
<span class="lineNum">     135 </span><span class="lineCov">          1 : bool mail_index_use_existing_permissions(struct mail_index *index)</span>
<span class="lineNum">     136 </span>            : {
<span class="lineNum">     137 </span>            :     struct stat st;
<span class="lineNum">     138 </span>            : 
<span class="lineNum">     139 </span><span class="lineCov">          1 :     if (MAIL_INDEX_IS_IN_MEMORY(index))</span>
<span class="lineNum">     140 </span><span class="lineNoCov">          0 :         return FALSE;</span>
<span class="lineNum">     141 </span>            : 
<span class="lineNum">     142 </span><span class="lineCov">          1 :     if (stat(index-&gt;dir, &amp;st) &lt; 0) {</span>
<span class="lineNum">     143 </span><span class="lineNoCov">          0 :         if (errno != ENOENT)</span>
<span class="lineNum">     144 </span><span class="lineNoCov">          0 :             i_error(&quot;stat(%s) failed: %m&quot;, index-&gt;dir);</span>
<span class="lineNum">     145 </span><span class="lineNoCov">          0 :         return FALSE;</span>
<span class="lineNum">     146 </span>            :     }
<span class="lineNum">     147 </span>            : 
<span class="lineNum">     148 </span><span class="lineCov">          1 :     index-&gt;mode = st.st_mode &amp; 0666;</span>
<span class="lineNum">     149 </span><span class="lineCov">          1 :     if (S_ISDIR(st.st_mode) &amp;&amp; (st.st_mode &amp; S_ISGID) != 0) {</span>
<span class="lineNum">     150 </span>            :         /* directory's GID is used automatically for new files */
<span class="lineNum">     151 </span><span class="lineNoCov">          0 :         index-&gt;gid = (gid_t)-1;</span>
<span class="lineNum">     152 </span><span class="lineCov">          1 :     } else if ((st.st_mode &amp; 0070) &gt;&gt; 3 == (st.st_mode &amp; 0007)) {</span>
<span class="lineNum">     153 </span>            :         /* group has same permissions as world, so don't bother
<span class="lineNum">     154 </span>            :            changing it */
<span class="lineNum">     155 </span><span class="lineCov">          1 :         index-&gt;gid = (gid_t)-1;</span>
<span class="lineNum">     156 </span><span class="lineNoCov">          0 :     } else if (getegid() == st.st_gid) {</span>
<span class="lineNum">     157 </span>            :         /* using our own gid, no need to change it */
<span class="lineNum">     158 </span><span class="lineNoCov">          0 :         index-&gt;gid = (gid_t)-1;</span>
<span class="lineNum">     159 </span>            :     } else {
<span class="lineNum">     160 </span><span class="lineNoCov">          0 :         index-&gt;gid = st.st_gid;</span>
<span class="lineNum">     161 </span>            :     }
<span class="lineNum">     162 </span>            : 
<span class="lineNum">     163 </span><span class="lineCov">          1 :     i_free(index-&gt;gid_origin);</span>
<span class="lineNum">     164 </span><span class="lineCov">          1 :     if (index-&gt;gid != (gid_t)-1)</span>
<span class="lineNum">     165 </span><span class="lineNoCov">          0 :         index-&gt;gid_origin = i_strdup(&quot;preserved existing GID&quot;);</span>
<span class="lineNum">     166 </span><span class="lineCov">          1 :     return TRUE;</span>
<a name="167"><span class="lineNum">     167 </span>            : }</a>
<span class="lineNum">     168 </span>            : 
<span class="lineNum">     169 </span><span class="lineCov">         11 : void mail_index_set_permissions(struct mail_index *index,</span>
<span class="lineNum">     170 </span>            :                 mode_t mode, gid_t gid, const char *gid_origin)
<span class="lineNum">     171 </span>            : {
<span class="lineNum">     172 </span><span class="lineCov">         11 :     index-&gt;mode = mode &amp; 0666;</span>
<span class="lineNum">     173 </span><span class="lineCov">         11 :     index-&gt;gid = gid;</span>
<span class="lineNum">     174 </span>            : 
<span class="lineNum">     175 </span><span class="lineCov">         11 :     i_free(index-&gt;gid_origin);</span>
<span class="lineNum">     176 </span><span class="lineCov">         11 :     index-&gt;gid_origin = i_strdup(gid_origin);</span>
<a name="177"><span class="lineNum">     177 </span><span class="lineCov">         11 : }</span></a>
<span class="lineNum">     178 </span>            : 
<span class="lineNum">     179 </span><span class="lineCov">         12 : void mail_index_set_lock_method(struct mail_index *index,</span>
<span class="lineNum">     180 </span>            :                 enum file_lock_method lock_method,
<span class="lineNum">     181 </span>            :                 unsigned int max_timeout_secs)
<span class="lineNum">     182 </span>            : {
<span class="lineNum">     183 </span><span class="lineCov">         12 :     index-&gt;lock_method = lock_method;</span>
<span class="lineNum">     184 </span><span class="lineCov">         12 :     index-&gt;max_lock_timeout_secs = max_timeout_secs;</span>
<a name="185"><span class="lineNum">     185 </span><span class="lineCov">         12 : }</span></a>
<span class="lineNum">     186 </span>            : 
<span class="lineNum">     187 </span><span class="lineCov">         12 : void mail_index_set_optimization_settings(struct mail_index *index,</span>
<span class="lineNum">     188 </span>            :     const struct mail_index_optimization_settings *set)
<span class="lineNum">     189 </span>            : {
<span class="lineNum">     190 </span><span class="lineCov">         12 :     struct mail_index_optimization_settings *dest =</span>
<span class="lineNum">     191 </span>            :         &amp;index-&gt;optimization_set;
<span class="lineNum">     192 </span>            : 
<span class="lineNum">     193 </span>            :     /* index */
<span class="lineNum">     194 </span><span class="lineCov">         12 :     if (set-&gt;index.rewrite_min_log_bytes != 0)</span>
<span class="lineNum">     195 </span><span class="lineCov">         11 :         dest-&gt;index.rewrite_min_log_bytes = set-&gt;index.rewrite_min_log_bytes;</span>
<span class="lineNum">     196 </span><span class="lineCov">         12 :     if (set-&gt;index.rewrite_max_log_bytes != 0)</span>
<span class="lineNum">     197 </span><span class="lineCov">         11 :         dest-&gt;index.rewrite_max_log_bytes = set-&gt;index.rewrite_max_log_bytes;</span>
<span class="lineNum">     198 </span>            : 
<span class="lineNum">     199 </span>            :     /* log */
<span class="lineNum">     200 </span><span class="lineCov">         12 :     if (set-&gt;log.min_size != 0)</span>
<span class="lineNum">     201 </span><span class="lineCov">         12 :         dest-&gt;log.min_size = set-&gt;log.min_size;</span>
<span class="lineNum">     202 </span><span class="lineCov">         12 :     if (set-&gt;log.max_size != 0)</span>
<span class="lineNum">     203 </span><span class="lineCov">         12 :         dest-&gt;log.max_size = set-&gt;log.max_size;</span>
<span class="lineNum">     204 </span><span class="lineCov">         12 :     if (set-&gt;log.min_age_secs != 0)</span>
<span class="lineNum">     205 </span><span class="lineCov">         12 :         dest-&gt;log.min_age_secs = set-&gt;log.min_age_secs;</span>
<span class="lineNum">     206 </span><span class="lineCov">         12 :     if (set-&gt;log.log2_max_age_secs != 0)</span>
<span class="lineNum">     207 </span><span class="lineCov">         12 :         dest-&gt;log.log2_max_age_secs = set-&gt;log.log2_max_age_secs;</span>
<span class="lineNum">     208 </span>            : 
<span class="lineNum">     209 </span>            :     /* cache */
<span class="lineNum">     210 </span><span class="lineCov">         12 :     if (set-&gt;cache.unaccessed_field_drop_secs != 0)</span>
<span class="lineNum">     211 </span><span class="lineCov">         11 :         dest-&gt;cache.unaccessed_field_drop_secs =</span>
<span class="lineNum">     212 </span><span class="lineCov">         11 :             set-&gt;cache.unaccessed_field_drop_secs;</span>
<span class="lineNum">     213 </span><span class="lineCov">         12 :     if (set-&gt;cache.compress_min_size != 0)</span>
<span class="lineNum">     214 </span><span class="lineCov">         11 :         dest-&gt;cache.compress_min_size = set-&gt;cache.compress_min_size;</span>
<span class="lineNum">     215 </span><span class="lineCov">         12 :     if (set-&gt;cache.compress_delete_percentage != 0)</span>
<span class="lineNum">     216 </span><span class="lineCov">         11 :         dest-&gt;cache.compress_delete_percentage =</span>
<span class="lineNum">     217 </span><span class="lineCov">         11 :             set-&gt;cache.compress_delete_percentage;</span>
<span class="lineNum">     218 </span><span class="lineCov">         12 :     if (set-&gt;cache.compress_continued_percentage != 0)</span>
<span class="lineNum">     219 </span><span class="lineCov">         11 :         dest-&gt;cache.compress_continued_percentage =</span>
<span class="lineNum">     220 </span><span class="lineCov">         11 :             set-&gt;cache.compress_continued_percentage;</span>
<span class="lineNum">     221 </span><span class="lineCov">         12 :     if (set-&gt;cache.compress_header_continue_count != 0)</span>
<span class="lineNum">     222 </span><span class="lineCov">         11 :         dest-&gt;cache.compress_header_continue_count =</span>
<span class="lineNum">     223 </span><span class="lineCov">         11 :             set-&gt;cache.compress_header_continue_count;</span>
<span class="lineNum">     224 </span><span class="lineCov">         12 :     if (set-&gt;cache.record_max_size != 0)</span>
<span class="lineNum">     225 </span><span class="lineCov">         11 :         dest-&gt;cache.record_max_size = set-&gt;cache.record_max_size;</span>
<a name="226"><span class="lineNum">     226 </span><span class="lineCov">         12 : }</span></a>
<span class="lineNum">     227 </span>            : 
<span class="lineNum">     228 </span><span class="lineNoCov">          0 : void mail_index_set_ext_init_data(struct mail_index *index, uint32_t ext_id,</span>
<span class="lineNum">     229 </span>            :                   const void *data, size_t size)
<span class="lineNum">     230 </span>            : {
<span class="lineNum">     231 </span>            :     const struct mail_index_registered_ext *rext;
<span class="lineNum">     232 </span>            : 
<span class="lineNum">     233 </span><span class="lineNoCov">          0 :     i_assert(index-&gt;ext_hdr_init_data == NULL ||</span>
<span class="lineNum">     234 </span>            :          index-&gt;ext_hdr_init_id == ext_id);
<span class="lineNum">     235 </span>            : 
<span class="lineNum">     236 </span><span class="lineNoCov">          0 :     rext = array_idx(&amp;index-&gt;extensions, ext_id);</span>
<span class="lineNum">     237 </span><span class="lineNoCov">          0 :     i_assert(rext-&gt;hdr_size == size);</span>
<span class="lineNum">     238 </span>            : 
<span class="lineNum">     239 </span><span class="lineNoCov">          0 :     index-&gt;ext_hdr_init_id = ext_id;</span>
<span class="lineNum">     240 </span><span class="lineNoCov">          0 :     i_free(index-&gt;ext_hdr_init_data);</span>
<span class="lineNum">     241 </span><span class="lineNoCov">          0 :     index-&gt;ext_hdr_init_data = i_malloc(size);</span>
<span class="lineNum">     242 </span><span class="lineNoCov">          0 :     memcpy(index-&gt;ext_hdr_init_data, data, size);</span>
<a name="243"><span class="lineNum">     243 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     244 </span>            : 
<span class="lineNum">     245 </span><span class="lineCov">         92 : uint32_t mail_index_ext_register(struct mail_index *index, const char *name,</span>
<span class="lineNum">     246 </span>            :                  uint32_t default_hdr_size,
<span class="lineNum">     247 </span>            :                  uint16_t default_record_size,
<span class="lineNum">     248 </span>            :                  uint16_t default_record_align)
<span class="lineNum">     249 </span>            : {
<span class="lineNum">     250 </span>            :     struct mail_index_registered_ext rext;
<span class="lineNum">     251 </span>            :     uint32_t ext_id;
<span class="lineNum">     252 </span>            : 
<span class="lineNum">     253 </span><span class="lineCov">         92 :     if (*name == '\0' || strcmp(name, str_sanitize(name, -1)) != 0)</span>
<span class="lineNum">     254 </span><span class="lineNoCov">          0 :         i_panic(&quot;mail_index_ext_register(%s): Invalid name&quot;, name);</span>
<span class="lineNum">     255 </span>            : 
<span class="lineNum">     256 </span><span class="lineCov">         92 :     if (default_record_size != 0 &amp;&amp; default_record_align == 0) {</span>
<span class="lineNum">     257 </span><span class="lineNoCov">          0 :         i_panic(&quot;mail_index_ext_register(%s): &quot;</span>
<span class="lineNum">     258 </span>            :             &quot;Invalid record alignment&quot;, name);
<span class="lineNum">     259 </span>            :     }
<span class="lineNum">     260 </span>            : 
<span class="lineNum">     261 </span><span class="lineCov">         92 :     if (mail_index_ext_lookup(index, name, &amp;ext_id))</span>
<span class="lineNum">     262 </span><span class="lineCov">         63 :         return ext_id;</span>
<span class="lineNum">     263 </span>            : 
<span class="lineNum">     264 </span><span class="lineCov">         29 :     i_zero(&amp;rext);</span>
<span class="lineNum">     265 </span><span class="lineCov">         29 :     rext.name = p_strdup(index-&gt;extension_pool, name);</span>
<span class="lineNum">     266 </span><span class="lineCov">         29 :     rext.index_idx = array_count(&amp;index-&gt;extensions);</span>
<span class="lineNum">     267 </span><span class="lineCov">         29 :     rext.hdr_size = default_hdr_size;</span>
<span class="lineNum">     268 </span><span class="lineCov">         29 :     rext.record_size = default_record_size;</span>
<span class="lineNum">     269 </span><span class="lineCov">         29 :     rext.record_align = default_record_align;</span>
<span class="lineNum">     270 </span>            : 
<span class="lineNum">     271 </span><span class="lineCov">         29 :     array_append(&amp;index-&gt;extensions, &amp;rext, 1);</span>
<span class="lineNum">     272 </span><span class="lineCov">         29 :     return rext.index_idx;</span>
<a name="273"><span class="lineNum">     273 </span>            : }</a>
<span class="lineNum">     274 </span>            : 
<span class="lineNum">     275 </span><span class="lineNoCov">          0 : void mail_index_ext_register_resize_defaults(struct mail_index *index,</span>
<span class="lineNum">     276 </span>            :                          uint32_t ext_id,
<span class="lineNum">     277 </span>            :                          uint32_t default_hdr_size,
<span class="lineNum">     278 </span>            :                          uint16_t default_record_size,
<span class="lineNum">     279 </span>            :                          uint16_t default_record_align)
<span class="lineNum">     280 </span>            : {
<span class="lineNum">     281 </span>            :     struct mail_index_registered_ext *rext;
<span class="lineNum">     282 </span>            : 
<span class="lineNum">     283 </span><span class="lineNoCov">          0 :     rext = array_idx_modifiable(&amp;index-&gt;extensions, ext_id);</span>
<span class="lineNum">     284 </span><span class="lineNoCov">          0 :     rext-&gt;hdr_size = default_hdr_size;</span>
<span class="lineNum">     285 </span><span class="lineNoCov">          0 :     rext-&gt;record_size = default_record_size;</span>
<span class="lineNum">     286 </span><span class="lineNoCov">          0 :     rext-&gt;record_align = default_record_align;</span>
<a name="287"><span class="lineNum">     287 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     288 </span>            : 
<span class="lineNum">     289 </span><span class="lineCov">         92 : bool mail_index_ext_lookup(struct mail_index *index, const char *name,</span>
<span class="lineNum">     290 </span>            :                uint32_t *ext_id_r)
<span class="lineNum">     291 </span>            : {
<span class="lineNum">     292 </span>            :         const struct mail_index_registered_ext *extensions;
<span class="lineNum">     293 </span>            :     unsigned int i, count;
<span class="lineNum">     294 </span>            : 
<span class="lineNum">     295 </span><span class="lineCov">         92 :     extensions = array_get(&amp;index-&gt;extensions, &amp;count);</span>
<span class="lineNum">     296 </span><span class="lineCov">        511 :     for (i = 0; i &lt; count; i++) {</span>
<span class="lineNum">     297 </span><span class="lineCov">        482 :         if (strcmp(extensions[i].name, name) == 0) {</span>
<span class="lineNum">     298 </span><span class="lineCov">         63 :             *ext_id_r = i;</span>
<span class="lineNum">     299 </span><span class="lineCov">         63 :             return TRUE;</span>
<span class="lineNum">     300 </span>            :         }
<span class="lineNum">     301 </span>            :     }
<span class="lineNum">     302 </span>            : 
<span class="lineNum">     303 </span><span class="lineCov">         29 :     *ext_id_r = (uint32_t)-1;</span>
<span class="lineNum">     304 </span><span class="lineCov">         29 :     return FALSE;</span>
<a name="305"><span class="lineNum">     305 </span>            : }</a>
<span class="lineNum">     306 </span>            : 
<span class="lineNum">     307 </span><span class="lineCov">          5 : void mail_index_register_expunge_handler(struct mail_index *index,</span>
<span class="lineNum">     308 </span>            :                      uint32_t ext_id, bool call_always,
<span class="lineNum">     309 </span>            :                      mail_index_expunge_handler_t *cb,
<span class="lineNum">     310 </span>            :                      void *context)
<span class="lineNum">     311 </span>            : {
<span class="lineNum">     312 </span>            :     struct mail_index_registered_ext *rext;
<span class="lineNum">     313 </span>            : 
<span class="lineNum">     314 </span><span class="lineCov">          5 :     rext = array_idx_modifiable(&amp;index-&gt;extensions, ext_id);</span>
<span class="lineNum">     315 </span><span class="lineCov">          5 :     i_assert(rext-&gt;expunge_handler == NULL || rext-&gt;expunge_handler == cb);</span>
<span class="lineNum">     316 </span>            : 
<span class="lineNum">     317 </span><span class="lineCov">          5 :     rext-&gt;expunge_handler = cb;</span>
<span class="lineNum">     318 </span><span class="lineCov">          5 :     rext-&gt;expunge_context = context;</span>
<span class="lineNum">     319 </span><span class="lineCov">          5 :     rext-&gt;expunge_handler_call_always = call_always;</span>
<a name="320"><span class="lineNum">     320 </span><span class="lineCov">          5 : }</span></a>
<span class="lineNum">     321 </span>            : 
<span class="lineNum">     322 </span><span class="lineCov">          5 : void mail_index_unregister_expunge_handler(struct mail_index *index,</span>
<span class="lineNum">     323 </span>            :                        uint32_t ext_id)
<span class="lineNum">     324 </span>            : {
<span class="lineNum">     325 </span>            :     struct mail_index_registered_ext *rext;
<span class="lineNum">     326 </span>            : 
<span class="lineNum">     327 </span><span class="lineCov">          5 :     rext = array_idx_modifiable(&amp;index-&gt;extensions, ext_id);</span>
<span class="lineNum">     328 </span><span class="lineCov">          5 :     i_assert(rext-&gt;expunge_handler != NULL);</span>
<span class="lineNum">     329 </span>            : 
<span class="lineNum">     330 </span><span class="lineCov">          5 :     rext-&gt;expunge_handler = NULL;</span>
<a name="331"><span class="lineNum">     331 </span><span class="lineCov">          5 : }</span></a>
<span class="lineNum">     332 </span>            : 
<span class="lineNum">     333 </span><span class="lineNoCov">          0 : void mail_index_register_sync_handler(struct mail_index *index, uint32_t ext_id,</span>
<span class="lineNum">     334 </span>            :                       mail_index_sync_handler_t *cb,
<span class="lineNum">     335 </span>            :                       enum mail_index_sync_handler_type type)
<span class="lineNum">     336 </span>            : {
<span class="lineNum">     337 </span>            :     struct mail_index_registered_ext *rext;
<span class="lineNum">     338 </span>            : 
<span class="lineNum">     339 </span><span class="lineNoCov">          0 :     rext = array_idx_modifiable(&amp;index-&gt;extensions, ext_id);</span>
<span class="lineNum">     340 </span><span class="lineNoCov">          0 :     i_assert(rext-&gt;sync_handler.callback == NULL);</span>
<span class="lineNum">     341 </span>            : 
<span class="lineNum">     342 </span><span class="lineNoCov">          0 :     rext-&gt;sync_handler.callback = cb;</span>
<span class="lineNum">     343 </span><span class="lineNoCov">          0 :     rext-&gt;sync_handler.type = type;</span>
<a name="344"><span class="lineNum">     344 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     345 </span>            : 
<span class="lineNum">     346 </span><span class="lineNoCov">          0 : void mail_index_unregister_sync_handler(struct mail_index *index,</span>
<span class="lineNum">     347 </span>            :                     uint32_t ext_id)
<span class="lineNum">     348 </span>            : {
<span class="lineNum">     349 </span>            :     struct mail_index_registered_ext *rext;
<span class="lineNum">     350 </span>            : 
<span class="lineNum">     351 </span><span class="lineNoCov">          0 :     rext = array_idx_modifiable(&amp;index-&gt;extensions, ext_id);</span>
<span class="lineNum">     352 </span><span class="lineNoCov">          0 :     i_assert(rext-&gt;sync_handler.callback != NULL);</span>
<span class="lineNum">     353 </span>            : 
<span class="lineNum">     354 </span><span class="lineNoCov">          0 :     rext-&gt;sync_handler.callback = NULL;</span>
<span class="lineNum">     355 </span><span class="lineNoCov">          0 :     rext-&gt;sync_handler.type = 0;</span>
<a name="356"><span class="lineNum">     356 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     357 </span>            : 
<span class="lineNum">     358 </span><span class="lineNoCov">          0 : void mail_index_register_sync_lost_handler(struct mail_index *index,</span>
<span class="lineNum">     359 </span>            :                        mail_index_sync_lost_handler_t *cb)
<span class="lineNum">     360 </span>            : {
<span class="lineNum">     361 </span><span class="lineNoCov">          0 :     array_append(&amp;index-&gt;sync_lost_handlers, &amp;cb, 1);</span>
<a name="362"><span class="lineNum">     362 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     363 </span>            : 
<span class="lineNum">     364 </span><span class="lineNoCov">          0 : void mail_index_unregister_sync_lost_handler(struct mail_index *index,</span>
<span class="lineNum">     365 </span>            :                          mail_index_sync_lost_handler_t *cb)
<span class="lineNum">     366 </span>            : {
<span class="lineNum">     367 </span>            :     mail_index_sync_lost_handler_t *const *handlers;
<span class="lineNum">     368 </span>            :     unsigned int i, count;
<span class="lineNum">     369 </span>            : 
<span class="lineNum">     370 </span><span class="lineNoCov">          0 :     handlers = array_get(&amp;index-&gt;sync_lost_handlers, &amp;count);</span>
<span class="lineNum">     371 </span><span class="lineNoCov">          0 :     for (i = 0; i &lt; count; i++) {</span>
<span class="lineNum">     372 </span><span class="lineNoCov">          0 :         if (handlers[i] == cb) {</span>
<span class="lineNum">     373 </span><span class="lineNoCov">          0 :             array_delete(&amp;index-&gt;sync_lost_handlers, i, 1);</span>
<span class="lineNum">     374 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">     375 </span>            :         }
<span class="lineNum">     376 </span>            :     }
<a name="377"><span class="lineNum">     377 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     378 </span>            : 
<span class="lineNum">     379 </span><span class="lineCov">         40 : bool mail_index_keyword_lookup(struct mail_index *index,</span>
<span class="lineNum">     380 </span>            :                    const char *keyword, unsigned int *idx_r)
<span class="lineNum">     381 </span>            : {
<span class="lineNum">     382 </span>            :     char *key;
<span class="lineNum">     383 </span>            :     void *value;
<span class="lineNum">     384 </span>            : 
<span class="lineNum">     385 </span>            :     /* keywords_hash keeps a name =&gt; index mapping of keywords.
<span class="lineNum">     386 </span>            :        Keywords are never removed from it, so the index values are valid
<span class="lineNum">     387 </span>            :        for the lifetime of the mail_index. */
<span class="lineNum">     388 </span><span class="lineCov">         40 :     if (hash_table_lookup_full(index-&gt;keywords_hash, keyword,</span>
<span class="lineNum">     389 </span>            :                    &amp;key, &amp;value)) {
<span class="lineNum">     390 </span><span class="lineCov">         36 :         *idx_r = POINTER_CAST_TO(value, unsigned int);</span>
<span class="lineNum">     391 </span><span class="lineCov">         36 :         return TRUE;</span>
<span class="lineNum">     392 </span>            :     }
<span class="lineNum">     393 </span>            : 
<span class="lineNum">     394 </span><span class="lineCov">          4 :     *idx_r = UINT_MAX;</span>
<span class="lineNum">     395 </span><span class="lineCov">          4 :     return FALSE;</span>
<a name="396"><span class="lineNum">     396 </span>            : }</a>
<span class="lineNum">     397 </span>            : 
<span class="lineNum">     398 </span><span class="lineCov">         20 : void mail_index_keyword_lookup_or_create(struct mail_index *index,</span>
<span class="lineNum">     399 </span>            :                      const char *keyword,
<span class="lineNum">     400 </span>            :                      unsigned int *idx_r)
<span class="lineNum">     401 </span>            : {
<span class="lineNum">     402 </span>            :     char *keyword_dup;
<span class="lineNum">     403 </span>            : 
<span class="lineNum">     404 </span><span class="lineCov">         20 :     i_assert(*keyword != '\0');</span>
<span class="lineNum">     405 </span>            : 
<span class="lineNum">     406 </span><span class="lineCov">         20 :     if (mail_index_keyword_lookup(index, keyword, idx_r))</span>
<span class="lineNum">     407 </span><span class="lineCov">         38 :         return;</span>
<span class="lineNum">     408 </span>            : 
<span class="lineNum">     409 </span><span class="lineCov">          2 :     keyword = keyword_dup = p_strdup(index-&gt;keywords_pool, keyword);</span>
<span class="lineNum">     410 </span><span class="lineCov">          2 :     *idx_r = array_count(&amp;index-&gt;keywords);</span>
<span class="lineNum">     411 </span>            : 
<span class="lineNum">     412 </span><span class="lineCov">          2 :     hash_table_insert(index-&gt;keywords_hash, keyword_dup,</span>
<span class="lineNum">     413 </span>            :               POINTER_CAST(*idx_r));
<span class="lineNum">     414 </span><span class="lineCov">          2 :     array_append(&amp;index-&gt;keywords, &amp;keyword, 1);</span>
<span class="lineNum">     415 </span>            : 
<span class="lineNum">     416 </span>            :     /* keep the array NULL-terminated, but the NULL itself invisible */
<span class="lineNum">     417 </span><span class="lineCov">          2 :     array_append_zero(&amp;index-&gt;keywords);</span>
<span class="lineNum">     418 </span><span class="lineCov">          2 :     array_delete(&amp;index-&gt;keywords, array_count(&amp;index-&gt;keywords)-1, 1);</span>
<a name="419"><span class="lineNum">     419 </span>            : }</a>
<span class="lineNum">     420 </span>            : 
<span class="lineNum">     421 </span><span class="lineCov">         24 : const ARRAY_TYPE(keywords) *mail_index_get_keywords(struct mail_index *index)</span>
<span class="lineNum">     422 </span>            : {
<span class="lineNum">     423 </span><span class="lineCov">         24 :     return &amp;index-&gt;keywords;</span>
<span class="lineNum">     424 </span>            : }
<a name="425"><span class="lineNum">     425 </span>            : </a>
<span class="lineNum">     426 </span>            : struct mail_keywords *
<span class="lineNum">     427 </span><span class="lineCov">         20 : mail_index_keywords_create(struct mail_index *index,</span>
<span class="lineNum">     428 </span>            :                const char *const keywords[])
<span class="lineNum">     429 </span>            : {
<span class="lineNum">     430 </span>            :     struct mail_keywords *k;
<span class="lineNum">     431 </span>            :     unsigned int src, dest, i, count;
<span class="lineNum">     432 </span>            : 
<span class="lineNum">     433 </span><span class="lineCov">         20 :     count = str_array_length(keywords);</span>
<span class="lineNum">     434 </span><span class="lineCov">         20 :     if (count == 0) {</span>
<span class="lineNum">     435 </span><span class="lineNoCov">          0 :         k = i_new(struct mail_keywords, 1);</span>
<span class="lineNum">     436 </span><span class="lineNoCov">          0 :         k-&gt;index = index;</span>
<span class="lineNum">     437 </span><span class="lineNoCov">          0 :         k-&gt;refcount = 1;</span>
<span class="lineNum">     438 </span><span class="lineNoCov">          0 :         return k;</span>
<span class="lineNum">     439 </span>            :     }
<span class="lineNum">     440 </span>            : 
<span class="lineNum">     441 </span>            :     /* @UNSAFE */
<span class="lineNum">     442 </span><span class="lineCov">         20 :     k = i_malloc(MALLOC_ADD(sizeof(struct mail_keywords),</span>
<span class="lineNum">     443 </span>            :                 MALLOC_MULTIPLY(sizeof(k-&gt;idx[0]), count)));
<span class="lineNum">     444 </span><span class="lineCov">         20 :     k-&gt;index = index;</span>
<span class="lineNum">     445 </span><span class="lineCov">         20 :     k-&gt;refcount = 1;</span>
<span class="lineNum">     446 </span>            : 
<span class="lineNum">     447 </span>            :     /* look up the keywords from index. they're never removed from there
<span class="lineNum">     448 </span>            :        so we can permanently store indexes to them. */
<span class="lineNum">     449 </span><span class="lineCov">         40 :     for (src = dest = 0; src &lt; count; src++) {</span>
<span class="lineNum">     450 </span><span class="lineCov">         20 :         mail_index_keyword_lookup_or_create(index, keywords[src],</span>
<span class="lineNum">     451 </span>            :                             &amp;k-&gt;idx[dest]);
<span class="lineNum">     452 </span>            :         /* ignore if this is a duplicate */
<span class="lineNum">     453 </span><span class="lineCov">         20 :         for (i = 0; i &lt; src; i++) {</span>
<span class="lineNum">     454 </span><span class="lineNoCov">          0 :             if (k-&gt;idx[i] == k-&gt;idx[dest])</span>
<span class="lineNum">     455 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     456 </span>            :         }
<span class="lineNum">     457 </span><span class="lineCov">         20 :         if (i == src)</span>
<span class="lineNum">     458 </span><span class="lineCov">         20 :             dest++;</span>
<span class="lineNum">     459 </span>            :     }
<span class="lineNum">     460 </span><span class="lineCov">         20 :     k-&gt;count = dest;</span>
<span class="lineNum">     461 </span><span class="lineCov">         20 :     return k;</span>
<span class="lineNum">     462 </span>            : }
<a name="463"><span class="lineNum">     463 </span>            : </a>
<span class="lineNum">     464 </span>            : struct mail_keywords *
<span class="lineNum">     465 </span><span class="lineNoCov">          0 : mail_index_keywords_create_from_indexes(struct mail_index *index,</span>
<span class="lineNum">     466 </span>            :                     const ARRAY_TYPE(keyword_indexes)
<span class="lineNum">     467 </span>            :                         *keyword_indexes)
<span class="lineNum">     468 </span>            : {
<span class="lineNum">     469 </span>            :     struct mail_keywords *k;
<span class="lineNum">     470 </span>            :     const unsigned int *indexes;
<span class="lineNum">     471 </span>            :     unsigned int src, dest, i, count;
<span class="lineNum">     472 </span>            : 
<span class="lineNum">     473 </span><span class="lineNoCov">          0 :     indexes = array_get(keyword_indexes, &amp;count);</span>
<span class="lineNum">     474 </span><span class="lineNoCov">          0 :     if (count == 0) {</span>
<span class="lineNum">     475 </span><span class="lineNoCov">          0 :         k = i_new(struct mail_keywords, 1);</span>
<span class="lineNum">     476 </span><span class="lineNoCov">          0 :         k-&gt;index = index;</span>
<span class="lineNum">     477 </span><span class="lineNoCov">          0 :         k-&gt;refcount = 1;</span>
<span class="lineNum">     478 </span><span class="lineNoCov">          0 :         return k;</span>
<span class="lineNum">     479 </span>            :     }
<span class="lineNum">     480 </span>            : 
<span class="lineNum">     481 </span>            :     /* @UNSAFE */
<span class="lineNum">     482 </span><span class="lineNoCov">          0 :     k = i_malloc(MALLOC_ADD(sizeof(struct mail_keywords),</span>
<span class="lineNum">     483 </span>            :                 MALLOC_MULTIPLY(sizeof(k-&gt;idx[0]), count)));
<span class="lineNum">     484 </span><span class="lineNoCov">          0 :     k-&gt;index = index;</span>
<span class="lineNum">     485 </span><span class="lineNoCov">          0 :     k-&gt;refcount = 1;</span>
<span class="lineNum">     486 </span>            : 
<span class="lineNum">     487 </span>            :     /* copy but skip duplicates */
<span class="lineNum">     488 </span><span class="lineNoCov">          0 :     for (src = dest = 0; src &lt; count; src++) {</span>
<span class="lineNum">     489 </span><span class="lineNoCov">          0 :         for (i = 0; i &lt; src; i++) {</span>
<span class="lineNum">     490 </span><span class="lineNoCov">          0 :             if (k-&gt;idx[i] == indexes[src])</span>
<span class="lineNum">     491 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     492 </span>            :         }
<span class="lineNum">     493 </span><span class="lineNoCov">          0 :         if (i == src)</span>
<span class="lineNum">     494 </span><span class="lineNoCov">          0 :             k-&gt;idx[dest++] = indexes[src];</span>
<span class="lineNum">     495 </span>            :     }
<span class="lineNum">     496 </span><span class="lineNoCov">          0 :     k-&gt;count = dest;</span>
<span class="lineNum">     497 </span><span class="lineNoCov">          0 :     return k;</span>
<a name="498"><span class="lineNum">     498 </span>            : }</a>
<span class="lineNum">     499 </span>            : 
<span class="lineNum">     500 </span><span class="lineNoCov">          0 : void mail_index_keywords_ref(struct mail_keywords *keywords)</span>
<span class="lineNum">     501 </span>            : {
<span class="lineNum">     502 </span><span class="lineNoCov">          0 :     keywords-&gt;refcount++;</span>
<a name="503"><span class="lineNum">     503 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     504 </span>            : 
<span class="lineNum">     505 </span><span class="lineCov">         20 : void mail_index_keywords_unref(struct mail_keywords **_keywords)</span>
<span class="lineNum">     506 </span>            : {
<span class="lineNum">     507 </span><span class="lineCov">         20 :     struct mail_keywords *keywords = *_keywords;</span>
<span class="lineNum">     508 </span>            : 
<span class="lineNum">     509 </span><span class="lineCov">         20 :     i_assert(keywords-&gt;refcount &gt; 0);</span>
<span class="lineNum">     510 </span>            : 
<span class="lineNum">     511 </span><span class="lineCov">         20 :     *_keywords = NULL;</span>
<span class="lineNum">     512 </span><span class="lineCov">         20 :     if (--keywords-&gt;refcount == 0)</span>
<span class="lineNum">     513 </span><span class="lineCov">         20 :         i_free(keywords);</span>
<a name="514"><span class="lineNum">     514 </span><span class="lineCov">         20 : }</span></a>
<span class="lineNum">     515 </span>            : 
<span class="lineNum">     516 </span><span class="lineCov">          3 : int mail_index_try_open_only(struct mail_index *index)</span>
<span class="lineNum">     517 </span>            : {
<span class="lineNum">     518 </span><span class="lineCov">          3 :     i_assert(index-&gt;fd == -1);</span>
<span class="lineNum">     519 </span><span class="lineCov">          3 :     i_assert(!MAIL_INDEX_IS_IN_MEMORY(index));</span>
<span class="lineNum">     520 </span>            : 
<span class="lineNum">     521 </span>            :         /* Note that our caller must close index-&gt;fd by itself. */
<span class="lineNum">     522 </span><span class="lineCov">          3 :     if (index-&gt;readonly)</span>
<span class="lineNum">     523 </span><span class="lineNoCov">          0 :         errno = EACCES;</span>
<span class="lineNum">     524 </span>            :     else {
<span class="lineNum">     525 </span><span class="lineCov">          3 :         index-&gt;fd = nfs_safe_open(index-&gt;filepath, O_RDWR);</span>
<span class="lineNum">     526 </span><span class="lineCov">          3 :         index-&gt;readonly = FALSE;</span>
<span class="lineNum">     527 </span>            :     }
<span class="lineNum">     528 </span>            : 
<span class="lineNum">     529 </span><span class="lineCov">          3 :     if (index-&gt;fd == -1 &amp;&amp; errno == EACCES) {</span>
<span class="lineNum">     530 </span><span class="lineNoCov">          0 :         index-&gt;fd = open(index-&gt;filepath, O_RDONLY);</span>
<span class="lineNum">     531 </span><span class="lineNoCov">          0 :         index-&gt;readonly = TRUE;</span>
<span class="lineNum">     532 </span>            :     }
<span class="lineNum">     533 </span>            : 
<span class="lineNum">     534 </span><span class="lineCov">          3 :     if (index-&gt;fd == -1) {</span>
<span class="lineNum">     535 </span><span class="lineCov">          3 :         if (errno != ENOENT) {</span>
<span class="lineNum">     536 </span><span class="lineNoCov">          0 :             mail_index_set_syscall_error(index, &quot;open()&quot;);</span>
<span class="lineNum">     537 </span><span class="lineNoCov">          0 :             return -1;</span>
<span class="lineNum">     538 </span>            :         }
<span class="lineNum">     539 </span>            : 
<span class="lineNum">     540 </span>            :         /* have to create it */
<span class="lineNum">     541 </span><span class="lineCov">          3 :         return 0;</span>
<span class="lineNum">     542 </span>            :     }
<span class="lineNum">     543 </span><span class="lineNoCov">          0 :     return 1;</span>
<span class="lineNum">     544 </span>            : }
<a name="545"><span class="lineNum">     545 </span>            : </a>
<span class="lineNum">     546 </span>            : static int
<span class="lineNum">     547 </span><span class="lineCov">          7 : mail_index_try_open(struct mail_index *index)</span>
<span class="lineNum">     548 </span>            : {
<span class="lineNum">     549 </span>            :     int ret;
<span class="lineNum">     550 </span>            : 
<span class="lineNum">     551 </span><span class="lineCov">          7 :         i_assert(index-&gt;fd == -1);</span>
<span class="lineNum">     552 </span>            : 
<span class="lineNum">     553 </span><span class="lineCov">          7 :     if (MAIL_INDEX_IS_IN_MEMORY(index))</span>
<span class="lineNum">     554 </span><span class="lineCov">          4 :         return 0;</span>
<span class="lineNum">     555 </span>            : 
<span class="lineNum">     556 </span><span class="lineCov">          3 :     ret = mail_index_map(index, MAIL_INDEX_SYNC_HANDLER_HEAD);</span>
<span class="lineNum">     557 </span><span class="lineCov">          3 :     if (ret == 0) {</span>
<span class="lineNum">     558 </span>            :         /* it's corrupted - recreate it */
<span class="lineNum">     559 </span><span class="lineNoCov">          0 :         if (index-&gt;fd != -1) {</span>
<span class="lineNum">     560 </span><span class="lineNoCov">          0 :             if (close(index-&gt;fd) &lt; 0)</span>
<span class="lineNum">     561 </span><span class="lineNoCov">          0 :                 mail_index_set_syscall_error(index, &quot;close()&quot;);</span>
<span class="lineNum">     562 </span><span class="lineNoCov">          0 :             index-&gt;fd = -1;</span>
<span class="lineNum">     563 </span>            :         }
<span class="lineNum">     564 </span>            :     }
<span class="lineNum">     565 </span><span class="lineCov">          3 :     return ret;</span>
<a name="566"><span class="lineNum">     566 </span>            : }</a>
<span class="lineNum">     567 </span>            : 
<span class="lineNum">     568 </span><span class="lineNoCov">          0 : int mail_index_create_tmp_file(struct mail_index *index,</span>
<span class="lineNum">     569 </span>            :                    const char *path_prefix, const char **path_r)
<span class="lineNum">     570 </span>            : {
<span class="lineNum">     571 </span>            :         mode_t old_mask;
<span class="lineNum">     572 </span>            :     const char *path;
<span class="lineNum">     573 </span>            :     int fd;
<span class="lineNum">     574 </span>            : 
<span class="lineNum">     575 </span><span class="lineNoCov">          0 :     i_assert(!MAIL_INDEX_IS_IN_MEMORY(index));</span>
<span class="lineNum">     576 </span>            : 
<span class="lineNum">     577 </span><span class="lineNoCov">          0 :     path = *path_r = t_strconcat(path_prefix, &quot;.tmp&quot;, NULL);</span>
<span class="lineNum">     578 </span><span class="lineNoCov">          0 :     old_mask = umask(0);</span>
<span class="lineNum">     579 </span><span class="lineNoCov">          0 :     fd = open(path, O_RDWR|O_CREAT|O_EXCL, index-&gt;mode);</span>
<span class="lineNum">     580 </span><span class="lineNoCov">          0 :     umask(old_mask);</span>
<span class="lineNum">     581 </span><span class="lineNoCov">          0 :     if (fd == -1 &amp;&amp; errno == EEXIST) {</span>
<span class="lineNum">     582 </span>            :         /* stale temp file. unlink and recreate rather than overwriting,
<span class="lineNum">     583 </span>            :            just to make sure locking problems won't cause corruption */
<span class="lineNum">     584 </span><span class="lineNoCov">          0 :         if (i_unlink(path) &lt; 0)</span>
<span class="lineNum">     585 </span><span class="lineNoCov">          0 :             return -1;</span>
<span class="lineNum">     586 </span><span class="lineNoCov">          0 :         old_mask = umask(0);</span>
<span class="lineNum">     587 </span><span class="lineNoCov">          0 :         fd = open(path, O_RDWR|O_CREAT|O_EXCL, index-&gt;mode);</span>
<span class="lineNum">     588 </span><span class="lineNoCov">          0 :         umask(old_mask);</span>
<span class="lineNum">     589 </span>            :     }
<span class="lineNum">     590 </span><span class="lineNoCov">          0 :     if (fd == -1) {</span>
<span class="lineNum">     591 </span><span class="lineNoCov">          0 :         mail_index_file_set_syscall_error(index, path, &quot;creat()&quot;);</span>
<span class="lineNum">     592 </span><span class="lineNoCov">          0 :         return -1;</span>
<span class="lineNum">     593 </span>            :     }
<span class="lineNum">     594 </span>            : 
<span class="lineNum">     595 </span><span class="lineNoCov">          0 :     mail_index_fchown(index, fd, path);</span>
<span class="lineNum">     596 </span><span class="lineNoCov">          0 :     return fd;</span>
<a name="597"><span class="lineNum">     597 </span>            : }</a>
<span class="lineNum">     598 </span>            : 
<span class="lineNum">     599 </span><span class="lineCov">          5 : static const char *mail_index_get_cache_path(struct mail_index *index)</span>
<span class="lineNum">     600 </span>            : {
<span class="lineNum">     601 </span>            :     const char *dir;
<span class="lineNum">     602 </span>            : 
<span class="lineNum">     603 </span><span class="lineCov">          5 :     if (index-&gt;cache_dir != NULL)</span>
<span class="lineNum">     604 </span><span class="lineCov">          1 :         dir = index-&gt;cache_dir;</span>
<span class="lineNum">     605 </span><span class="lineCov">          4 :     else if (index-&gt;dir != NULL)</span>
<span class="lineNum">     606 </span><span class="lineCov">          2 :         dir = index-&gt;dir;</span>
<span class="lineNum">     607 </span>            :     else
<span class="lineNum">     608 </span><span class="lineCov">          2 :         return NULL;</span>
<span class="lineNum">     609 </span><span class="lineCov">          3 :     return t_strconcat(dir, &quot;/&quot;, index-&gt;prefix,</span>
<span class="lineNum">     610 </span>            :                MAIL_CACHE_FILE_SUFFIX, NULL);
<a name="611"><span class="lineNum">     611 </span>            : }</a>
<span class="lineNum">     612 </span>            : 
<span class="lineNum">     613 </span><span class="lineCov">          5 : static int mail_index_open_files(struct mail_index *index,</span>
<span class="lineNum">     614 </span>            :                  enum mail_index_open_flags flags)
<span class="lineNum">     615 </span>            : {
<span class="lineNum">     616 </span>            :     int ret;
<span class="lineNum">     617 </span>            : 
<span class="lineNum">     618 </span><span class="lineCov">          5 :     ret = mail_transaction_log_open(index-&gt;log);</span>
<span class="lineNum">     619 </span><span class="lineCov">          5 :     if (ret == 0) {</span>
<span class="lineNum">     620 </span><span class="lineCov">          5 :         if ((flags &amp; MAIL_INDEX_OPEN_FLAG_CREATE) == 0)</span>
<span class="lineNum">     621 </span><span class="lineNoCov">          0 :             return 0;</span>
<span class="lineNum">     622 </span>            : 
<span class="lineNum">     623 </span>            :         /* if dovecot.index exists, read it first so that we can get
<span class="lineNum">     624 </span>            :            the correct indexid and log sequence */
<span class="lineNum">     625 </span><span class="lineCov">          5 :         (void)mail_index_try_open(index);</span>
<span class="lineNum">     626 </span>            : 
<span class="lineNum">     627 </span><span class="lineCov">          5 :         if (index-&gt;indexid == 0) {</span>
<span class="lineNum">     628 </span>            :             /* Create a new indexid for us. If we're opening index
<span class="lineNum">     629 </span>            :                into memory, index-&gt;map doesn't exist yet. */
<span class="lineNum">     630 </span><span class="lineCov">          5 :             index-&gt;indexid = ioloop_time;</span>
<span class="lineNum">     631 </span><span class="lineCov">          5 :             index-&gt;initial_create = TRUE;</span>
<span class="lineNum">     632 </span><span class="lineCov">          5 :             if (index-&gt;map != NULL)</span>
<span class="lineNum">     633 </span><span class="lineCov">          3 :                 index-&gt;map-&gt;hdr.indexid = index-&gt;indexid;</span>
<span class="lineNum">     634 </span>            :         }
<span class="lineNum">     635 </span>            : 
<span class="lineNum">     636 </span><span class="lineCov">          5 :         ret = mail_transaction_log_create(index-&gt;log, FALSE);</span>
<span class="lineNum">     637 </span><span class="lineCov">          5 :         if (index-&gt;map != NULL) {</span>
<span class="lineNum">     638 </span>            :             /* log creation could have changed it if someone else
<span class="lineNum">     639 </span>            :                just created it. */
<span class="lineNum">     640 </span><span class="lineCov">          3 :             index-&gt;map-&gt;hdr.indexid = index-&gt;indexid;</span>
<span class="lineNum">     641 </span>            :         }
<span class="lineNum">     642 </span><span class="lineCov">          5 :         index-&gt;initial_create = FALSE;</span>
<span class="lineNum">     643 </span>            :     }
<span class="lineNum">     644 </span><span class="lineCov">          5 :     if (ret &gt;= 0) {</span>
<span class="lineNum">     645 </span><span class="lineCov">          5 :         ret = index-&gt;map != NULL ? 1 : mail_index_try_open(index);</span>
<span class="lineNum">     646 </span><span class="lineCov">          5 :         if (ret == 0) {</span>
<span class="lineNum">     647 </span>            :             /* corrupted */
<span class="lineNum">     648 </span><span class="lineCov">          2 :             mail_transaction_log_close(index-&gt;log);</span>
<span class="lineNum">     649 </span><span class="lineCov">          2 :             ret = mail_transaction_log_create(index-&gt;log, TRUE);</span>
<span class="lineNum">     650 </span><span class="lineCov">          2 :             if (ret == 0) {</span>
<span class="lineNum">     651 </span><span class="lineCov">          2 :                 if (index-&gt;map != NULL)</span>
<span class="lineNum">     652 </span><span class="lineNoCov">          0 :                     mail_index_unmap(&amp;index-&gt;map);</span>
<span class="lineNum">     653 </span><span class="lineCov">          2 :                 index-&gt;map = mail_index_map_alloc(index);</span>
<span class="lineNum">     654 </span>            :             }
<span class="lineNum">     655 </span>            :         }
<span class="lineNum">     656 </span>            :     }
<span class="lineNum">     657 </span><span class="lineCov">          5 :     if (ret &lt; 0) {</span>
<span class="lineNum">     658 </span>            :         /* open/create failed, fallback to in-memory indexes */
<span class="lineNum">     659 </span><span class="lineNoCov">          0 :         if ((flags &amp; MAIL_INDEX_OPEN_FLAG_CREATE) == 0)</span>
<span class="lineNum">     660 </span><span class="lineNoCov">          0 :             return -1;</span>
<span class="lineNum">     661 </span>            : 
<span class="lineNum">     662 </span><span class="lineNoCov">          0 :         if (mail_index_move_to_memory(index) &lt; 0)</span>
<span class="lineNum">     663 </span><span class="lineNoCov">          0 :             return -1;</span>
<span class="lineNum">     664 </span>            :     }
<span class="lineNum">     665 </span>            : 
<span class="lineNum">     666 </span><span class="lineCov">          5 :     if (index-&gt;cache == NULL) {</span>
<span class="lineNum">     667 </span><span class="lineCov">          5 :         const char *path = mail_index_get_cache_path(index);</span>
<span class="lineNum">     668 </span><span class="lineCov">          5 :         index-&gt;cache = mail_cache_open_or_create_path(index, path);</span>
<span class="lineNum">     669 </span>            :     }
<span class="lineNum">     670 </span><span class="lineCov">          5 :     return 1;</span>
<span class="lineNum">     671 </span>            : }
<a name="672"><span class="lineNum">     672 </span>            : </a>
<span class="lineNum">     673 </span>            : static int
<span class="lineNum">     674 </span><span class="lineCov">         10 : mail_index_open_opened(struct mail_index *index,</span>
<span class="lineNum">     675 </span>            :                enum mail_index_open_flags flags)
<span class="lineNum">     676 </span>            : {
<span class="lineNum">     677 </span>            :     int ret;
<span class="lineNum">     678 </span>            : 
<span class="lineNum">     679 </span><span class="lineCov">         10 :     i_assert(index-&gt;map != NULL);</span>
<span class="lineNum">     680 </span>            : 
<span class="lineNum">     681 </span><span class="lineCov">         10 :     if ((index-&gt;map-&gt;hdr.flags &amp; MAIL_INDEX_HDR_FLAG_CORRUPTED) != 0) {</span>
<span class="lineNum">     682 </span>            :         /* index was marked corrupted. we'll probably need to
<span class="lineNum">     683 </span>            :            recreate the files. */
<span class="lineNum">     684 </span><span class="lineNoCov">          0 :         mail_index_unmap(&amp;index-&gt;map);</span>
<span class="lineNum">     685 </span><span class="lineNoCov">          0 :         mail_index_close_file(index);</span>
<span class="lineNum">     686 </span><span class="lineNoCov">          0 :         mail_transaction_log_close(index-&gt;log);</span>
<span class="lineNum">     687 </span><span class="lineNoCov">          0 :         if ((ret = mail_index_open_files(index, flags)) &lt;= 0)</span>
<span class="lineNum">     688 </span><span class="lineNoCov">          0 :             return ret;</span>
<span class="lineNum">     689 </span>            :     }
<span class="lineNum">     690 </span>            : 
<span class="lineNum">     691 </span><span class="lineCov">         10 :     index-&gt;open_count++;</span>
<span class="lineNum">     692 </span><span class="lineCov">         10 :     return 1;</span>
<a name="693"><span class="lineNum">     693 </span>            : }</a>
<span class="lineNum">     694 </span>            : 
<span class="lineNum">     695 </span><span class="lineCov">         15 : int mail_index_open(struct mail_index *index, enum mail_index_open_flags flags)</span>
<span class="lineNum">     696 </span>            : {
<span class="lineNum">     697 </span>            :     int ret;
<span class="lineNum">     698 </span>            : 
<span class="lineNum">     699 </span><span class="lineCov">         15 :     if (index-&gt;open_count &gt; 0) {</span>
<span class="lineNum">     700 </span><span class="lineCov">         10 :         if ((ret = mail_index_open_opened(index, flags)) &lt;= 0) {</span>
<span class="lineNum">     701 </span>            :             /* doesn't exist and create flag not used */
<span class="lineNum">     702 </span>            :         }
<span class="lineNum">     703 </span><span class="lineCov">         10 :         return ret;</span>
<span class="lineNum">     704 </span>            :     }
<span class="lineNum">     705 </span>            : 
<span class="lineNum">     706 </span><span class="lineCov">         10 :     index-&gt;filepath = MAIL_INDEX_IS_IN_MEMORY(index) ?</span>
<span class="lineNum">     707 </span><span class="lineCov">          8 :         i_strdup(&quot;(in-memory index)&quot;) :</span>
<span class="lineNum">     708 </span><span class="lineCov">          3 :         i_strconcat(index-&gt;dir, &quot;/&quot;, index-&gt;prefix, NULL);</span>
<span class="lineNum">     709 </span>            : 
<span class="lineNum">     710 </span><span class="lineCov">          5 :     index-&gt;readonly = FALSE;</span>
<span class="lineNum">     711 </span><span class="lineCov">          5 :     index-&gt;nodiskspace = FALSE;</span>
<span class="lineNum">     712 </span><span class="lineCov">          5 :     index-&gt;index_lock_timeout = FALSE;</span>
<span class="lineNum">     713 </span><span class="lineCov">          5 :     index-&gt;log_sync_locked = FALSE;</span>
<span class="lineNum">     714 </span><span class="lineCov">          5 :     index-&gt;flags = flags;</span>
<span class="lineNum">     715 </span><span class="lineCov">          5 :     index-&gt;readonly = (flags &amp; MAIL_INDEX_OPEN_FLAG_READONLY) != 0;</span>
<span class="lineNum">     716 </span>            : 
<span class="lineNum">     717 </span><span class="lineCov">          5 :     if ((flags &amp; MAIL_INDEX_OPEN_FLAG_NFS_FLUSH) != 0 &amp;&amp;</span>
<span class="lineNum">     718 </span><span class="lineNoCov">          0 :         index-&gt;fsync_mode != FSYNC_MODE_ALWAYS)</span>
<span class="lineNum">     719 </span><span class="lineNoCov">          0 :         i_fatal(&quot;nfs flush requires mail_fsync=always&quot;);</span>
<span class="lineNum">     720 </span><span class="lineCov">          5 :     if ((flags &amp; MAIL_INDEX_OPEN_FLAG_NFS_FLUSH) != 0 &amp;&amp;</span>
<span class="lineNum">     721 </span><span class="lineNoCov">          0 :         (flags &amp; MAIL_INDEX_OPEN_FLAG_MMAP_DISABLE) == 0)</span>
<span class="lineNum">     722 </span><span class="lineNoCov">          0 :         i_fatal(&quot;nfs flush requires mmap_disable=yes&quot;);</span>
<span class="lineNum">     723 </span>            : 
<span class="lineNum">     724 </span>            :     /* NOTE: increase open_count only after mail_index_open_files().
<span class="lineNum">     725 </span>            :        it's used elsewhere to check if we're doing an initial opening
<span class="lineNum">     726 </span>            :        of the index files */
<span class="lineNum">     727 </span><span class="lineCov">          5 :     if ((ret = mail_index_open_files(index, flags)) &lt;= 0) {</span>
<span class="lineNum">     728 </span>            :         /* doesn't exist and create flag not used */
<span class="lineNum">     729 </span><span class="lineNoCov">          0 :         mail_index_close_nonopened(index);</span>
<span class="lineNum">     730 </span><span class="lineNoCov">          0 :         return ret;</span>
<span class="lineNum">     731 </span>            :     }
<span class="lineNum">     732 </span>            : 
<span class="lineNum">     733 </span><span class="lineCov">          5 :     index-&gt;open_count++;</span>
<span class="lineNum">     734 </span>            : 
<span class="lineNum">     735 </span><span class="lineCov">          5 :     if (index-&gt;log-&gt;head == NULL) {</span>
<span class="lineNum">     736 </span><span class="lineNoCov">          0 :         mail_index_close(index);</span>
<span class="lineNum">     737 </span><span class="lineNoCov">          0 :         mail_index_set_error(index, &quot;Index is corrupted &quot;</span>
<span class="lineNum">     738 </span>            :                         &quot;(log-&gt;view-&gt;head == NULL)&quot;);
<span class="lineNum">     739 </span><span class="lineNoCov">          0 :         return -1;</span>
<span class="lineNum">     740 </span>            :     }
<span class="lineNum">     741 </span>            : 
<span class="lineNum">     742 </span><span class="lineCov">          5 :     i_assert(index-&gt;map != NULL);</span>
<span class="lineNum">     743 </span><span class="lineCov">          5 :     mail_index_alloc_cache_index_opened(index);</span>
<span class="lineNum">     744 </span><span class="lineCov">          5 :     return 1;</span>
<a name="745"><span class="lineNum">     745 </span>            : }</a>
<span class="lineNum">     746 </span>            : 
<span class="lineNum">     747 </span><span class="lineCov">          4 : int mail_index_open_or_create(struct mail_index *index,</span>
<span class="lineNum">     748 </span>            :                   enum mail_index_open_flags flags)
<span class="lineNum">     749 </span>            : {
<span class="lineNum">     750 </span>            :     int ret;
<span class="lineNum">     751 </span>            : 
<span class="lineNum">     752 </span><span class="lineCov">          4 :     flags |= MAIL_INDEX_OPEN_FLAG_CREATE;</span>
<span class="lineNum">     753 </span><span class="lineCov">          4 :     ret = mail_index_open(index, flags);</span>
<span class="lineNum">     754 </span><span class="lineCov">          4 :     i_assert(ret != 0);</span>
<span class="lineNum">     755 </span><span class="lineCov">          4 :     return ret &lt; 0 ? -1 : 0;</span>
<a name="756"><span class="lineNum">     756 </span>            : }</a>
<span class="lineNum">     757 </span>            : 
<span class="lineNum">     758 </span><span class="lineCov">          5 : void mail_index_close_file(struct mail_index *index)</span>
<span class="lineNum">     759 </span>            : {
<span class="lineNum">     760 </span><span class="lineCov">          5 :     if (index-&gt;fd != -1) {</span>
<span class="lineNum">     761 </span><span class="lineNoCov">          0 :         if (close(index-&gt;fd) &lt; 0)</span>
<span class="lineNum">     762 </span><span class="lineNoCov">          0 :             mail_index_set_syscall_error(index, &quot;close()&quot;);</span>
<span class="lineNum">     763 </span><span class="lineNoCov">          0 :         index-&gt;fd = -1;</span>
<span class="lineNum">     764 </span>            :     }
<a name="765"><span class="lineNum">     765 </span><span class="lineCov">          5 : }</span></a>
<span class="lineNum">     766 </span>            : 
<span class="lineNum">     767 </span><span class="lineCov">          5 : static void mail_index_close_nonopened(struct mail_index *index)</span>
<span class="lineNum">     768 </span>            : {
<span class="lineNum">     769 </span><span class="lineCov">          5 :     i_assert(!index-&gt;syncing);</span>
<span class="lineNum">     770 </span>            : 
<span class="lineNum">     771 </span><span class="lineCov">          5 :     if (index-&gt;views != NULL) {</span>
<span class="lineNum">     772 </span><span class="lineNoCov">          0 :         i_panic(&quot;Leaked view for index %s: Opened in %s:%u&quot;,</span>
<span class="lineNum">     773 </span><span class="lineNoCov">          0 :             index-&gt;filepath, index-&gt;views-&gt;source_filename,</span>
<span class="lineNum">     774 </span><span class="lineNoCov">          0 :             index-&gt;views-&gt;source_linenum);</span>
<span class="lineNum">     775 </span>            :     }
<span class="lineNum">     776 </span><span class="lineCov">          5 :     i_assert(index-&gt;views == NULL);</span>
<span class="lineNum">     777 </span>            : 
<span class="lineNum">     778 </span><span class="lineCov">          5 :     if (index-&gt;map != NULL)</span>
<span class="lineNum">     779 </span><span class="lineCov">          5 :         mail_index_unmap(&amp;index-&gt;map);</span>
<span class="lineNum">     780 </span>            : 
<span class="lineNum">     781 </span><span class="lineCov">          5 :     mail_index_close_file(index);</span>
<span class="lineNum">     782 </span><span class="lineCov">          5 :     mail_transaction_log_close(index-&gt;log);</span>
<span class="lineNum">     783 </span><span class="lineCov">          5 :     if (index-&gt;cache != NULL)</span>
<span class="lineNum">     784 </span><span class="lineCov">          5 :         mail_cache_free(&amp;index-&gt;cache);</span>
<span class="lineNum">     785 </span>            : 
<span class="lineNum">     786 </span><span class="lineCov">          5 :     i_free_and_null(index-&gt;filepath);</span>
<span class="lineNum">     787 </span>            : 
<span class="lineNum">     788 </span><span class="lineCov">          5 :     index-&gt;indexid = 0;</span>
<a name="789"><span class="lineNum">     789 </span><span class="lineCov">          5 : }</span></a>
<span class="lineNum">     790 </span>            : 
<span class="lineNum">     791 </span><span class="lineCov">         16 : void mail_index_close(struct mail_index *index)</span>
<span class="lineNum">     792 </span>            : {
<span class="lineNum">     793 </span><span class="lineCov">         16 :     i_assert(index-&gt;open_count &gt; 0);</span>
<span class="lineNum">     794 </span>            : 
<span class="lineNum">     795 </span><span class="lineCov">         16 :     mail_index_alloc_cache_index_closing(index);</span>
<span class="lineNum">     796 </span><span class="lineCov">         16 :     if (--index-&gt;open_count == 0)</span>
<span class="lineNum">     797 </span><span class="lineCov">          5 :         mail_index_close_nonopened(index);</span>
<a name="798"><span class="lineNum">     798 </span><span class="lineCov">         16 : }</span></a>
<span class="lineNum">     799 </span>            : 
<span class="lineNum">     800 </span><span class="lineNoCov">          0 : int mail_index_unlink(struct mail_index *index)</span>
<span class="lineNum">     801 </span>            : {
<span class="lineNum">     802 </span>            :     const char *path;
<span class="lineNum">     803 </span><span class="lineNoCov">          0 :     int last_errno = 0;</span>
<span class="lineNum">     804 </span>            : 
<span class="lineNum">     805 </span><span class="lineNoCov">          0 :     if (MAIL_INDEX_IS_IN_MEMORY(index) || index-&gt;readonly)</span>
<span class="lineNum">     806 </span><span class="lineNoCov">          0 :         return 0;</span>
<span class="lineNum">     807 </span>            : 
<span class="lineNum">     808 </span>            :     /* main index */
<span class="lineNum">     809 </span><span class="lineNoCov">          0 :     if (unlink(index-&gt;filepath) &lt; 0 &amp;&amp; errno != ENOENT)</span>
<span class="lineNum">     810 </span><span class="lineNoCov">          0 :         last_errno = errno;</span>
<span class="lineNum">     811 </span>            : 
<span class="lineNum">     812 </span>            :     /* logs */
<span class="lineNum">     813 </span><span class="lineNoCov">          0 :     path = t_strconcat(index-&gt;filepath, MAIL_TRANSACTION_LOG_SUFFIX, NULL);</span>
<span class="lineNum">     814 </span><span class="lineNoCov">          0 :     if (unlink(path) &lt; 0 &amp;&amp; errno != ENOENT)</span>
<span class="lineNum">     815 </span><span class="lineNoCov">          0 :         last_errno = errno;</span>
<span class="lineNum">     816 </span>            : 
<span class="lineNum">     817 </span><span class="lineNoCov">          0 :     path = t_strconcat(index-&gt;filepath,</span>
<span class="lineNum">     818 </span>            :                MAIL_TRANSACTION_LOG_SUFFIX&quot;.2&quot;, NULL);
<span class="lineNum">     819 </span><span class="lineNoCov">          0 :     if (unlink(path) &lt; 0 &amp;&amp; errno != ENOENT)</span>
<span class="lineNum">     820 </span><span class="lineNoCov">          0 :         last_errno = errno;</span>
<span class="lineNum">     821 </span>            : 
<span class="lineNum">     822 </span>            :     /* cache */
<span class="lineNum">     823 </span><span class="lineNoCov">          0 :     path = t_strconcat(index-&gt;filepath, MAIL_CACHE_FILE_SUFFIX, NULL);</span>
<span class="lineNum">     824 </span><span class="lineNoCov">          0 :     if (unlink(path) &lt; 0 &amp;&amp; errno != ENOENT)</span>
<span class="lineNum">     825 </span><span class="lineNoCov">          0 :         last_errno = errno;</span>
<span class="lineNum">     826 </span>            : 
<span class="lineNum">     827 </span><span class="lineNoCov">          0 :     if (last_errno == 0)</span>
<span class="lineNum">     828 </span><span class="lineNoCov">          0 :         return 0;</span>
<span class="lineNum">     829 </span>            :     else {
<span class="lineNum">     830 </span><span class="lineNoCov">          0 :         errno = last_errno;</span>
<span class="lineNum">     831 </span><span class="lineNoCov">          0 :         return -1;</span>
<span class="lineNum">     832 </span>            :     }
<a name="833"><span class="lineNum">     833 </span>            : }</a>
<span class="lineNum">     834 </span>            : 
<span class="lineNum">     835 </span><span class="lineCov">          5 : int mail_index_reopen_if_changed(struct mail_index *index,</span>
<span class="lineNum">     836 </span>            :                  const char **reason_r)
<span class="lineNum">     837 </span>            : {
<span class="lineNum">     838 </span>            :     struct stat st1, st2;
<span class="lineNum">     839 </span>            :     int ret;
<span class="lineNum">     840 </span>            : 
<span class="lineNum">     841 </span><span class="lineCov">          5 :     if (MAIL_INDEX_IS_IN_MEMORY(index)) {</span>
<span class="lineNum">     842 </span><span class="lineCov">          2 :         *reason_r = &quot;in-memory index&quot;;</span>
<span class="lineNum">     843 </span><span class="lineCov">          2 :         return 0;</span>
<span class="lineNum">     844 </span>            :     }
<span class="lineNum">     845 </span>            : 
<span class="lineNum">     846 </span><span class="lineCov">          3 :     if (index-&gt;fd == -1)</span>
<span class="lineNum">     847 </span><span class="lineCov">          3 :         goto final;</span>
<span class="lineNum">     848 </span>            : 
<span class="lineNum">     849 </span><span class="lineNoCov">          0 :     if ((index-&gt;flags &amp; MAIL_INDEX_OPEN_FLAG_NFS_FLUSH) != 0)</span>
<span class="lineNum">     850 </span><span class="lineNoCov">          0 :         nfs_flush_file_handle_cache(index-&gt;filepath);</span>
<span class="lineNum">     851 </span><span class="lineNoCov">          0 :     if (nfs_safe_stat(index-&gt;filepath, &amp;st2) &lt; 0) {</span>
<span class="lineNum">     852 </span><span class="lineNoCov">          0 :         if (errno == ENOENT) {</span>
<span class="lineNum">     853 </span><span class="lineNoCov">          0 :             *reason_r = &quot;index not found via stat()&quot;;</span>
<span class="lineNum">     854 </span><span class="lineNoCov">          0 :             return 0;</span>
<span class="lineNum">     855 </span>            :         }
<span class="lineNum">     856 </span><span class="lineNoCov">          0 :         mail_index_set_syscall_error(index, &quot;stat()&quot;);</span>
<span class="lineNum">     857 </span><span class="lineNoCov">          0 :         return -1;</span>
<span class="lineNum">     858 </span>            :     }
<span class="lineNum">     859 </span>            : 
<span class="lineNum">     860 </span><span class="lineNoCov">          0 :     if (fstat(index-&gt;fd, &amp;st1) &lt; 0) {</span>
<span class="lineNum">     861 </span><span class="lineNoCov">          0 :         if (!ESTALE_FSTAT(errno)) {</span>
<span class="lineNum">     862 </span><span class="lineNoCov">          0 :             mail_index_set_syscall_error(index, &quot;fstat()&quot;);</span>
<span class="lineNum">     863 </span><span class="lineNoCov">          0 :             return -1;</span>
<span class="lineNum">     864 </span>            :         }
<span class="lineNum">     865 </span>            :         /* deleted/recreated, reopen */
<span class="lineNum">     866 </span><span class="lineNoCov">          0 :         *reason_r = &quot;index is stale&quot;;</span>
<span class="lineNum">     867 </span><span class="lineNoCov">          0 :     } else if (st1.st_ino == st2.st_ino &amp;&amp;</span>
<span class="lineNum">     868 </span><span class="lineNoCov">          0 :            CMP_DEV_T(st1.st_dev, st2.st_dev)) {</span>
<span class="lineNum">     869 </span>            :         /* the same file */
<span class="lineNum">     870 </span><span class="lineNoCov">          0 :         *reason_r = &quot;index unchanged&quot;;</span>
<span class="lineNum">     871 </span><span class="lineNoCov">          0 :         return 1;</span>
<span class="lineNum">     872 </span>            :     } else {
<span class="lineNum">     873 </span><span class="lineNoCov">          0 :         *reason_r = &quot;index inode changed&quot;;</span>
<span class="lineNum">     874 </span>            :     }
<span class="lineNum">     875 </span>            : 
<span class="lineNum">     876 </span>            :     /* new file, new locks. the old fd can keep its locks, they don't
<span class="lineNum">     877 </span>            :        matter anymore as no-one's going to modify the file. */
<span class="lineNum">     878 </span><span class="lineNoCov">          0 :     mail_index_close_file(index);</span>
<span class="lineNum">     879 </span>            : 
<span class="lineNum">     880 </span>            : final:
<span class="lineNum">     881 </span><span class="lineCov">          3 :     if ((ret = mail_index_try_open_only(index)) == 0)</span>
<span class="lineNum">     882 </span><span class="lineCov">          3 :         *reason_r = &quot;index not found via open()&quot;;</span>
<span class="lineNum">     883 </span><span class="lineNoCov">          0 :     else if (ret &gt; 0)</span>
<span class="lineNum">     884 </span><span class="lineNoCov">          0 :         *reason_r = &quot;index opened&quot;;</span>
<span class="lineNum">     885 </span><span class="lineCov">          3 :     return ret;</span>
<a name="886"><span class="lineNum">     886 </span>            : }</a>
<span class="lineNum">     887 </span>            : 
<span class="lineNum">     888 </span><span class="lineCov">         44 : int mail_index_refresh(struct mail_index *index)</span>
<span class="lineNum">     889 </span>            : {
<span class="lineNum">     890 </span>            :     int ret;
<span class="lineNum">     891 </span>            : 
<span class="lineNum">     892 </span><span class="lineCov">         44 :     ret = mail_index_map(index, MAIL_INDEX_SYNC_HANDLER_HEAD);</span>
<span class="lineNum">     893 </span><span class="lineCov">         44 :     return ret &lt;= 0 ? -1 : 0;</span>
<a name="894"><span class="lineNum">     894 </span>            : }</a>
<span class="lineNum">     895 </span>            : 
<span class="lineNum">     896 </span><span class="lineCov">         11 : struct mail_cache *mail_index_get_cache(struct mail_index *index)</span>
<span class="lineNum">     897 </span>            : {
<span class="lineNum">     898 </span><span class="lineCov">         11 :     return index-&gt;cache;</span>
<a name="899"><span class="lineNum">     899 </span>            : }</a>
<span class="lineNum">     900 </span>            : 
<span class="lineNum">     901 </span><span class="lineCov">          1 : void mail_index_set_error(struct mail_index *index, const char *fmt, ...)</span>
<span class="lineNum">     902 </span>            : {
<span class="lineNum">     903 </span>            :     va_list va;
<span class="lineNum">     904 </span>            : 
<span class="lineNum">     905 </span><span class="lineCov">          1 :     i_free(index-&gt;error);</span>
<span class="lineNum">     906 </span>            : 
<span class="lineNum">     907 </span><span class="lineCov">          1 :     if (fmt == NULL)</span>
<span class="lineNum">     908 </span><span class="lineNoCov">          0 :         index-&gt;error = NULL;</span>
<span class="lineNum">     909 </span>            :     else {
<span class="lineNum">     910 </span><span class="lineCov">          1 :         va_start(va, fmt);</span>
<span class="lineNum">     911 </span><span class="lineCov">          1 :         index-&gt;error = i_strdup_vprintf(fmt, va);</span>
<span class="lineNum">     912 </span><span class="lineCov">          1 :         va_end(va);</span>
<span class="lineNum">     913 </span>            : 
<span class="lineNum">     914 </span><span class="lineCov">          1 :         e_error(index-&gt;event, &quot;%s&quot;, index-&gt;error);</span>
<span class="lineNum">     915 </span>            :     }
<a name="916"><span class="lineNum">     916 </span><span class="lineCov">          1 : }</span></a>
<span class="lineNum">     917 </span>            : 
<span class="lineNum">     918 </span><span class="lineNoCov">          0 : void mail_index_set_error_nolog(struct mail_index *index, const char *str)</span>
<span class="lineNum">     919 </span>            : {
<span class="lineNum">     920 </span><span class="lineNoCov">          0 :     i_assert(str != NULL);</span>
<span class="lineNum">     921 </span>            : 
<span class="lineNum">     922 </span><span class="lineNoCov">          0 :     char *old_error = index-&gt;error;</span>
<span class="lineNum">     923 </span><span class="lineNoCov">          0 :     index-&gt;error = i_strdup(str);</span>
<span class="lineNum">     924 </span><span class="lineNoCov">          0 :     i_free(old_error);</span>
<a name="925"><span class="lineNum">     925 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     926 </span>            : 
<span class="lineNum">     927 </span><span class="lineNoCov">          0 : bool mail_index_is_in_memory(struct mail_index *index)</span>
<span class="lineNum">     928 </span>            : {
<span class="lineNum">     929 </span><span class="lineNoCov">          0 :     return MAIL_INDEX_IS_IN_MEMORY(index);</span>
<a name="930"><span class="lineNum">     930 </span>            : }</a>
<span class="lineNum">     931 </span>            : 
<span class="lineNum">     932 </span><span class="lineNoCov">          0 : static void mail_index_set_as_in_memory(struct mail_index *index)</span>
<span class="lineNum">     933 </span>            : {
<span class="lineNum">     934 </span><span class="lineNoCov">          0 :     i_free_and_null(index-&gt;dir);</span>
<span class="lineNum">     935 </span>            : 
<span class="lineNum">     936 </span><span class="lineNoCov">          0 :     i_free(index-&gt;filepath);</span>
<span class="lineNum">     937 </span><span class="lineNoCov">          0 :     index-&gt;filepath = i_strdup(&quot;(in-memory index)&quot;);</span>
<a name="938"><span class="lineNum">     938 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     939 </span>            : 
<span class="lineNum">     940 </span><span class="lineNoCov">          0 : int mail_index_move_to_memory(struct mail_index *index)</span>
<span class="lineNum">     941 </span>            : {
<span class="lineNum">     942 </span>            :     struct mail_index_map *map;
<span class="lineNum">     943 </span>            : 
<span class="lineNum">     944 </span><span class="lineNoCov">          0 :     if (MAIL_INDEX_IS_IN_MEMORY(index))</span>
<span class="lineNum">     945 </span><span class="lineNoCov">          0 :         return index-&gt;map == NULL ? -1 : 0;</span>
<span class="lineNum">     946 </span>            : 
<span class="lineNum">     947 </span><span class="lineNoCov">          0 :     if ((index-&gt;flags &amp; MAIL_INDEX_OPEN_FLAG_NEVER_IN_MEMORY) != 0)</span>
<span class="lineNum">     948 </span><span class="lineNoCov">          0 :         return -1;</span>
<span class="lineNum">     949 </span>            : 
<span class="lineNum">     950 </span><span class="lineNoCov">          0 :     if (index-&gt;map == NULL) {</span>
<span class="lineNum">     951 </span>            :         /* index was never even opened. just mark it as being in
<span class="lineNum">     952 </span>            :            memory and let the caller re-open the index. */
<span class="lineNum">     953 </span><span class="lineNoCov">          0 :         i_assert(index-&gt;fd == -1);</span>
<span class="lineNum">     954 </span><span class="lineNoCov">          0 :         mail_index_set_as_in_memory(index);</span>
<span class="lineNum">     955 </span><span class="lineNoCov">          0 :         return -1;</span>
<span class="lineNum">     956 </span>            :     }
<span class="lineNum">     957 </span>            : 
<span class="lineNum">     958 </span>            :     /* move index map to memory */
<span class="lineNum">     959 </span><span class="lineNoCov">          0 :     if (!MAIL_INDEX_MAP_IS_IN_MEMORY(index-&gt;map)) {</span>
<span class="lineNum">     960 </span><span class="lineNoCov">          0 :         map = mail_index_map_clone(index-&gt;map);</span>
<span class="lineNum">     961 </span><span class="lineNoCov">          0 :         mail_index_unmap(&amp;index-&gt;map);</span>
<span class="lineNum">     962 </span><span class="lineNoCov">          0 :         index-&gt;map = map;</span>
<span class="lineNum">     963 </span>            :     }
<span class="lineNum">     964 </span>            : 
<span class="lineNum">     965 </span><span class="lineNoCov">          0 :     if (index-&gt;log != NULL) {</span>
<span class="lineNum">     966 </span>            :         /* move transaction log to memory */
<span class="lineNum">     967 </span><span class="lineNoCov">          0 :         if (mail_transaction_log_move_to_memory(index-&gt;log) &lt; 0)</span>
<span class="lineNum">     968 </span><span class="lineNoCov">          0 :             return -1;</span>
<span class="lineNum">     969 </span>            :     }
<span class="lineNum">     970 </span>            : 
<span class="lineNum">     971 </span><span class="lineNoCov">          0 :     if (index-&gt;fd != -1) {</span>
<span class="lineNum">     972 </span><span class="lineNoCov">          0 :         if (close(index-&gt;fd) &lt; 0)</span>
<span class="lineNum">     973 </span><span class="lineNoCov">          0 :             mail_index_set_syscall_error(index, &quot;close()&quot;);</span>
<span class="lineNum">     974 </span><span class="lineNoCov">          0 :         index-&gt;fd = -1;</span>
<span class="lineNum">     975 </span>            :     }
<span class="lineNum">     976 </span><span class="lineNoCov">          0 :     mail_index_set_as_in_memory(index);</span>
<span class="lineNum">     977 </span><span class="lineNoCov">          0 :     return 0;</span>
<a name="978"><span class="lineNum">     978 </span>            : }</a>
<span class="lineNum">     979 </span>            : 
<span class="lineNum">     980 </span><span class="lineNoCov">          0 : void mail_index_mark_corrupted(struct mail_index *index)</span>
<span class="lineNum">     981 </span>            : {
<span class="lineNum">     982 </span><span class="lineNoCov">          0 :     index-&gt;indexid = 0;</span>
<span class="lineNum">     983 </span>            : 
<span class="lineNum">     984 </span><span class="lineNoCov">          0 :     index-&gt;map-&gt;hdr.flags |= MAIL_INDEX_HDR_FLAG_CORRUPTED;</span>
<span class="lineNum">     985 </span><span class="lineNoCov">          0 :     if (!index-&gt;readonly) {</span>
<span class="lineNum">     986 </span><span class="lineNoCov">          0 :         if (unlink(index-&gt;filepath) &lt; 0 &amp;&amp;</span>
<span class="lineNum">     987 </span><span class="lineNoCov">          0 :             errno != ENOENT &amp;&amp; errno != ESTALE)</span>
<span class="lineNum">     988 </span><span class="lineNoCov">          0 :             mail_index_set_syscall_error(index, &quot;unlink()&quot;);</span>
<span class="lineNum">     989 </span><span class="lineNoCov">          0 :         (void)mail_transaction_log_unlink(index-&gt;log);</span>
<span class="lineNum">     990 </span>            :     }
<a name="991"><span class="lineNum">     991 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     992 </span>            : 
<span class="lineNum">     993 </span><span class="lineCov">         11 : bool mail_index_is_deleted(struct mail_index *index)</span>
<span class="lineNum">     994 </span>            : {
<span class="lineNum">     995 </span><span class="lineCov">         11 :     return index-&gt;index_delete_requested || index-&gt;index_deleted;</span>
<a name="996"><span class="lineNum">     996 </span>            : }</a>
<span class="lineNum">     997 </span>            : 
<span class="lineNum">     998 </span><span class="lineNoCov">          0 : int mail_index_get_modification_time(struct mail_index *index, time_t *mtime_r)</span>
<span class="lineNum">     999 </span>            : {
<span class="lineNum">    1000 </span>            :     struct stat st;
<span class="lineNum">    1001 </span>            :     const char *path;
<span class="lineNum">    1002 </span>            : 
<span class="lineNum">    1003 </span><span class="lineNoCov">          0 :     *mtime_r = 0;</span>
<span class="lineNum">    1004 </span><span class="lineNoCov">          0 :     if (MAIL_INDEX_IS_IN_MEMORY(index)) {</span>
<span class="lineNum">    1005 </span>            :         /* this function doesn't make sense for in-memory indexes */
<span class="lineNum">    1006 </span><span class="lineNoCov">          0 :         return 0;</span>
<span class="lineNum">    1007 </span>            :     }
<span class="lineNum">    1008 </span>            : 
<span class="lineNum">    1009 </span>            :     /* index may not be open, so index-&gt;filepath may be NULL */
<span class="lineNum">    1010 </span><span class="lineNoCov">          0 :     path = t_strconcat(index-&gt;dir, &quot;/&quot;, index-&gt;prefix,</span>
<span class="lineNum">    1011 </span>            :                MAIL_TRANSACTION_LOG_SUFFIX, NULL);
<span class="lineNum">    1012 </span><span class="lineNoCov">          0 :     if (stat(path, &amp;st) &lt; 0) {</span>
<span class="lineNum">    1013 </span><span class="lineNoCov">          0 :         if (errno == ENOENT) {</span>
<span class="lineNum">    1014 </span>            :             /* .log is always supposed to exist - don't bother
<span class="lineNum">    1015 </span>            :                trying to stat(dovecot.index) */
<span class="lineNum">    1016 </span><span class="lineNoCov">          0 :             return 0;</span>
<span class="lineNum">    1017 </span>            :         }
<span class="lineNum">    1018 </span><span class="lineNoCov">          0 :         mail_index_file_set_syscall_error(index, path, &quot;stat()&quot;);</span>
<span class="lineNum">    1019 </span><span class="lineNoCov">          0 :         return -1;</span>
<span class="lineNum">    1020 </span>            :     }
<span class="lineNum">    1021 </span><span class="lineNoCov">          0 :     *mtime_r = st.st_mtime;</span>
<span class="lineNum">    1022 </span><span class="lineNoCov">          0 :     return 0;</span>
<a name="1023"><span class="lineNum">    1023 </span>            : }</a>
<span class="lineNum">    1024 </span>            : 
<span class="lineNum">    1025 </span><span class="lineCov">          4 : void mail_index_fchown(struct mail_index *index, int fd, const char *path)</span>
<span class="lineNum">    1026 </span>            : {
<span class="lineNum">    1027 </span>            :     mode_t mode;
<span class="lineNum">    1028 </span>            : 
<span class="lineNum">    1029 </span><span class="lineCov">          4 :     if (index-&gt;gid == (gid_t)-1) {</span>
<span class="lineNum">    1030 </span>            :         /* no gid changing */
<span class="lineNum">    1031 </span><span class="lineCov">          4 :         return;</span>
<span class="lineNum">    1032 </span><span class="lineNoCov">          0 :     } else if (fchown(fd, (uid_t)-1, index-&gt;gid) == 0) {</span>
<span class="lineNum">    1033 </span>            :         /* success */
<span class="lineNum">    1034 </span><span class="lineNoCov">          0 :         return;</span>
<span class="lineNum">    1035 </span><span class="lineNoCov">          0 :     } if ((index-&gt;mode &amp; 0060) &gt;&gt; 3 == (index-&gt;mode &amp; 0006)) {</span>
<span class="lineNum">    1036 </span>            :         /* group and world permissions are the same, so group doesn't
<span class="lineNum">    1037 </span>            :            really matter. ignore silently. */
<span class="lineNum">    1038 </span><span class="lineNoCov">          0 :         return;</span>
<span class="lineNum">    1039 </span>            :     }
<span class="lineNum">    1040 </span><span class="lineNoCov">          0 :     if (errno != EPERM)</span>
<span class="lineNum">    1041 </span><span class="lineNoCov">          0 :         mail_index_file_set_syscall_error(index, path, &quot;fchown()&quot;);</span>
<span class="lineNum">    1042 </span>            :     else {
<span class="lineNum">    1043 </span><span class="lineNoCov">          0 :         mail_index_set_error(index, &quot;%s&quot;,</span>
<span class="lineNum">    1044 </span>            :             eperm_error_get_chgrp(&quot;fchown&quot;, path, index-&gt;gid,
<span class="lineNum">    1045 </span><span class="lineNoCov">          0 :                           index-&gt;gid_origin));</span>
<span class="lineNum">    1046 </span>            :     }
<span class="lineNum">    1047 </span>            : 
<span class="lineNum">    1048 </span>            :     /* continue, but change permissions so that only the common
<span class="lineNum">    1049 </span>            :        subset of group and world is used. this makes sure no one
<span class="lineNum">    1050 </span>            :        gets any extra permissions. */
<span class="lineNum">    1051 </span><span class="lineNoCov">          0 :     mode = ((index-&gt;mode &amp; 0060) &gt;&gt; 3) &amp; (index-&gt;mode &amp; 0006);</span>
<span class="lineNum">    1052 </span><span class="lineNoCov">          0 :     mode |= (mode &lt;&lt; 3) | (index-&gt;mode &amp; 0600);</span>
<span class="lineNum">    1053 </span><span class="lineNoCov">          0 :     if (fchmod(fd, mode) &lt; 0)</span>
<span class="lineNum">    1054 </span><span class="lineNoCov">          0 :         mail_index_file_set_syscall_error(index, path, &quot;fchmod()&quot;);</span>
<a name="1055"><span class="lineNum">    1055 </span>            : }</a>
<span class="lineNum">    1056 </span>            : 
<span class="lineNum">    1057 </span><span class="lineNoCov">          0 : void mail_index_set_syscall_error(struct mail_index *index,</span>
<span class="lineNum">    1058 </span>            :                   const char *function)
<span class="lineNum">    1059 </span>            : {
<span class="lineNum">    1060 </span><span class="lineNoCov">          0 :     mail_index_file_set_syscall_error(index, index-&gt;filepath, function);</span>
<a name="1061"><span class="lineNum">    1061 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1062 </span>            : 
<span class="lineNum">    1063 </span><span class="lineNoCov">          0 : void mail_index_file_set_syscall_error(struct mail_index *index,</span>
<span class="lineNum">    1064 </span>            :                        const char *filepath,
<span class="lineNum">    1065 </span>            :                        const char *function)
<span class="lineNum">    1066 </span>            : {
<span class="lineNum">    1067 </span>            :     const char *errstr;
<span class="lineNum">    1068 </span>            : 
<span class="lineNum">    1069 </span><span class="lineNoCov">          0 :     i_assert(filepath != NULL);</span>
<span class="lineNum">    1070 </span><span class="lineNoCov">          0 :     i_assert(function != NULL);</span>
<span class="lineNum">    1071 </span>            : 
<span class="lineNum">    1072 </span><span class="lineNoCov">          0 :     if (errno == ENOENT) {</span>
<span class="lineNum">    1073 </span>            :         struct stat st;
<span class="lineNum">    1074 </span><span class="lineNoCov">          0 :         int old_errno = errno;</span>
<span class="lineNum">    1075 </span><span class="lineNoCov">          0 :         i_assert(index-&gt;log-&gt;filepath != NULL);</span>
<span class="lineNum">    1076 </span><span class="lineNoCov">          0 :         if (nfs_safe_stat(index-&gt;log-&gt;filepath, &amp;st) &lt; 0 &amp;&amp;</span>
<span class="lineNum">    1077 </span><span class="lineNoCov">          0 :             errno == ENOENT) {</span>
<span class="lineNum">    1078 </span>            :             /* the index log has gone away */
<span class="lineNum">    1079 </span><span class="lineNoCov">          0 :             index-&gt;index_deleted = TRUE;</span>
<span class="lineNum">    1080 </span><span class="lineNoCov">          0 :             errno = old_errno;</span>
<span class="lineNum">    1081 </span><span class="lineNoCov">          0 :             return;</span>
<span class="lineNum">    1082 </span>            :         }
<span class="lineNum">    1083 </span><span class="lineNoCov">          0 :         errno = old_errno;</span>
<span class="lineNum">    1084 </span>            :     }
<span class="lineNum">    1085 </span>            : 
<span class="lineNum">    1086 </span><span class="lineNoCov">          0 :     if (ENOSPACE(errno)) {</span>
<span class="lineNum">    1087 </span><span class="lineNoCov">          0 :         index-&gt;nodiskspace = TRUE;</span>
<span class="lineNum">    1088 </span><span class="lineNoCov">          0 :         if ((index-&gt;flags &amp; MAIL_INDEX_OPEN_FLAG_NEVER_IN_MEMORY) == 0)</span>
<span class="lineNum">    1089 </span><span class="lineNoCov">          0 :             return;</span>
<span class="lineNum">    1090 </span>            :     }
<span class="lineNum">    1091 </span>            : 
<span class="lineNum">    1092 </span><span class="lineNoCov">          0 :     if (errno == EACCES) {</span>
<span class="lineNum">    1093 </span><span class="lineNoCov">          0 :         function = t_strcut(function, '(');</span>
<span class="lineNum">    1094 </span><span class="lineNoCov">          0 :         if (strcmp(function, &quot;creat&quot;) == 0 ||</span>
<span class="lineNum">    1095 </span><span class="lineNoCov">          0 :             strncmp(function, &quot;file_dotlock_&quot;, 13) == 0)</span>
<span class="lineNum">    1096 </span><span class="lineNoCov">          0 :             errstr = eacces_error_get_creating(function, filepath);</span>
<span class="lineNum">    1097 </span>            :         else
<span class="lineNum">    1098 </span><span class="lineNoCov">          0 :             errstr = eacces_error_get(function, filepath);</span>
<span class="lineNum">    1099 </span><span class="lineNoCov">          0 :         mail_index_set_error(index, &quot;%s&quot;, errstr);</span>
<span class="lineNum">    1100 </span>            :     } else {
<span class="lineNum">    1101 </span><span class="lineNoCov">          0 :         const char *suffix = errno != EFBIG ? &quot;&quot; :</span>
<span class="lineNum">    1102 </span>            :             &quot; (process was started with ulimit -f limit)&quot;;
<span class="lineNum">    1103 </span><span class="lineNoCov">          0 :         mail_index_set_error(index, &quot;%s failed with file %s: &quot;</span>
<span class="lineNum">    1104 </span>            :                      &quot;%m%s&quot;, function, filepath, suffix);
<span class="lineNum">    1105 </span>            :     }
<a name="1106"><span class="lineNum">    1106 </span>            : }</a>
<span class="lineNum">    1107 </span>            : 
<span class="lineNum">    1108 </span><span class="lineNoCov">          0 : const char *mail_index_get_error_message(struct mail_index *index)</span>
<span class="lineNum">    1109 </span>            : {
<span class="lineNum">    1110 </span><span class="lineNoCov">          0 :     return index-&gt;error;</span>
<a name="1111"><span class="lineNum">    1111 </span>            : }</a>
<span class="lineNum">    1112 </span>            : 
<span class="lineNum">    1113 </span><span class="lineNoCov">          0 : void mail_index_reset_error(struct mail_index *index)</span>
<span class="lineNum">    1114 </span>            : {
<span class="lineNum">    1115 </span><span class="lineNoCov">          0 :     if (index-&gt;error != NULL) {</span>
<span class="lineNum">    1116 </span><span class="lineNoCov">          0 :         i_free(index-&gt;error);</span>
<span class="lineNum">    1117 </span><span class="lineNoCov">          0 :         index-&gt;error = NULL;</span>
<span class="lineNum">    1118 </span>            :     }
<span class="lineNum">    1119 </span>            : 
<span class="lineNum">    1120 </span><span class="lineNoCov">          0 :     index-&gt;nodiskspace = FALSE;</span>
<span class="lineNum">    1121 </span><span class="lineNoCov">          0 :         index-&gt;index_lock_timeout = FALSE;</span>
<span class="lineNum">    1122 </span><span class="lineNoCov">          0 : }</span>
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.10</a></td></tr>
  </table>
  <br>

</body>
</html>
