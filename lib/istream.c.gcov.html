<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - Dovecot coverage - lib/istream.c</title>
  <link rel="stylesheet" type="text/css" href="../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../index.html">top level</a> - <a href="index.html">lib</a> - istream.c<span style="font-size: 80%;"> (source / <a href="istream.c.func.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">Dovecot coverage</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">490</td>
            <td class="headerCovTableEntry">614</td>
            <td class="headerCovTableEntryMed">79.8 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2021-02-24</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">60</td>
            <td class="headerCovTableEntry">72</td>
            <td class="headerCovTableEntryMed">83.3 %</td>
          </tr>
          <tr>
            <td class="headerItem">Legend:</td>
            <td class="headerValueLeg">            Lines:
            <span class="coverLegendCov">hit</span>
            <span class="coverLegendNoCov">not hit</span>
</td>
            <td></td>
          </tr>
          <tr><td><img src="../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /* Copyright (c) 2002-2018 Dovecot authors, see the included COPYING file */</a>
<span class="lineNum">       2 </span>            : 
<span class="lineNum">       3 </span>            : #include &quot;lib.h&quot;
<span class="lineNum">       4 </span>            : #include &quot;ioloop.h&quot;
<span class="lineNum">       5 </span>            : #include &quot;array.h&quot;
<span class="lineNum">       6 </span>            : #include &quot;str.h&quot;
<span class="lineNum">       7 </span>            : #include &quot;memarea.h&quot;
<span class="lineNum">       8 </span>            : #include &quot;istream-private.h&quot;
<span class="lineNum">       9 </span>            : 
<a name="10"><span class="lineNum">      10 </span>            : static bool i_stream_is_buffer_invalid(const struct istream_private *stream);</a>
<span class="lineNum">      11 </span>            : 
<span class="lineNum">      12 </span><span class="lineCov">      35305 : void i_stream_set_name(struct istream *stream, const char *name)</span>
<span class="lineNum">      13 </span>            : {
<span class="lineNum">      14 </span><span class="lineCov">      35305 :     i_free(stream-&gt;real_stream-&gt;iostream.name);</span>
<span class="lineNum">      15 </span><span class="lineCov">      35305 :     stream-&gt;real_stream-&gt;iostream.name = i_strdup(name);</span>
<a name="16"><span class="lineNum">      16 </span><span class="lineCov">      35305 : }</span></a>
<span class="lineNum">      17 </span>            : 
<span class="lineNum">      18 </span><span class="lineCov">        176 : const char *i_stream_get_name(struct istream *stream)</span>
<span class="lineNum">      19 </span>            : {
<span class="lineNum">      20 </span><span class="lineCov">        368 :     while (stream-&gt;real_stream-&gt;iostream.name == NULL) {</span>
<span class="lineNum">      21 </span><span class="lineCov">        154 :         stream = stream-&gt;real_stream-&gt;parent;</span>
<span class="lineNum">      22 </span><span class="lineCov">        154 :         if (stream == NULL)</span>
<span class="lineNum">      23 </span><span class="lineCov">        138 :             return &quot;&quot;;</span>
<span class="lineNum">      24 </span>            :     }
<span class="lineNum">      25 </span><span class="lineCov">         38 :     return stream-&gt;real_stream-&gt;iostream.name;</span>
<a name="26"><span class="lineNum">      26 </span>            : }</a>
<span class="lineNum">      27 </span>            : 
<span class="lineNum">      28 </span><span class="lineCov">        439 : static void i_stream_close_full(struct istream *stream, bool close_parents)</span>
<span class="lineNum">      29 </span>            : {
<span class="lineNum">      30 </span><span class="lineCov">        439 :     io_stream_close(&amp;stream-&gt;real_stream-&gt;iostream, close_parents);</span>
<span class="lineNum">      31 </span><span class="lineCov">        439 :     stream-&gt;closed = TRUE;</span>
<span class="lineNum">      32 </span>            : 
<span class="lineNum">      33 </span><span class="lineCov">        439 :     if (stream-&gt;stream_errno == 0)</span>
<span class="lineNum">      34 </span><span class="lineCov">        306 :         stream-&gt;stream_errno = EPIPE;</span>
<a name="35"><span class="lineNum">      35 </span><span class="lineCov">        439 : }</span></a>
<span class="lineNum">      36 </span>            : 
<span class="lineNum">      37 </span><span class="lineCov">        319 : void i_stream_destroy(struct istream **stream)</span>
<span class="lineNum">      38 </span>            : {
<span class="lineNum">      39 </span><span class="lineCov">        319 :     if (*stream == NULL)</span>
<span class="lineNum">      40 </span><span class="lineCov">        319 :         return;</span>
<span class="lineNum">      41 </span>            : 
<span class="lineNum">      42 </span><span class="lineCov">        319 :     i_stream_close_full(*stream, FALSE);</span>
<span class="lineNum">      43 </span><span class="lineCov">        319 :     i_stream_unref(stream);</span>
<a name="44"><span class="lineNum">      44 </span>            : }</a>
<span class="lineNum">      45 </span>            : 
<span class="lineNum">      46 </span><span class="lineCov">      38586 : void i_stream_ref(struct istream *stream)</span>
<span class="lineNum">      47 </span>            : {
<span class="lineNum">      48 </span><span class="lineCov">      38586 :     io_stream_ref(&amp;stream-&gt;real_stream-&gt;iostream);</span>
<a name="49"><span class="lineNum">      49 </span><span class="lineCov">      38586 : }</span></a>
<span class="lineNum">      50 </span>            : 
<span class="lineNum">      51 </span><span class="lineCov">     224024 : void i_stream_unref(struct istream **stream)</span>
<span class="lineNum">      52 </span>            : {
<span class="lineNum">      53 </span>            :     struct istream_private *_stream;
<span class="lineNum">      54 </span>            : 
<span class="lineNum">      55 </span><span class="lineCov">     224024 :     if (*stream == NULL)</span>
<span class="lineNum">      56 </span><span class="lineCov">     335305 :         return;</span>
<span class="lineNum">      57 </span>            : 
<span class="lineNum">      58 </span><span class="lineCov">     112743 :     _stream = (*stream)-&gt;real_stream;</span>
<span class="lineNum">      59 </span>            : 
<span class="lineNum">      60 </span><span class="lineCov">     112743 :     if (!io_stream_unref(&amp;_stream-&gt;iostream)) {</span>
<span class="lineNum">      61 </span><span class="lineCov">      74157 :         if (_stream-&gt;line_str != NULL)</span>
<span class="lineNum">      62 </span><span class="lineNoCov">          0 :             str_free(&amp;_stream-&gt;line_str);</span>
<span class="lineNum">      63 </span><span class="lineCov">      74157 :         i_stream_snapshot_free(&amp;_stream-&gt;prev_snapshot);</span>
<span class="lineNum">      64 </span><span class="lineCov">      74157 :         i_stream_unref(&amp;_stream-&gt;parent);</span>
<span class="lineNum">      65 </span><span class="lineCov">      74157 :         io_stream_free(&amp;_stream-&gt;iostream);</span>
<span class="lineNum">      66 </span>            :     }
<span class="lineNum">      67 </span><span class="lineCov">     112743 :     *stream = NULL;</span>
<span class="lineNum">      68 </span>            : }
<a name="69"><span class="lineNum">      69 </span>            : </a>
<span class="lineNum">      70 </span>            : #undef i_stream_add_destroy_callback
<span class="lineNum">      71 </span><span class="lineCov">         30 : void i_stream_add_destroy_callback(struct istream *stream,</span>
<span class="lineNum">      72 </span>            :                    istream_callback_t *callback, void *context)
<span class="lineNum">      73 </span>            : {
<span class="lineNum">      74 </span><span class="lineCov">         30 :     io_stream_add_destroy_callback(&amp;stream-&gt;real_stream-&gt;iostream,</span>
<span class="lineNum">      75 </span>            :                        callback, context);
<a name="76"><span class="lineNum">      76 </span><span class="lineCov">         30 : }</span></a>
<span class="lineNum">      77 </span>            : 
<span class="lineNum">      78 </span><span class="lineNoCov">          0 : void i_stream_remove_destroy_callback(struct istream *stream,</span>
<span class="lineNum">      79 </span>            :                       void (*callback)())
<span class="lineNum">      80 </span>            : {
<span class="lineNum">      81 </span><span class="lineNoCov">          0 :     io_stream_remove_destroy_callback(&amp;stream-&gt;real_stream-&gt;iostream,</span>
<span class="lineNum">      82 </span>            :                       callback);
<a name="83"><span class="lineNum">      83 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">      84 </span>            : 
<span class="lineNum">      85 </span><span class="lineCov">      36317 : int i_stream_get_fd(struct istream *stream)</span>
<span class="lineNum">      86 </span>            : {
<span class="lineNum">      87 </span><span class="lineCov">      36317 :     struct istream_private *_stream = stream-&gt;real_stream;</span>
<span class="lineNum">      88 </span>            : 
<span class="lineNum">      89 </span><span class="lineCov">      36317 :     return _stream-&gt;fd;</span>
<a name="90"><span class="lineNum">      90 </span>            : }</a>
<span class="lineNum">      91 </span>            : 
<span class="lineNum">      92 </span><span class="lineCov">        137 : const char *i_stream_get_error(struct istream *stream)</span>
<span class="lineNum">      93 </span>            : {
<span class="lineNum">      94 </span>            :     struct istream *s;
<span class="lineNum">      95 </span>            : 
<span class="lineNum">      96 </span>            :     /* we'll only return errors for streams that have stream_errno set or
<span class="lineNum">      97 </span>            :        that have reached EOF. we might be returning unintended error
<span class="lineNum">      98 </span>            :        otherwise. */
<span class="lineNum">      99 </span><span class="lineCov">        137 :     if (stream-&gt;stream_errno == 0)</span>
<span class="lineNum">     100 </span><span class="lineNoCov">          0 :         return stream-&gt;eof ? &quot;EOF&quot; : &quot;&lt;no error&gt;&quot;;</span>
<span class="lineNum">     101 </span>            : 
<span class="lineNum">     102 </span><span class="lineCov">        140 :     for (s = stream; s != NULL; s = s-&gt;real_stream-&gt;parent) {</span>
<span class="lineNum">     103 </span><span class="lineCov">        137 :         if (s-&gt;stream_errno == 0)</span>
<span class="lineNum">     104 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">     105 </span><span class="lineCov">        137 :         if (s-&gt;real_stream-&gt;iostream.error != NULL)</span>
<span class="lineNum">     106 </span><span class="lineCov">        134 :             return s-&gt;real_stream-&gt;iostream.error;</span>
<span class="lineNum">     107 </span>            :     }
<span class="lineNum">     108 </span><span class="lineCov">          3 :     return strerror(stream-&gt;stream_errno);</span>
<a name="109"><span class="lineNum">     109 </span>            : }</a>
<span class="lineNum">     110 </span>            : 
<span class="lineNum">     111 </span><span class="lineNoCov">          0 : const char *i_stream_get_disconnect_reason(struct istream *stream)</span>
<span class="lineNum">     112 </span>            : {
<span class="lineNum">     113 </span><span class="lineNoCov">          0 :     return io_stream_get_disconnect_reason(stream, NULL);</span>
<a name="114"><span class="lineNum">     114 </span>            : }</a>
<span class="lineNum">     115 </span>            : 
<span class="lineNum">     116 </span><span class="lineCov">        129 : void i_stream_close(struct istream *stream)</span>
<span class="lineNum">     117 </span>            : {
<span class="lineNum">     118 </span><span class="lineCov">        129 :     if (stream != NULL)</span>
<span class="lineNum">     119 </span><span class="lineCov">        120 :         i_stream_close_full(stream, TRUE);</span>
<a name="120"><span class="lineNum">     120 </span><span class="lineCov">        129 : }</span></a>
<span class="lineNum">     121 </span>            : 
<span class="lineNum">     122 </span><span class="lineNoCov">          0 : void i_stream_set_init_buffer_size(struct istream *stream, size_t size)</span>
<span class="lineNum">     123 </span>            : {
<span class="lineNum">     124 </span><span class="lineNoCov">          0 :     stream-&gt;real_stream-&gt;init_buffer_size = size;</span>
<a name="125"><span class="lineNum">     125 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     126 </span>            : 
<span class="lineNum">     127 </span><span class="lineCov">       1452 : void i_stream_set_max_buffer_size(struct istream *stream, size_t max_size)</span>
<span class="lineNum">     128 </span>            : {
<span class="lineNum">     129 </span><span class="lineCov">       1452 :     io_stream_set_max_buffer_size(&amp;stream-&gt;real_stream-&gt;iostream, max_size);</span>
<a name="130"><span class="lineNum">     130 </span><span class="lineCov">       1452 : }</span></a>
<span class="lineNum">     131 </span>            : 
<span class="lineNum">     132 </span><span class="lineCov">     142424 : size_t i_stream_get_max_buffer_size(struct istream *stream)</span>
<span class="lineNum">     133 </span>            : {
<span class="lineNum">     134 </span><span class="lineCov">     142424 :     size_t max_size = 0;</span>
<span class="lineNum">     135 </span>            : 
<span class="lineNum">     136 </span>            :     do {
<span class="lineNum">     137 </span><span class="lineCov">     268614 :         if (max_size &lt; stream-&gt;real_stream-&gt;max_buffer_size)</span>
<span class="lineNum">     138 </span><span class="lineCov">     142424 :             max_size = stream-&gt;real_stream-&gt;max_buffer_size;</span>
<span class="lineNum">     139 </span><span class="lineCov">     268614 :         stream = stream-&gt;real_stream-&gt;parent;</span>
<span class="lineNum">     140 </span><span class="lineCov">     268614 :     } while (stream != NULL);</span>
<span class="lineNum">     141 </span><span class="lineCov">     142424 :     return max_size;</span>
<a name="142"><span class="lineNum">     142 </span>            : }</a>
<span class="lineNum">     143 </span>            : 
<span class="lineNum">     144 </span><span class="lineCov">          1 : void i_stream_set_return_partial_line(struct istream *stream, bool set)</span>
<span class="lineNum">     145 </span>            : {
<span class="lineNum">     146 </span><span class="lineCov">          1 :     stream-&gt;real_stream-&gt;return_nolf_line = set;</span>
<a name="147"><span class="lineNum">     147 </span><span class="lineCov">          1 : }</span></a>
<span class="lineNum">     148 </span>            : 
<span class="lineNum">     149 </span><span class="lineNoCov">          0 : void i_stream_set_persistent_buffers(struct istream *stream, bool set)</span>
<span class="lineNum">     150 </span>            : {
<span class="lineNum">     151 </span>            :     do {
<span class="lineNum">     152 </span><span class="lineNoCov">          0 :         stream-&gt;real_stream-&gt;nonpersistent_buffers = !set;</span>
<span class="lineNum">     153 </span><span class="lineNoCov">          0 :         stream = stream-&gt;real_stream-&gt;parent;</span>
<span class="lineNum">     154 </span><span class="lineNoCov">          0 :     } while (stream != NULL);</span>
<a name="155"><span class="lineNum">     155 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     156 </span>            : 
<span class="lineNum">     157 </span><span class="lineCov">          2 : void i_stream_set_blocking(struct istream *stream, bool blocking)</span>
<span class="lineNum">     158 </span>            : {
<span class="lineNum">     159 </span><span class="lineCov">          2 :     int prev_fd = -1;</span>
<span class="lineNum">     160 </span>            : 
<span class="lineNum">     161 </span>            :     do {
<span class="lineNum">     162 </span><span class="lineCov">          2 :         stream-&gt;blocking = blocking;</span>
<span class="lineNum">     163 </span><span class="lineCov">          4 :         if (stream-&gt;real_stream-&gt;fd != -1 &amp;&amp;</span>
<span class="lineNum">     164 </span><span class="lineCov">          2 :             stream-&gt;real_stream-&gt;fd != prev_fd) {</span>
<span class="lineNum">     165 </span><span class="lineCov">          2 :             fd_set_nonblock(stream-&gt;real_stream-&gt;fd, !blocking);</span>
<span class="lineNum">     166 </span><span class="lineCov">          2 :             prev_fd = stream-&gt;real_stream-&gt;fd;</span>
<span class="lineNum">     167 </span>            :         }
<span class="lineNum">     168 </span><span class="lineCov">          2 :         stream = stream-&gt;real_stream-&gt;parent;</span>
<span class="lineNum">     169 </span><span class="lineCov">          2 :     } while (stream != NULL);</span>
<a name="170"><span class="lineNum">     170 </span><span class="lineCov">          2 : }</span></a>
<span class="lineNum">     171 </span>            : 
<span class="lineNum">     172 </span><span class="lineCov">    1568405 : static void i_stream_update(struct istream_private *stream)</span>
<span class="lineNum">     173 </span>            : {
<span class="lineNum">     174 </span><span class="lineCov">    1568405 :     if (stream-&gt;parent == NULL)</span>
<span class="lineNum">     175 </span><span class="lineCov">    1197656 :         stream-&gt;access_counter++;</span>
<span class="lineNum">     176 </span>            :     else {
<span class="lineNum">     177 </span><span class="lineCov">     370749 :         stream-&gt;access_counter =</span>
<span class="lineNum">     178 </span><span class="lineCov">     370749 :             stream-&gt;parent-&gt;real_stream-&gt;access_counter;</span>
<span class="lineNum">     179 </span><span class="lineCov">     370749 :         stream-&gt;parent_expected_offset = stream-&gt;parent-&gt;v_offset;</span>
<span class="lineNum">     180 </span>            :     }
<a name="181"><span class="lineNum">     181 </span><span class="lineCov">    1568405 : }</span></a>
<span class="lineNum">     182 </span>            : 
<span class="lineNum">     183 </span><span class="lineCov">     954206 : static bool snapshot_has_memarea(struct istream_snapshot *snapshot,</span>
<span class="lineNum">     184 </span>            :                  struct memarea *memarea)
<span class="lineNum">     185 </span>            : {
<span class="lineNum">     186 </span><span class="lineCov">     954206 :     if (snapshot-&gt;old_memarea == memarea)</span>
<span class="lineNum">     187 </span><span class="lineCov">     188519 :         return TRUE;</span>
<span class="lineNum">     188 </span><span class="lineCov">     765687 :     if (snapshot-&gt;prev_snapshot != NULL)</span>
<span class="lineNum">     189 </span><span class="lineCov">     721889 :         return snapshot_has_memarea(snapshot-&gt;prev_snapshot, memarea);</span>
<span class="lineNum">     190 </span><span class="lineCov">      43798 :     return FALSE;</span>
<span class="lineNum">     191 </span>            : }
<a name="192"><span class="lineNum">     192 </span>            : </a>
<span class="lineNum">     193 </span>            : struct istream_snapshot *
<span class="lineNum">     194 </span><span class="lineCov">     706614 : i_stream_default_snapshot(struct istream_private *stream,</span>
<span class="lineNum">     195 </span>            :               struct istream_snapshot *prev_snapshot)
<span class="lineNum">     196 </span>            : {
<span class="lineNum">     197 </span>            :     struct istream_snapshot *snapshot;
<span class="lineNum">     198 </span>            : 
<span class="lineNum">     199 </span><span class="lineCov">     706614 :     if (stream-&gt;memarea != NULL) {</span>
<span class="lineNum">     200 </span><span class="lineCov">     488805 :         if (prev_snapshot != NULL) {</span>
<span class="lineNum">     201 </span><span class="lineCov">     232317 :             if (snapshot_has_memarea(prev_snapshot, stream-&gt;memarea))</span>
<span class="lineNum">     202 </span><span class="lineCov">     188519 :                 return prev_snapshot;</span>
<span class="lineNum">     203 </span>            :         }
<span class="lineNum">     204 </span>            :         /* This stream has a memarea. Reference it, so we can later on
<span class="lineNum">     205 </span>            :            rollback if needed. */
<span class="lineNum">     206 </span><span class="lineCov">     300286 :         snapshot = i_new(struct istream_snapshot, 1);</span>
<span class="lineNum">     207 </span><span class="lineCov">     300286 :         snapshot-&gt;old_memarea = stream-&gt;memarea;</span>
<span class="lineNum">     208 </span><span class="lineCov">     300286 :         snapshot-&gt;prev_snapshot = prev_snapshot;</span>
<span class="lineNum">     209 </span><span class="lineCov">     300286 :         memarea_ref(snapshot-&gt;old_memarea);</span>
<span class="lineNum">     210 </span><span class="lineCov">     300286 :         return snapshot;</span>
<span class="lineNum">     211 </span>            :     }
<span class="lineNum">     212 </span><span class="lineCov">     217809 :     if (stream-&gt;parent == NULL) {</span>
<span class="lineNum">     213 </span><span class="lineNoCov">          0 :         if (stream-&gt;nonpersistent_buffers) {</span>
<span class="lineNum">     214 </span>            :             /* Assume that memarea would be used normally, but
<span class="lineNum">     215 </span>            :                now it's NULL because the buffer is empty and
<span class="lineNum">     216 </span>            :                empty buffers are freed. */
<span class="lineNum">     217 </span><span class="lineNoCov">          0 :             i_assert(stream-&gt;skip == stream-&gt;pos);</span>
<span class="lineNum">     218 </span><span class="lineNoCov">          0 :             return prev_snapshot;</span>
<span class="lineNum">     219 </span>            :         }
<span class="lineNum">     220 </span><span class="lineNoCov">          0 :         i_panic(&quot;%s is missing istream.snapshot() implementation&quot;,</span>
<span class="lineNum">     221 </span>            :             i_stream_get_name(&amp;stream-&gt;istream));
<span class="lineNum">     222 </span>            :     }
<span class="lineNum">     223 </span><span class="lineCov">     217809 :     struct istream_private *_parent_stream =</span>
<span class="lineNum">     224 </span><span class="lineCov">     217809 :         stream-&gt;parent-&gt;real_stream;</span>
<span class="lineNum">     225 </span><span class="lineCov">     217809 :     return _parent_stream-&gt;snapshot(_parent_stream, prev_snapshot);</span>
<a name="226"><span class="lineNum">     226 </span>            : }</a>
<span class="lineNum">     227 </span>            : 
<span class="lineNum">     228 </span><span class="lineCov">     693026 : void i_stream_snapshot_free(struct istream_snapshot **_snapshot)</span>
<span class="lineNum">     229 </span>            : {
<span class="lineNum">     230 </span><span class="lineCov">     693026 :     struct istream_snapshot *snapshot = *_snapshot;</span>
<span class="lineNum">     231 </span>            : 
<span class="lineNum">     232 </span><span class="lineCov">     693026 :     if (*_snapshot == NULL)</span>
<span class="lineNum">     233 </span><span class="lineCov">    1085766 :         return;</span>
<span class="lineNum">     234 </span><span class="lineCov">     300286 :     *_snapshot = NULL;</span>
<span class="lineNum">     235 </span>            : 
<span class="lineNum">     236 </span><span class="lineCov">     300286 :     i_stream_snapshot_free(&amp;snapshot-&gt;prev_snapshot);</span>
<span class="lineNum">     237 </span><span class="lineCov">     300286 :     if (snapshot-&gt;old_memarea != NULL)</span>
<span class="lineNum">     238 </span><span class="lineCov">     300286 :         memarea_unref(&amp;snapshot-&gt;old_memarea);</span>
<span class="lineNum">     239 </span><span class="lineCov">     300286 :     i_free(snapshot);</span>
<span class="lineNum">     240 </span>            : }
<a name="241"><span class="lineNum">     241 </span>            : </a>
<span class="lineNum">     242 </span>            : static struct istream_snapshot *
<span class="lineNum">     243 </span><span class="lineCov">     125140 : i_stream_noop_snapshot(struct istream_private *stream ATTR_UNUSED,</span>
<span class="lineNum">     244 </span>            :                struct istream_snapshot *prev_snapshot)
<span class="lineNum">     245 </span>            : {
<span class="lineNum">     246 </span><span class="lineCov">     125140 :     return prev_snapshot;</span>
<a name="247"><span class="lineNum">     247 </span>            : }</a>
<span class="lineNum">     248 </span>            : 
<span class="lineNum">     249 </span><span class="lineCov">     613945 : ssize_t i_stream_read(struct istream *stream)</span>
<span class="lineNum">     250 </span>            : {
<span class="lineNum">     251 </span><span class="lineCov">     613945 :     struct istream_private *_stream = stream-&gt;real_stream;</span>
<span class="lineNum">     252 </span>            :     ssize_t ret;
<span class="lineNum">     253 </span>            : #ifdef DEBUG
<span class="lineNum">     254 </span>            :     unsigned char prev_buf[4];
<span class="lineNum">     255 </span>            :     const unsigned char *prev_data = _stream-&gt;buffer;
<span class="lineNum">     256 </span>            :     size_t prev_skip = _stream-&gt;skip, prev_pos = _stream-&gt;pos;
<span class="lineNum">     257 </span>            :     bool invalid = i_stream_is_buffer_invalid(_stream);
<span class="lineNum">     258 </span>            : 
<span class="lineNum">     259 </span>            :     i_assert(prev_skip &lt;= prev_pos);
<span class="lineNum">     260 </span>            :     if (invalid)
<span class="lineNum">     261 </span>            :         ;
<span class="lineNum">     262 </span>            :     else if (prev_pos - prev_skip &lt;= 4)
<span class="lineNum">     263 </span>            :         memcpy(prev_buf, prev_data + prev_skip, prev_pos - prev_skip);
<span class="lineNum">     264 </span>            :     else {
<span class="lineNum">     265 </span>            :         memcpy(prev_buf, prev_data + prev_skip, 2);
<span class="lineNum">     266 </span>            :         memcpy(prev_buf+2, prev_data + prev_pos - 2, 2);
<span class="lineNum">     267 </span>            :     }
<span class="lineNum">     268 </span>            : #endif
<span class="lineNum">     269 </span>            : 
<span class="lineNum">     270 </span><span class="lineCov">     613945 :     _stream-&gt;prev_snapshot =</span>
<span class="lineNum">     271 </span><span class="lineCov">     613945 :         _stream-&gt;snapshot(_stream, _stream-&gt;prev_snapshot);</span>
<span class="lineNum">     272 </span><span class="lineCov">     613945 :     ret = i_stream_read_memarea(stream);</span>
<span class="lineNum">     273 </span><span class="lineCov">     613945 :     if (ret &gt; 0)</span>
<span class="lineNum">     274 </span><span class="lineCov">     318583 :         i_stream_snapshot_free(&amp;_stream-&gt;prev_snapshot);</span>
<span class="lineNum">     275 </span>            : #ifdef DEBUG
<span class="lineNum">     276 </span>            :     else if (!invalid) {
<span class="lineNum">     277 </span>            :         i_assert((_stream-&gt;pos - _stream-&gt;skip) == (prev_pos - prev_skip));
<span class="lineNum">     278 </span>            :         if (prev_pos - prev_skip &lt;= 4)
<span class="lineNum">     279 </span>            :             i_assert(memcmp(prev_buf, prev_data + prev_skip, prev_pos - prev_skip) == 0);
<span class="lineNum">     280 </span>            :         else {
<span class="lineNum">     281 </span>            :             i_assert(memcmp(prev_buf, prev_data + prev_skip, 2) == 0);
<span class="lineNum">     282 </span>            :             i_assert(memcmp(prev_buf+2, prev_data + prev_pos - 2, 2) == 0);
<span class="lineNum">     283 </span>            :         }
<span class="lineNum">     284 </span>            :     }
<span class="lineNum">     285 </span>            : #endif
<span class="lineNum">     286 </span><span class="lineCov">     613945 :     return ret;</span>
<a name="287"><span class="lineNum">     287 </span>            : }</a>
<span class="lineNum">     288 </span>            : 
<span class="lineNum">     289 </span><span class="lineCov">    1023479 : ssize_t i_stream_read_memarea(struct istream *stream)</span>
<span class="lineNum">     290 </span>            : {
<span class="lineNum">     291 </span><span class="lineCov">    1023479 :     struct istream_private *_stream = stream-&gt;real_stream;</span>
<span class="lineNum">     292 </span>            :     size_t old_size;
<span class="lineNum">     293 </span>            :     ssize_t ret;
<span class="lineNum">     294 </span>            : 
<span class="lineNum">     295 </span><span class="lineCov">    1023479 :     if (unlikely(stream-&gt;closed || stream-&gt;stream_errno != 0)) {</span>
<span class="lineNum">     296 </span><span class="lineCov">        121 :         stream-&gt;eof = TRUE;</span>
<span class="lineNum">     297 </span><span class="lineCov">        121 :         errno = stream-&gt;stream_errno;</span>
<span class="lineNum">     298 </span><span class="lineCov">        121 :         return -1;</span>
<span class="lineNum">     299 </span>            :     }
<span class="lineNum">     300 </span>            : 
<span class="lineNum">     301 </span><span class="lineCov">    1023358 :     stream-&gt;eof = FALSE;</span>
<span class="lineNum">     302 </span>            : 
<span class="lineNum">     303 </span><span class="lineCov">    1023358 :     if (_stream-&gt;parent != NULL)</span>
<span class="lineNum">     304 </span><span class="lineCov">     339437 :         i_stream_seek(_stream-&gt;parent, _stream-&gt;parent_expected_offset);</span>
<span class="lineNum">     305 </span>            : 
<span class="lineNum">     306 </span><span class="lineCov">    1023358 :     old_size = _stream-&gt;pos - _stream-&gt;skip;</span>
<span class="lineNum">     307 </span><span class="lineCov">    1023358 :     ret = _stream-&gt;read(_stream);</span>
<span class="lineNum">     308 </span><span class="lineCov">    1023358 :     i_assert(old_size &lt;= _stream-&gt;pos - _stream-&gt;skip);</span>
<span class="lineNum">     309 </span><span class="lineCov">    1023358 :     switch (ret) {</span>
<span class="lineNum">     310 </span>            :     case -2:
<span class="lineNum">     311 </span><span class="lineCov">      47794 :         i_assert(_stream-&gt;skip != _stream-&gt;pos);</span>
<span class="lineNum">     312 </span><span class="lineCov">      47794 :         break;</span>
<span class="lineNum">     313 </span>            :     case -1:
<span class="lineNum">     314 </span><span class="lineCov">     144018 :         if (stream-&gt;stream_errno != 0) {</span>
<span class="lineNum">     315 </span>            :             /* error handling should be easier if we now just
<span class="lineNum">     316 </span>            :                assume the stream is now at EOF */
<span class="lineNum">     317 </span><span class="lineCov">        802 :             stream-&gt;eof = TRUE;</span>
<span class="lineNum">     318 </span><span class="lineCov">        802 :             errno = stream-&gt;stream_errno;</span>
<span class="lineNum">     319 </span>            :         } else {
<span class="lineNum">     320 </span><span class="lineCov">     143216 :             i_assert(stream-&gt;eof);</span>
<span class="lineNum">     321 </span><span class="lineCov">     143216 :             i_assert(old_size == _stream-&gt;pos - _stream-&gt;skip);</span>
<span class="lineNum">     322 </span>            :         }
<span class="lineNum">     323 </span><span class="lineCov">     144018 :         break;</span>
<span class="lineNum">     324 </span>            :     case 0:
<span class="lineNum">     325 </span><span class="lineCov">     316688 :         i_assert(!stream-&gt;blocking);</span>
<span class="lineNum">     326 </span><span class="lineCov">     316688 :         break;</span>
<span class="lineNum">     327 </span>            :     default:
<span class="lineNum">     328 </span><span class="lineCov">     514858 :         i_assert(ret &gt; 0);</span>
<span class="lineNum">     329 </span><span class="lineCov">     514858 :         i_assert(_stream-&gt;skip &lt; _stream-&gt;pos);</span>
<span class="lineNum">     330 </span><span class="lineCov">     514858 :         i_assert((size_t)ret+old_size == _stream-&gt;pos - _stream-&gt;skip);</span>
<span class="lineNum">     331 </span><span class="lineCov">     514858 :         _stream-&gt;last_read_timeval = ioloop_timeval;</span>
<span class="lineNum">     332 </span><span class="lineCov">     514858 :         break;</span>
<span class="lineNum">     333 </span>            :     }
<span class="lineNum">     334 </span>            : 
<span class="lineNum">     335 </span><span class="lineCov">    1023358 :     if (stream-&gt;stream_errno != 0) {</span>
<span class="lineNum">     336 </span>            :         /* error handling should be easier if we now just
<span class="lineNum">     337 </span>            :            assume the stream is now at EOF. Note that we could get here
<span class="lineNum">     338 </span>            :            even if read() didn't return -1, although that's a little
<span class="lineNum">     339 </span>            :            bit sloppy istream implementation. */
<span class="lineNum">     340 </span><span class="lineCov">        802 :         stream-&gt;eof = TRUE;</span>
<span class="lineNum">     341 </span>            :     }
<span class="lineNum">     342 </span>            : 
<span class="lineNum">     343 </span><span class="lineCov">    1023358 :     i_stream_update(_stream);</span>
<span class="lineNum">     344 </span>            :     /* verify that parents' access_counters are valid. the parent's
<span class="lineNum">     345 </span>            :        i_stream_read() should guarantee this. */
<span class="lineNum">     346 </span><span class="lineCov">    1023358 :     i_assert(!i_stream_is_buffer_invalid(_stream));</span>
<span class="lineNum">     347 </span><span class="lineCov">    1023358 :     return ret;</span>
<a name="348"><span class="lineNum">     348 </span>            : }</a>
<span class="lineNum">     349 </span>            : 
<span class="lineNum">     350 </span><span class="lineCov">      20565 : int i_stream_read_more_memarea(struct istream *stream,</span>
<span class="lineNum">     351 </span>            :                    const unsigned char **data_r, size_t *size_r)
<span class="lineNum">     352 </span>            : {
<span class="lineNum">     353 </span><span class="lineCov">      20565 :     *data_r = i_stream_get_data(stream, size_r);</span>
<span class="lineNum">     354 </span><span class="lineCov">      20565 :     if (*size_r &gt; 0)</span>
<span class="lineNum">     355 </span><span class="lineNoCov">          0 :         return 1;</span>
<span class="lineNum">     356 </span>            : 
<span class="lineNum">     357 </span><span class="lineCov">      20565 :     int ret = i_stream_read_memarea(stream);</span>
<span class="lineNum">     358 </span><span class="lineCov">      20565 :     *data_r = i_stream_get_data(stream, size_r);</span>
<span class="lineNum">     359 </span><span class="lineCov">      20565 :     return ret;</span>
<a name="360"><span class="lineNum">     360 </span>            : }</a>
<span class="lineNum">     361 </span>            : 
<span class="lineNum">     362 </span><span class="lineNoCov">          0 : void i_stream_get_last_read_time(struct istream *stream, struct timeval *tv_r)</span>
<span class="lineNum">     363 </span>            : {
<span class="lineNum">     364 </span><span class="lineNoCov">          0 :     *tv_r = stream-&gt;real_stream-&gt;last_read_timeval;</span>
<a name="365"><span class="lineNum">     365 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     366 </span>            : 
<span class="lineNum">     367 </span><span class="lineCov">        347 : ssize_t i_stream_read_copy_from_parent(struct istream *istream)</span>
<span class="lineNum">     368 </span>            : {
<span class="lineNum">     369 </span><span class="lineCov">        347 :     struct istream_private *stream = istream-&gt;real_stream;</span>
<span class="lineNum">     370 </span>            :     size_t pos;
<span class="lineNum">     371 </span>            :     ssize_t ret;
<span class="lineNum">     372 </span>            : 
<span class="lineNum">     373 </span><span class="lineCov">        347 :     stream-&gt;pos -= stream-&gt;skip;</span>
<span class="lineNum">     374 </span><span class="lineCov">        347 :     stream-&gt;skip = 0;</span>
<span class="lineNum">     375 </span>            : 
<span class="lineNum">     376 </span><span class="lineCov">        347 :     stream-&gt;buffer = i_stream_get_data(stream-&gt;parent, &amp;pos);</span>
<span class="lineNum">     377 </span><span class="lineCov">        347 :     if (pos &gt; stream-&gt;pos)</span>
<span class="lineNum">     378 </span><span class="lineCov">        267 :         ret = 0;</span>
<span class="lineNum">     379 </span>            :     else do {
<span class="lineNum">     380 </span><span class="lineCov">         80 :         if ((ret = i_stream_read_memarea(stream-&gt;parent)) == -2) {</span>
<span class="lineNum">     381 </span><span class="lineNoCov">          0 :             i_stream_update(stream);</span>
<span class="lineNum">     382 </span><span class="lineNoCov">          0 :             return -2;</span>
<span class="lineNum">     383 </span>            :         }
<span class="lineNum">     384 </span>            : 
<span class="lineNum">     385 </span><span class="lineCov">         80 :         stream-&gt;istream.stream_errno = stream-&gt;parent-&gt;stream_errno;</span>
<span class="lineNum">     386 </span><span class="lineCov">         80 :         stream-&gt;istream.eof = stream-&gt;parent-&gt;eof;</span>
<span class="lineNum">     387 </span><span class="lineCov">         80 :         stream-&gt;buffer = i_stream_get_data(stream-&gt;parent, &amp;pos);</span>
<span class="lineNum">     388 </span>            :         /* check again, in case the parent stream had been seeked
<span class="lineNum">     389 </span>            :            backwards and the previous read() didn't get us far
<span class="lineNum">     390 </span>            :            enough. */
<span class="lineNum">     391 </span><span class="lineCov">         80 :     } while (pos &lt;= stream-&gt;pos &amp;&amp; ret &gt; 0);</span>
<span class="lineNum">     392 </span>            : 
<span class="lineNum">     393 </span><span class="lineCov">        347 :     ret = pos &gt; stream-&gt;pos ? (ssize_t)(pos - stream-&gt;pos) :</span>
<span class="lineNum">     394 </span>            :         (ret == 0 ? 0 : -1);
<span class="lineNum">     395 </span><span class="lineCov">        347 :     stream-&gt;pos = pos;</span>
<span class="lineNum">     396 </span><span class="lineCov">        347 :     i_assert(ret != -1 || stream-&gt;istream.eof ||</span>
<span class="lineNum">     397 </span>            :          stream-&gt;istream.stream_errno != 0);
<span class="lineNum">     398 </span><span class="lineCov">        347 :     i_stream_update(stream);</span>
<span class="lineNum">     399 </span><span class="lineCov">        347 :     return ret;</span>
<a name="400"><span class="lineNum">     400 </span>            : }</a>
<span class="lineNum">     401 </span>            : 
<span class="lineNum">     402 </span><span class="lineCov">      73053 : void i_stream_free_buffer(struct istream_private *stream)</span>
<span class="lineNum">     403 </span>            : {
<span class="lineNum">     404 </span><span class="lineCov">      73053 :     if (stream-&gt;memarea != NULL) {</span>
<span class="lineNum">     405 </span><span class="lineCov">      36078 :         memarea_unref(&amp;stream-&gt;memarea);</span>
<span class="lineNum">     406 </span><span class="lineCov">      36078 :         stream-&gt;w_buffer = NULL;</span>
<span class="lineNum">     407 </span><span class="lineCov">      36975 :     } else if (stream-&gt;w_buffer != NULL) {</span>
<span class="lineNum">     408 </span><span class="lineNoCov">          0 :         i_free_and_null(stream-&gt;w_buffer);</span>
<span class="lineNum">     409 </span>            :     } else {
<span class="lineNum">     410 </span>            :         /* don't know how to free it */
<span class="lineNum">     411 </span><span class="lineCov">     110028 :         return;</span>
<span class="lineNum">     412 </span>            :     }
<span class="lineNum">     413 </span><span class="lineCov">      36078 :     stream-&gt;buffer_size = 0;</span>
<a name="414"><span class="lineNum">     414 </span>            : }</a>
<span class="lineNum">     415 </span>            : 
<span class="lineNum">     416 </span><span class="lineCov">     928241 : void i_stream_skip(struct istream *stream, uoff_t count)</span>
<span class="lineNum">     417 </span>            : {
<span class="lineNum">     418 </span><span class="lineCov">     928241 :     struct istream_private *_stream = stream-&gt;real_stream;</span>
<span class="lineNum">     419 </span>            :     size_t data_size;
<span class="lineNum">     420 </span>            : 
<span class="lineNum">     421 </span><span class="lineCov">     928241 :     data_size = _stream-&gt;pos - _stream-&gt;skip;</span>
<span class="lineNum">     422 </span><span class="lineCov">     928241 :     if (count &lt;= data_size) {</span>
<span class="lineNum">     423 </span>            :         /* within buffer */
<span class="lineNum">     424 </span><span class="lineCov">     851701 :         stream-&gt;v_offset += count;</span>
<span class="lineNum">     425 </span><span class="lineCov">     851701 :         _stream-&gt;skip += count;</span>
<span class="lineNum">     426 </span><span class="lineCov">     851701 :         if (_stream-&gt;nonpersistent_buffers &amp;&amp;</span>
<span class="lineNum">     427 </span><span class="lineNoCov">          0 :             _stream-&gt;skip == _stream-&gt;pos) {</span>
<span class="lineNum">     428 </span><span class="lineNoCov">          0 :             _stream-&gt;skip = _stream-&gt;pos = 0;</span>
<span class="lineNum">     429 </span><span class="lineNoCov">          0 :             i_stream_free_buffer(_stream);</span>
<span class="lineNum">     430 </span>            :         }
<span class="lineNum">     431 </span><span class="lineCov">     851701 :         return;</span>
<span class="lineNum">     432 </span>            :     }
<span class="lineNum">     433 </span>            : 
<span class="lineNum">     434 </span>            :     /* have to seek forward */
<span class="lineNum">     435 </span><span class="lineCov">      76540 :     count -= data_size;</span>
<span class="lineNum">     436 </span><span class="lineCov">      76540 :     _stream-&gt;skip = _stream-&gt;pos;</span>
<span class="lineNum">     437 </span><span class="lineCov">      76540 :     stream-&gt;v_offset += data_size;</span>
<span class="lineNum">     438 </span>            : 
<span class="lineNum">     439 </span><span class="lineCov">      76540 :     if (unlikely(stream-&gt;closed || stream-&gt;stream_errno != 0))</span>
<span class="lineNum">     440 </span><span class="lineNoCov">          0 :         return;</span>
<span class="lineNum">     441 </span>            : 
<span class="lineNum">     442 </span><span class="lineCov">      76540 :     _stream-&gt;seek(_stream, stream-&gt;v_offset + count, FALSE);</span>
<a name="443"><span class="lineNum">     443 </span>            : }</a>
<span class="lineNum">     444 </span>            : 
<span class="lineNum">     445 </span><span class="lineCov">     471209 : static bool i_stream_can_optimize_seek(struct istream_private *stream)</span>
<span class="lineNum">     446 </span>            : {
<span class="lineNum">     447 </span><span class="lineCov">     471209 :     if (stream-&gt;parent == NULL)</span>
<span class="lineNum">     448 </span><span class="lineCov">     455938 :         return TRUE;</span>
<span class="lineNum">     449 </span>            : 
<span class="lineNum">     450 </span>            :     /* use the fast route only if the parent stream hasn't been changed */
<span class="lineNum">     451 </span><span class="lineCov">      30542 :     if (stream-&gt;access_counter !=</span>
<span class="lineNum">     452 </span><span class="lineCov">      15271 :         stream-&gt;parent-&gt;real_stream-&gt;access_counter)</span>
<span class="lineNum">     453 </span><span class="lineCov">       9326 :         return FALSE;</span>
<span class="lineNum">     454 </span>            : 
<span class="lineNum">     455 </span><span class="lineCov">       5945 :     return i_stream_can_optimize_seek(stream-&gt;parent-&gt;real_stream);</span>
<a name="456"><span class="lineNum">     456 </span>            : }</a>
<span class="lineNum">     457 </span>            : 
<span class="lineNum">     458 </span><span class="lineCov">     544047 : void i_stream_seek(struct istream *stream, uoff_t v_offset)</span>
<span class="lineNum">     459 </span>            : {
<span class="lineNum">     460 </span><span class="lineCov">     544047 :     struct istream_private *_stream = stream-&gt;real_stream;</span>
<span class="lineNum">     461 </span>            : 
<span class="lineNum">     462 </span><span class="lineCov">    1009311 :     if (v_offset &gt;= stream-&gt;v_offset &amp;&amp;</span>
<span class="lineNum">     463 </span><span class="lineCov">     465264 :         i_stream_can_optimize_seek(_stream))</span>
<span class="lineNum">     464 </span><span class="lineCov">     455938 :         i_stream_skip(stream, v_offset - stream-&gt;v_offset);</span>
<span class="lineNum">     465 </span>            :     else {
<span class="lineNum">     466 </span><span class="lineCov">      88109 :         if (unlikely(stream-&gt;closed || stream-&gt;stream_errno != 0)) {</span>
<span class="lineNum">     467 </span><span class="lineNoCov">          0 :             stream-&gt;eof = TRUE;</span>
<span class="lineNum">     468 </span><span class="lineCov">     544047 :             return;</span>
<span class="lineNum">     469 </span>            :         }
<span class="lineNum">     470 </span><span class="lineCov">      88109 :         stream-&gt;eof = FALSE;</span>
<span class="lineNum">     471 </span><span class="lineCov">      88109 :         _stream-&gt;seek(_stream, v_offset, FALSE);</span>
<span class="lineNum">     472 </span>            :     }
<span class="lineNum">     473 </span><span class="lineCov">     544047 :     i_stream_update(_stream);</span>
<a name="474"><span class="lineNum">     474 </span>            : }</a>
<span class="lineNum">     475 </span>            : 
<span class="lineNum">     476 </span><span class="lineNoCov">          0 : void i_stream_seek_mark(struct istream *stream, uoff_t v_offset)</span>
<span class="lineNum">     477 </span>            : {
<span class="lineNum">     478 </span><span class="lineNoCov">          0 :     struct istream_private *_stream = stream-&gt;real_stream;</span>
<span class="lineNum">     479 </span>            : 
<span class="lineNum">     480 </span><span class="lineNoCov">          0 :     if (unlikely(stream-&gt;closed || stream-&gt;stream_errno != 0))</span>
<span class="lineNum">     481 </span><span class="lineNoCov">          0 :         return;</span>
<span class="lineNum">     482 </span>            : 
<span class="lineNum">     483 </span><span class="lineNoCov">          0 :     stream-&gt;eof = FALSE;</span>
<span class="lineNum">     484 </span><span class="lineNoCov">          0 :     _stream-&gt;seek(_stream, v_offset, TRUE);</span>
<span class="lineNum">     485 </span><span class="lineNoCov">          0 :     i_stream_update(_stream);</span>
<a name="486"><span class="lineNum">     486 </span>            : }</a>
<span class="lineNum">     487 </span>            : 
<span class="lineNum">     488 </span><span class="lineCov">        653 : void i_stream_sync(struct istream *stream)</span>
<span class="lineNum">     489 </span>            : {
<span class="lineNum">     490 </span><span class="lineCov">        653 :     struct istream_private *_stream = stream-&gt;real_stream;</span>
<span class="lineNum">     491 </span>            : 
<span class="lineNum">     492 </span><span class="lineCov">        653 :     if (unlikely(stream-&gt;closed || stream-&gt;stream_errno != 0))</span>
<span class="lineNum">     493 </span><span class="lineCov">        653 :         return;</span>
<span class="lineNum">     494 </span>            : 
<span class="lineNum">     495 </span><span class="lineCov">        653 :     if (_stream-&gt;sync != NULL) {</span>
<span class="lineNum">     496 </span><span class="lineCov">        653 :         _stream-&gt;sync(_stream);</span>
<span class="lineNum">     497 </span><span class="lineCov">        653 :         i_stream_update(_stream);</span>
<span class="lineNum">     498 </span>            :     }
<a name="499"><span class="lineNum">     499 </span>            : }</a>
<span class="lineNum">     500 </span>            : 
<span class="lineNum">     501 </span><span class="lineCov">        811 : int i_stream_stat(struct istream *stream, bool exact, const struct stat **st_r)</span>
<span class="lineNum">     502 </span>            : {
<span class="lineNum">     503 </span><span class="lineCov">        811 :     struct istream_private *_stream = stream-&gt;real_stream;</span>
<span class="lineNum">     504 </span>            : 
<span class="lineNum">     505 </span><span class="lineCov">        811 :     if (unlikely(stream-&gt;closed || stream-&gt;stream_errno != 0))</span>
<span class="lineNum">     506 </span><span class="lineNoCov">          0 :         return -1;</span>
<span class="lineNum">     507 </span>            : 
<span class="lineNum">     508 </span><span class="lineCov">        811 :     if (_stream-&gt;stat(_stream, exact) &lt; 0) {</span>
<span class="lineNum">     509 </span><span class="lineNoCov">          0 :         stream-&gt;eof = TRUE;</span>
<span class="lineNum">     510 </span><span class="lineNoCov">          0 :         return -1;</span>
<span class="lineNum">     511 </span>            :     }
<span class="lineNum">     512 </span><span class="lineCov">        811 :     *st_r = &amp;_stream-&gt;statbuf;</span>
<span class="lineNum">     513 </span><span class="lineCov">        811 :     return 0;</span>
<a name="514"><span class="lineNum">     514 </span>            : }</a>
<span class="lineNum">     515 </span>            : 
<span class="lineNum">     516 </span><span class="lineCov">         42 : int i_stream_get_size(struct istream *stream, bool exact, uoff_t *size_r)</span>
<span class="lineNum">     517 </span>            : {
<span class="lineNum">     518 </span><span class="lineCov">         42 :     struct istream_private *_stream = stream-&gt;real_stream;</span>
<span class="lineNum">     519 </span>            : 
<span class="lineNum">     520 </span><span class="lineCov">         42 :     if (unlikely(stream-&gt;closed || stream-&gt;stream_errno != 0))</span>
<span class="lineNum">     521 </span><span class="lineNoCov">          0 :         return -1;</span>
<span class="lineNum">     522 </span>            : 
<span class="lineNum">     523 </span>            :     int ret;
<span class="lineNum">     524 </span><span class="lineCov">         42 :     if ((ret = _stream-&gt;get_size(_stream, exact, size_r)) &lt; 0)</span>
<span class="lineNum">     525 </span><span class="lineNoCov">          0 :         stream-&gt;eof = TRUE;</span>
<span class="lineNum">     526 </span><span class="lineCov">         42 :     return ret;</span>
<a name="527"><span class="lineNum">     527 </span>            : }</a>
<span class="lineNum">     528 </span>            : 
<span class="lineNum">     529 </span><span class="lineCov">        220 : bool i_stream_have_bytes_left(struct istream *stream)</span>
<span class="lineNum">     530 </span>            : {
<span class="lineNum">     531 </span><span class="lineCov">        220 :     return i_stream_get_data_size(stream) &gt; 0 || !stream-&gt;eof;</span>
<a name="532"><span class="lineNum">     532 </span>            : }</a>
<span class="lineNum">     533 </span>            : 
<span class="lineNum">     534 </span><span class="lineCov">         25 : bool i_stream_read_eof(struct istream *stream)</span>
<span class="lineNum">     535 </span>            : {
<span class="lineNum">     536 </span><span class="lineCov">         25 :     if (i_stream_get_data_size(stream) == 0)</span>
<span class="lineNum">     537 </span><span class="lineCov">         25 :         (void)i_stream_read(stream);</span>
<span class="lineNum">     538 </span><span class="lineCov">         25 :     return !i_stream_have_bytes_left(stream);</span>
<a name="539"><span class="lineNum">     539 </span>            : }</a>
<span class="lineNum">     540 </span>            : 
<span class="lineNum">     541 </span><span class="lineCov">         20 : uoff_t i_stream_get_absolute_offset(struct istream *stream)</span>
<span class="lineNum">     542 </span>            : {
<span class="lineNum">     543 </span><span class="lineCov">         20 :     uoff_t abs_offset = stream-&gt;v_offset;</span>
<span class="lineNum">     544 </span><span class="lineCov">         78 :     while (stream != NULL) {</span>
<span class="lineNum">     545 </span><span class="lineCov">         38 :         abs_offset += stream-&gt;real_stream-&gt;start_offset;</span>
<span class="lineNum">     546 </span><span class="lineCov">         38 :         stream = stream-&gt;real_stream-&gt;parent;</span>
<span class="lineNum">     547 </span>            :     }
<span class="lineNum">     548 </span><span class="lineCov">         20 :     return abs_offset;</span>
<a name="549"><span class="lineNum">     549 </span>            : }</a>
<span class="lineNum">     550 </span>            : 
<span class="lineNum">     551 </span><span class="lineCov">       4137 : static char *i_stream_next_line_finish(struct istream_private *stream, size_t i)</span>
<span class="lineNum">     552 </span>            : {
<span class="lineNum">     553 </span>            :     char *ret;
<span class="lineNum">     554 </span>            :     size_t end;
<span class="lineNum">     555 </span>            : 
<span class="lineNum">     556 </span><span class="lineCov">       4137 :     if (i &gt; 0 &amp;&amp; stream-&gt;buffer[i-1] == '\r') {</span>
<span class="lineNum">     557 </span><span class="lineCov">         15 :         end = i - 1;</span>
<span class="lineNum">     558 </span><span class="lineCov">         15 :         stream-&gt;line_crlf = TRUE;</span>
<span class="lineNum">     559 </span>            :     } else {
<span class="lineNum">     560 </span><span class="lineCov">       4122 :         end = i;</span>
<span class="lineNum">     561 </span><span class="lineCov">       4122 :         stream-&gt;line_crlf = FALSE;</span>
<span class="lineNum">     562 </span>            :     }
<span class="lineNum">     563 </span>            : 
<span class="lineNum">     564 </span><span class="lineCov">       4137 :     if (stream-&gt;buffer == stream-&gt;w_buffer) {</span>
<span class="lineNum">     565 </span>            :         /* modify the buffer directly */
<span class="lineNum">     566 </span><span class="lineCov">       4137 :         stream-&gt;w_buffer[end] = '\0';</span>
<span class="lineNum">     567 </span><span class="lineCov">       4137 :         ret = (char *)stream-&gt;w_buffer + stream-&gt;skip;</span>
<span class="lineNum">     568 </span>            :     } else {
<span class="lineNum">     569 </span>            :         /* use a temporary string to return it */
<span class="lineNum">     570 </span><span class="lineNoCov">          0 :         if (stream-&gt;line_str == NULL)</span>
<span class="lineNum">     571 </span><span class="lineNoCov">          0 :             stream-&gt;line_str = str_new(default_pool, 256);</span>
<span class="lineNum">     572 </span><span class="lineNoCov">          0 :         str_truncate(stream-&gt;line_str, 0);</span>
<span class="lineNum">     573 </span><span class="lineNoCov">          0 :         str_append_n(stream-&gt;line_str, stream-&gt;buffer + stream-&gt;skip,</span>
<span class="lineNum">     574 </span><span class="lineNoCov">          0 :                  end - stream-&gt;skip);</span>
<span class="lineNum">     575 </span><span class="lineNoCov">          0 :         ret = str_c_modifiable(stream-&gt;line_str);</span>
<span class="lineNum">     576 </span>            :     }
<span class="lineNum">     577 </span>            : 
<span class="lineNum">     578 </span><span class="lineCov">       4137 :     if (i &lt; stream-&gt;pos)</span>
<span class="lineNum">     579 </span><span class="lineCov">       4137 :         i++;</span>
<span class="lineNum">     580 </span><span class="lineCov">       4137 :     stream-&gt;istream.v_offset += i - stream-&gt;skip;</span>
<span class="lineNum">     581 </span><span class="lineCov">       4137 :     stream-&gt;skip = i;</span>
<span class="lineNum">     582 </span><span class="lineCov">       4137 :     return ret;</span>
<a name="583"><span class="lineNum">     583 </span>            : }</a>
<span class="lineNum">     584 </span>            : 
<span class="lineNum">     585 </span><span class="lineCov">         90 : static char *i_stream_last_line(struct istream_private *_stream)</span>
<span class="lineNum">     586 </span>            : {
<span class="lineNum">     587 </span><span class="lineCov">         90 :     if (_stream-&gt;istream.eof &amp;&amp; _stream-&gt;skip != _stream-&gt;pos &amp;&amp;</span>
<span class="lineNum">     588 </span><span class="lineNoCov">          0 :         _stream-&gt;return_nolf_line) {</span>
<span class="lineNum">     589 </span>            :         /* the last line is missing LF and we want to return it. */
<span class="lineNum">     590 </span><span class="lineNoCov">          0 :         return i_stream_next_line_finish(_stream, _stream-&gt;pos);</span>
<span class="lineNum">     591 </span>            :     }
<span class="lineNum">     592 </span><span class="lineCov">         90 :     return NULL;</span>
<a name="593"><span class="lineNum">     593 </span>            : }</a>
<span class="lineNum">     594 </span>            : 
<span class="lineNum">     595 </span><span class="lineCov">       4354 : char *i_stream_next_line(struct istream *stream)</span>
<span class="lineNum">     596 </span>            : {
<span class="lineNum">     597 </span><span class="lineCov">       4354 :     struct istream_private *_stream = stream-&gt;real_stream;</span>
<span class="lineNum">     598 </span>            :     const unsigned char *pos;
<span class="lineNum">     599 </span>            : 
<span class="lineNum">     600 </span><span class="lineCov">       4354 :     if (_stream-&gt;skip &gt;= _stream-&gt;pos)</span>
<span class="lineNum">     601 </span><span class="lineCov">        145 :         return NULL;</span>
<span class="lineNum">     602 </span>            : 
<span class="lineNum">     603 </span><span class="lineCov">       4209 :     pos = memchr(_stream-&gt;buffer + _stream-&gt;skip, '\n',</span>
<span class="lineNum">     604 </span><span class="lineCov">       4209 :              _stream-&gt;pos - _stream-&gt;skip);</span>
<span class="lineNum">     605 </span><span class="lineCov">       4209 :     if (pos != NULL) {</span>
<span class="lineNum">     606 </span><span class="lineCov">       4137 :         return i_stream_next_line_finish(_stream,</span>
<span class="lineNum">     607 </span><span class="lineCov">       4137 :                          pos - _stream-&gt;buffer);</span>
<span class="lineNum">     608 </span>            :     } else {
<span class="lineNum">     609 </span><span class="lineCov">         72 :         return i_stream_last_line(_stream);</span>
<span class="lineNum">     610 </span>            :     }
<a name="611"><span class="lineNum">     611 </span>            : }</a>
<span class="lineNum">     612 </span>            : 
<span class="lineNum">     613 </span><span class="lineCov">       3977 : char *i_stream_read_next_line(struct istream *stream)</span>
<span class="lineNum">     614 </span>            : {
<span class="lineNum">     615 </span>            :     char *line;
<span class="lineNum">     616 </span>            : 
<span class="lineNum">     617 </span>            :     for (;;) {
<span class="lineNum">     618 </span><span class="lineCov">       3977 :         line = i_stream_next_line(stream);</span>
<span class="lineNum">     619 </span><span class="lineCov">       3977 :         if (line != NULL)</span>
<span class="lineNum">     620 </span><span class="lineCov">       3911 :             break;</span>
<span class="lineNum">     621 </span>            : 
<span class="lineNum">     622 </span><span class="lineCov">         66 :         switch (i_stream_read(stream)) {</span>
<span class="lineNum">     623 </span>            :         case -2:
<span class="lineNum">     624 </span><span class="lineNoCov">          0 :             io_stream_set_error(&amp;stream-&gt;real_stream-&gt;iostream,</span>
<span class="lineNum">     625 </span>            :                 &quot;Line is too long (over %&quot;PRIuSIZE_T
<span class="lineNum">     626 </span>            :                 &quot; bytes at offset %&quot;PRIuUOFF_T&quot;)&quot;,
<span class="lineNum">     627 </span>            :                 i_stream_get_data_size(stream), stream-&gt;v_offset);
<span class="lineNum">     628 </span><span class="lineNoCov">          0 :             stream-&gt;stream_errno = errno = ENOBUFS;</span>
<span class="lineNum">     629 </span><span class="lineNoCov">          0 :             stream-&gt;eof = TRUE;</span>
<span class="lineNum">     630 </span><span class="lineNoCov">          0 :             return NULL;</span>
<span class="lineNum">     631 </span>            :         case -1:
<span class="lineNum">     632 </span><span class="lineCov">         18 :             return i_stream_last_line(stream-&gt;real_stream);</span>
<span class="lineNum">     633 </span>            :         case 0:
<span class="lineNum">     634 </span><span class="lineNoCov">          0 :             return NULL;</span>
<span class="lineNum">     635 </span>            :         }
<span class="lineNum">     636 </span><span class="lineCov">         48 :     }</span>
<span class="lineNum">     637 </span><span class="lineCov">       3911 :     return line;</span>
<a name="638"><span class="lineNum">     638 </span>            : }</a>
<span class="lineNum">     639 </span>            : 
<span class="lineNum">     640 </span><span class="lineNoCov">          0 : bool i_stream_last_line_crlf(struct istream *stream)</span>
<span class="lineNum">     641 </span>            : {
<span class="lineNum">     642 </span><span class="lineNoCov">          0 :     return stream-&gt;real_stream-&gt;line_crlf;</span>
<a name="643"><span class="lineNum">     643 </span>            : }</a>
<span class="lineNum">     644 </span>            : 
<span class="lineNum">     645 </span><span class="lineCov">    2332581 : static bool i_stream_is_buffer_invalid(const struct istream_private *stream)</span>
<span class="lineNum">     646 </span>            : {
<span class="lineNum">     647 </span><span class="lineCov">    2332581 :     if (stream-&gt;parent == NULL) {</span>
<span class="lineNum">     648 </span>            :         /* the buffer can't point to parent, because it doesn't exist */
<span class="lineNum">     649 </span><span class="lineCov">    1713668 :         return FALSE;</span>
<span class="lineNum">     650 </span>            :     }
<span class="lineNum">     651 </span><span class="lineCov">     618913 :     if (stream-&gt;w_buffer != NULL) {</span>
<span class="lineNum">     652 </span>            :         /* we can pretty safely assume that the stream is using its
<span class="lineNum">     653 </span>            :            own private buffer, so it can never become invalid. */
<span class="lineNum">     654 </span><span class="lineCov">     193757 :         return FALSE;</span>
<span class="lineNum">     655 </span>            :     }
<span class="lineNum">     656 </span><span class="lineCov">     850312 :     if (stream-&gt;access_counter !=</span>
<span class="lineNum">     657 </span><span class="lineCov">     425156 :         stream-&gt;parent-&gt;real_stream-&gt;access_counter) {</span>
<span class="lineNum">     658 </span>            :         /* parent has been modified behind this stream, we can't trust
<span class="lineNum">     659 </span>            :            that our buffer is valid */
<span class="lineNum">     660 </span><span class="lineCov">       2505 :         return TRUE;</span>
<span class="lineNum">     661 </span>            :     }
<span class="lineNum">     662 </span><span class="lineCov">     422651 :     return i_stream_is_buffer_invalid(stream-&gt;parent-&gt;real_stream);</span>
<span class="lineNum">     663 </span>            : }
<a name="664"><span class="lineNum">     664 </span>            : </a>
<span class="lineNum">     665 </span>            : const unsigned char *
<span class="lineNum">     666 </span><span class="lineCov">    1354130 : i_stream_get_data(struct istream *stream, size_t *size_r)</span>
<span class="lineNum">     667 </span>            : {
<span class="lineNum">     668 </span><span class="lineCov">    1354130 :     struct istream_private *_stream = stream-&gt;real_stream;</span>
<span class="lineNum">     669 </span>            : 
<span class="lineNum">     670 </span><span class="lineCov">    1354130 :     if (_stream-&gt;skip &gt;= _stream-&gt;pos) {</span>
<span class="lineNum">     671 </span><span class="lineCov">     467558 :         *size_r = 0;</span>
<span class="lineNum">     672 </span><span class="lineCov">     467558 :         return uchar_empty_ptr;</span>
<span class="lineNum">     673 </span>            :     }
<span class="lineNum">     674 </span>            : 
<span class="lineNum">     675 </span><span class="lineCov">     886572 :     if (i_stream_is_buffer_invalid(_stream)) {</span>
<span class="lineNum">     676 </span>            :         /* This stream may be using parent's buffer directly as
<span class="lineNum">     677 </span>            :            _stream-&gt;buffer, but the parent stream has already been
<span class="lineNum">     678 </span>            :            modified indirectly. This means that the buffer might no
<span class="lineNum">     679 </span>            :            longer point to where we assume it points to. So we'll
<span class="lineNum">     680 </span>            :            just return the stream as empty until it's read again.
<span class="lineNum">     681 </span>            : 
<span class="lineNum">     682 </span>            :            It's a bit ugly to suddenly drop data from the stream that
<span class="lineNum">     683 </span>            :            was already read, but since this happens only with shared
<span class="lineNum">     684 </span>            :            parent istreams the caller is hopefully aware enough that
<span class="lineNum">     685 </span>            :            something like this might happen. The other solutions would
<span class="lineNum">     686 </span>            :            be to a) try to automatically read the data back (but we
<span class="lineNum">     687 </span>            :            can't handle errors..) or b) always copy data to stream's
<span class="lineNum">     688 </span>            :            own buffer instead of pointing to parent's buffer (but this
<span class="lineNum">     689 </span>            :            causes data copying that is nearly always unnecessary). */
<span class="lineNum">     690 </span><span class="lineCov">       2505 :         *size_r = 0;</span>
<span class="lineNum">     691 </span>            :         /* if we had already read until EOF, mark the stream again as
<span class="lineNum">     692 </span>            :            not being at the end of file. */
<span class="lineNum">     693 </span><span class="lineCov">       2505 :         if (stream-&gt;stream_errno == 0) {</span>
<span class="lineNum">     694 </span><span class="lineCov">       2505 :             _stream-&gt;skip = _stream-&gt;pos = 0;</span>
<span class="lineNum">     695 </span><span class="lineCov">       2505 :             stream-&gt;eof = FALSE;</span>
<span class="lineNum">     696 </span>            :         }
<span class="lineNum">     697 </span><span class="lineCov">       2505 :         return uchar_empty_ptr;</span>
<span class="lineNum">     698 </span>            :     }
<span class="lineNum">     699 </span>            : 
<span class="lineNum">     700 </span><span class="lineCov">     884067 :         *size_r = _stream-&gt;pos - _stream-&gt;skip;</span>
<span class="lineNum">     701 </span><span class="lineCov">     884067 :         return _stream-&gt;buffer + _stream-&gt;skip;</span>
<a name="702"><span class="lineNum">     702 </span>            : }</a>
<span class="lineNum">     703 </span>            : 
<span class="lineNum">     704 </span><span class="lineCov">     231723 : size_t i_stream_get_data_size(struct istream *stream)</span>
<span class="lineNum">     705 </span>            : {
<span class="lineNum">     706 </span>            :     size_t size;
<span class="lineNum">     707 </span>            : 
<span class="lineNum">     708 </span><span class="lineCov">     231723 :     (void)i_stream_get_data(stream, &amp;size);</span>
<span class="lineNum">     709 </span><span class="lineCov">     231723 :     return size;</span>
<a name="710"><span class="lineNum">     710 </span>            : }</a>
<span class="lineNum">     711 </span>            : 
<span class="lineNum">     712 </span><span class="lineNoCov">          0 : unsigned char *i_stream_get_modifiable_data(struct istream *stream,</span>
<span class="lineNum">     713 </span>            :                         size_t *size_r)
<span class="lineNum">     714 </span>            : {
<span class="lineNum">     715 </span><span class="lineNoCov">          0 :     struct istream_private *_stream = stream-&gt;real_stream;</span>
<span class="lineNum">     716 </span>            : 
<span class="lineNum">     717 </span><span class="lineNoCov">          0 :     if (_stream-&gt;skip &gt;= _stream-&gt;pos || _stream-&gt;w_buffer == NULL) {</span>
<span class="lineNum">     718 </span><span class="lineNoCov">          0 :         *size_r = 0;</span>
<span class="lineNum">     719 </span><span class="lineNoCov">          0 :         return NULL;</span>
<span class="lineNum">     720 </span>            :     }
<span class="lineNum">     721 </span>            : 
<span class="lineNum">     722 </span><span class="lineNoCov">          0 :         *size_r = _stream-&gt;pos - _stream-&gt;skip;</span>
<span class="lineNum">     723 </span><span class="lineNoCov">          0 :         return _stream-&gt;w_buffer + _stream-&gt;skip;</span>
<a name="724"><span class="lineNum">     724 </span>            : }</a>
<span class="lineNum">     725 </span>            : 
<span class="lineNum">     726 </span><span class="lineCov">     146914 : int i_stream_read_data(struct istream *stream, const unsigned char **data_r,</span>
<span class="lineNum">     727 </span>            :                size_t *size_r, size_t threshold)
<span class="lineNum">     728 </span>            : {
<span class="lineNum">     729 </span><span class="lineCov">     146914 :     ssize_t ret = 0;</span>
<span class="lineNum">     730 </span><span class="lineCov">     146914 :     bool read_more = FALSE;</span>
<span class="lineNum">     731 </span>            : 
<span class="lineNum">     732 </span>            :     do {
<span class="lineNum">     733 </span><span class="lineCov">     252635 :         *data_r = i_stream_get_data(stream, size_r);</span>
<span class="lineNum">     734 </span><span class="lineCov">     252635 :         if (*size_r &gt; threshold)</span>
<span class="lineNum">     735 </span><span class="lineCov">     111110 :             return 1;</span>
<span class="lineNum">     736 </span>            : 
<span class="lineNum">     737 </span>            :         /* we need more data */
<span class="lineNum">     738 </span><span class="lineCov">     141525 :         ret = i_stream_read(stream);</span>
<span class="lineNum">     739 </span><span class="lineCov">     141525 :         if (ret &gt; 0)</span>
<span class="lineNum">     740 </span><span class="lineCov">     105721 :             read_more = TRUE;</span>
<span class="lineNum">     741 </span><span class="lineCov">     141525 :     } while (ret &gt; 0);</span>
<span class="lineNum">     742 </span>            : 
<span class="lineNum">     743 </span><span class="lineCov">      35804 :     *data_r = i_stream_get_data(stream, size_r);</span>
<span class="lineNum">     744 </span><span class="lineCov">      35804 :     if (ret == -2)</span>
<span class="lineNum">     745 </span><span class="lineCov">        301 :         return -2;</span>
<span class="lineNum">     746 </span>            : 
<span class="lineNum">     747 </span><span class="lineCov">      35503 :     if (ret == 0) {</span>
<span class="lineNum">     748 </span>            :         /* need to read more */
<span class="lineNum">     749 </span><span class="lineCov">      34645 :         i_assert(!stream-&gt;blocking);</span>
<span class="lineNum">     750 </span><span class="lineCov">      34645 :         return 0;</span>
<span class="lineNum">     751 </span>            :     }
<span class="lineNum">     752 </span><span class="lineCov">        858 :     if (stream-&gt;eof) {</span>
<span class="lineNum">     753 </span><span class="lineCov">        858 :         if (read_more) {</span>
<span class="lineNum">     754 </span>            :             /* we read at least some new data */
<span class="lineNum">     755 </span><span class="lineNoCov">          0 :             return 0;</span>
<span class="lineNum">     756 </span>            :         }
<span class="lineNum">     757 </span>            :     } else {
<span class="lineNum">     758 </span><span class="lineNoCov">          0 :         i_assert(stream-&gt;stream_errno != 0);</span>
<span class="lineNum">     759 </span>            :     }
<span class="lineNum">     760 </span><span class="lineCov">        858 :     return -1;</span>
<a name="761"><span class="lineNum">     761 </span>            : }</a>
<span class="lineNum">     762 </span>            : 
<span class="lineNum">     763 </span><span class="lineCov">      15806 : void i_stream_compress(struct istream_private *stream)</span>
<span class="lineNum">     764 </span>            : {
<span class="lineNum">     765 </span><span class="lineCov">      15806 :     i_assert(stream-&gt;memarea == NULL ||</span>
<span class="lineNum">     766 </span>            :          memarea_get_refcount(stream-&gt;memarea) == 1);
<span class="lineNum">     767 </span>            : 
<span class="lineNum">     768 </span><span class="lineCov">      15806 :     if (stream-&gt;skip != stream-&gt;pos) {</span>
<span class="lineNum">     769 </span><span class="lineCov">       4103 :         memmove(stream-&gt;w_buffer, stream-&gt;w_buffer + stream-&gt;skip,</span>
<span class="lineNum">     770 </span><span class="lineCov">       4103 :             stream-&gt;pos - stream-&gt;skip);</span>
<span class="lineNum">     771 </span>            :     }
<span class="lineNum">     772 </span><span class="lineCov">      15806 :     stream-&gt;pos -= stream-&gt;skip;</span>
<span class="lineNum">     773 </span>            : 
<span class="lineNum">     774 </span><span class="lineCov">      15806 :     stream-&gt;skip = 0;</span>
<a name="775"><span class="lineNum">     775 </span><span class="lineCov">      15806 : }</span></a>
<span class="lineNum">     776 </span>            : 
<span class="lineNum">     777 </span><span class="lineCov">      75797 : static void i_stream_w_buffer_free(void *buf)</span>
<span class="lineNum">     778 </span>            : {
<span class="lineNum">     779 </span><span class="lineCov">      75797 :     i_free(buf);</span>
<span class="lineNum">     780 </span><span class="lineCov">      75797 : }</span>
<a name="781"><span class="lineNum">     781 </span>            : </a>
<span class="lineNum">     782 </span>            : static void
<span class="lineNum">     783 </span><span class="lineCov">      75797 : i_stream_w_buffer_realloc(struct istream_private *stream, size_t old_size)</span>
<span class="lineNum">     784 </span>            : {
<span class="lineNum">     785 </span>            :     void *new_buffer;
<span class="lineNum">     786 </span>            : 
<span class="lineNum">     787 </span><span class="lineCov">     118442 :     if (stream-&gt;memarea != NULL &amp;&amp;</span>
<span class="lineNum">     788 </span><span class="lineCov">      42645 :         memarea_get_refcount(stream-&gt;memarea) == 1) {</span>
<span class="lineNum">     789 </span>            :         /* Nobody else is referencing the memarea.
<span class="lineNum">     790 </span>            :            We can just reallocate it. */
<span class="lineNum">     791 </span><span class="lineNoCov">          0 :         memarea_free_without_callback(&amp;stream-&gt;memarea);</span>
<span class="lineNum">     792 </span><span class="lineNoCov">          0 :         new_buffer = i_realloc(stream-&gt;w_buffer, old_size,</span>
<span class="lineNum">     793 </span>            :                        stream-&gt;buffer_size);
<span class="lineNum">     794 </span>            :     } else {
<span class="lineNum">     795 </span><span class="lineCov">      75797 :         new_buffer = i_malloc(stream-&gt;buffer_size);</span>
<span class="lineNum">     796 </span><span class="lineCov">      75797 :         if (old_size &gt; 0) {</span>
<span class="lineNum">     797 </span><span class="lineCov">      42229 :             i_assert(stream-&gt;w_buffer != NULL);</span>
<span class="lineNum">     798 </span><span class="lineCov">      42229 :             memcpy(new_buffer, stream-&gt;w_buffer, old_size);</span>
<span class="lineNum">     799 </span>            :         }
<span class="lineNum">     800 </span><span class="lineCov">      75797 :         if (stream-&gt;memarea != NULL)</span>
<span class="lineNum">     801 </span><span class="lineCov">      42645 :             memarea_unref(&amp;stream-&gt;memarea);</span>
<span class="lineNum">     802 </span>            :     }
<span class="lineNum">     803 </span>            : 
<span class="lineNum">     804 </span><span class="lineCov">      75797 :     stream-&gt;w_buffer = new_buffer;</span>
<span class="lineNum">     805 </span><span class="lineCov">      75797 :     stream-&gt;buffer = new_buffer;</span>
<span class="lineNum">     806 </span>            : 
<span class="lineNum">     807 </span><span class="lineCov">      75797 :     stream-&gt;memarea = memarea_init(stream-&gt;w_buffer, stream-&gt;buffer_size,</span>
<span class="lineNum">     808 </span>            :                        i_stream_w_buffer_free, new_buffer);
<a name="809"><span class="lineNum">     809 </span><span class="lineCov">      75797 : }</span></a>
<span class="lineNum">     810 </span>            : 
<span class="lineNum">     811 </span><span class="lineCov">      61144 : void i_stream_grow_buffer(struct istream_private *stream, size_t bytes)</span>
<span class="lineNum">     812 </span>            : {
<span class="lineNum">     813 </span>            :     size_t old_size, max_size;
<span class="lineNum">     814 </span>            : 
<span class="lineNum">     815 </span><span class="lineCov">      61144 :     old_size = stream-&gt;buffer_size;</span>
<span class="lineNum">     816 </span>            : 
<span class="lineNum">     817 </span><span class="lineCov">      61144 :     stream-&gt;buffer_size = stream-&gt;pos + bytes;</span>
<span class="lineNum">     818 </span><span class="lineCov">      61144 :     if (stream-&gt;buffer_size &lt;= stream-&gt;init_buffer_size)</span>
<span class="lineNum">     819 </span><span class="lineCov">      33574 :         stream-&gt;buffer_size = stream-&gt;init_buffer_size;</span>
<span class="lineNum">     820 </span>            :     else
<span class="lineNum">     821 </span><span class="lineCov">      27570 :         stream-&gt;buffer_size = nearest_power(stream-&gt;buffer_size);</span>
<span class="lineNum">     822 </span>            : 
<span class="lineNum">     823 </span><span class="lineCov">      61144 :     max_size = i_stream_get_max_buffer_size(&amp;stream-&gt;istream);</span>
<span class="lineNum">     824 </span><span class="lineCov">      61144 :     i_assert(max_size &gt; 0);</span>
<span class="lineNum">     825 </span><span class="lineCov">      61144 :     if (stream-&gt;buffer_size &gt; max_size)</span>
<span class="lineNum">     826 </span><span class="lineCov">        550 :         stream-&gt;buffer_size = max_size;</span>
<span class="lineNum">     827 </span>            : 
<span class="lineNum">     828 </span><span class="lineCov">      61144 :     if (stream-&gt;buffer_size &lt;= old_size)</span>
<span class="lineNum">     829 </span><span class="lineCov">         23 :         stream-&gt;buffer_size = old_size;</span>
<span class="lineNum">     830 </span>            :     else
<span class="lineNum">     831 </span><span class="lineCov">      61121 :         i_stream_w_buffer_realloc(stream, old_size);</span>
<a name="832"><span class="lineNum">     832 </span><span class="lineCov">      61144 : }</span></a>
<span class="lineNum">     833 </span>            : 
<span class="lineNum">     834 </span><span class="lineCov">     113214 : bool i_stream_try_alloc(struct istream_private *stream,</span>
<span class="lineNum">     835 </span>            :             size_t wanted_size, size_t *size_r)
<span class="lineNum">     836 </span>            : {
<span class="lineNum">     837 </span><span class="lineCov">     113214 :     i_assert(wanted_size &gt; 0);</span>
<span class="lineNum">     838 </span>            : 
<span class="lineNum">     839 </span><span class="lineCov">     113214 :     if (wanted_size &gt; stream-&gt;buffer_size - stream-&gt;pos) {</span>
<span class="lineNum">     840 </span><span class="lineCov">      84994 :         if (stream-&gt;skip &gt; 0) {</span>
<span class="lineNum">     841 </span>            :             /* remove the unused bytes from beginning of buffer */
<span class="lineNum">     842 </span><span class="lineCov">      31612 :             if (stream-&gt;memarea != NULL &amp;&amp;</span>
<span class="lineNum">     843 </span><span class="lineCov">      15806 :                 memarea_get_refcount(stream-&gt;memarea) &gt; 1) {</span>
<span class="lineNum">     844 </span>            :                 /* The memarea is still referenced. We can't
<span class="lineNum">     845 </span>            :                    overwrite data until extra references are
<span class="lineNum">     846 </span>            :                    gone. */
<span class="lineNum">     847 </span><span class="lineCov">      14676 :                 i_stream_w_buffer_realloc(stream, stream-&gt;buffer_size);</span>
<span class="lineNum">     848 </span>            :             }
<span class="lineNum">     849 </span><span class="lineCov">      15806 :             i_stream_compress(stream);</span>
<span class="lineNum">     850 </span><span class="lineCov">      69188 :         } else if (stream-&gt;buffer_size &lt; i_stream_get_max_buffer_size(&amp;stream-&gt;istream)) {</span>
<span class="lineNum">     851 </span>            :             /* buffer is full - grow it */
<span class="lineNum">     852 </span><span class="lineCov">      61144 :             i_stream_grow_buffer(stream, I_STREAM_MIN_SIZE);</span>
<span class="lineNum">     853 </span>            :         }
<span class="lineNum">     854 </span>            :     }
<span class="lineNum">     855 </span>            : 
<span class="lineNum">     856 </span><span class="lineCov">     113214 :     *size_r = stream-&gt;buffer_size - stream-&gt;pos;</span>
<span class="lineNum">     857 </span><span class="lineCov">     113214 :     if (stream-&gt;try_alloc_limit &gt; 0 &amp;&amp;</span>
<span class="lineNum">     858 </span><span class="lineNoCov">          0 :         *size_r &gt; stream-&gt;try_alloc_limit)</span>
<span class="lineNum">     859 </span><span class="lineNoCov">          0 :         *size_r = stream-&gt;try_alloc_limit;</span>
<span class="lineNum">     860 </span><span class="lineCov">     113214 :     return *size_r &gt; 0;</span>
<span class="lineNum">     861 </span>            : }
<a name="862"><span class="lineNum">     862 </span>            : </a>
<span class="lineNum">     863 </span>            : bool ATTR_NOWARN_UNUSED_RESULT
<span class="lineNum">     864 </span><span class="lineNoCov">          0 : i_stream_try_alloc_avoid_compress(struct istream_private *stream,</span>
<span class="lineNum">     865 </span>            :                   size_t wanted_size, size_t *size_r)
<span class="lineNum">     866 </span>            : {
<span class="lineNum">     867 </span><span class="lineNoCov">          0 :     size_t old_skip = stream-&gt;skip;</span>
<span class="lineNum">     868 </span>            : 
<span class="lineNum">     869 </span>            :     /* try first with skip=0, so no compression is done */
<span class="lineNum">     870 </span><span class="lineNoCov">          0 :     stream-&gt;skip = 0;</span>
<span class="lineNum">     871 </span><span class="lineNoCov">          0 :     bool ret = i_stream_try_alloc(stream, wanted_size, size_r);</span>
<span class="lineNum">     872 </span><span class="lineNoCov">          0 :     stream-&gt;skip = old_skip;</span>
<span class="lineNum">     873 </span><span class="lineNoCov">          0 :     if (ret || old_skip == 0)</span>
<span class="lineNum">     874 </span><span class="lineNoCov">          0 :         return ret;</span>
<span class="lineNum">     875 </span>            :     /* it's full. try with compression. */
<span class="lineNum">     876 </span><span class="lineNoCov">          0 :     return i_stream_try_alloc(stream, wanted_size, size_r);</span>
<a name="877"><span class="lineNum">     877 </span>            : }</a>
<span class="lineNum">     878 </span>            : 
<span class="lineNum">     879 </span><span class="lineCov">       1828 : void *i_stream_alloc(struct istream_private *stream, size_t size)</span>
<span class="lineNum">     880 </span>            : {
<span class="lineNum">     881 </span>            :     size_t old_size, avail_size;
<span class="lineNum">     882 </span>            : 
<span class="lineNum">     883 </span><span class="lineCov">       1828 :     i_stream_try_alloc(stream, size, &amp;avail_size);</span>
<span class="lineNum">     884 </span><span class="lineCov">       1828 :     if (avail_size &lt; size) {</span>
<span class="lineNum">     885 </span><span class="lineNoCov">          0 :         old_size = stream-&gt;buffer_size;</span>
<span class="lineNum">     886 </span><span class="lineNoCov">          0 :         stream-&gt;buffer_size = nearest_power(stream-&gt;pos + size);</span>
<span class="lineNum">     887 </span><span class="lineNoCov">          0 :         i_stream_w_buffer_realloc(stream, old_size);</span>
<span class="lineNum">     888 </span>            : 
<span class="lineNum">     889 </span><span class="lineNoCov">          0 :         i_stream_try_alloc(stream, size, &amp;avail_size);</span>
<span class="lineNum">     890 </span><span class="lineNoCov">          0 :         i_assert(avail_size &gt;= size);</span>
<span class="lineNum">     891 </span>            :     }
<span class="lineNum">     892 </span><span class="lineCov">       1828 :     return stream-&gt;w_buffer + stream-&gt;pos;</span>
<a name="893"><span class="lineNum">     893 </span>            : }</a>
<span class="lineNum">     894 </span>            : 
<span class="lineNum">     895 </span><span class="lineNoCov">          0 : bool i_stream_add_data(struct istream *_stream, const unsigned char *data,</span>
<span class="lineNum">     896 </span>            :                size_t size)
<span class="lineNum">     897 </span>            : {
<span class="lineNum">     898 </span><span class="lineNoCov">          0 :     struct istream_private *stream = _stream-&gt;real_stream;</span>
<span class="lineNum">     899 </span>            :     size_t size2;
<span class="lineNum">     900 </span>            : 
<span class="lineNum">     901 </span><span class="lineNoCov">          0 :     i_stream_try_alloc(stream, size, &amp;size2);</span>
<span class="lineNum">     902 </span><span class="lineNoCov">          0 :     if (size &gt; size2)</span>
<span class="lineNum">     903 </span><span class="lineNoCov">          0 :         return FALSE;</span>
<span class="lineNum">     904 </span>            : 
<span class="lineNum">     905 </span><span class="lineNoCov">          0 :     memcpy(stream-&gt;w_buffer + stream-&gt;pos, data, size);</span>
<span class="lineNum">     906 </span><span class="lineNoCov">          0 :     stream-&gt;pos += size;</span>
<span class="lineNum">     907 </span><span class="lineNoCov">          0 :     return TRUE;</span>
<a name="908"><span class="lineNum">     908 </span>            : }</a>
<span class="lineNum">     909 </span>            : 
<span class="lineNum">     910 </span><span class="lineCov">      13110 : void i_stream_set_input_pending(struct istream *stream, bool pending)</span>
<span class="lineNum">     911 </span>            : {
<span class="lineNum">     912 </span><span class="lineCov">      13110 :     if (!pending)</span>
<span class="lineNum">     913 </span><span class="lineCov">      13110 :         return;</span>
<span class="lineNum">     914 </span>            : 
<span class="lineNum">     915 </span><span class="lineCov">      26240 :     while (stream-&gt;real_stream-&gt;parent != NULL) {</span>
<span class="lineNum">     916 </span><span class="lineCov">         20 :         i_assert(stream-&gt;real_stream-&gt;io == NULL);</span>
<span class="lineNum">     917 </span><span class="lineCov">         20 :         stream = stream-&gt;real_stream-&gt;parent;</span>
<span class="lineNum">     918 </span>            :     }
<span class="lineNum">     919 </span><span class="lineCov">      13110 :     if (stream-&gt;real_stream-&gt;io != NULL)</span>
<span class="lineNum">     920 </span><span class="lineCov">        192 :         io_set_pending(stream-&gt;real_stream-&gt;io);</span>
<a name="921"><span class="lineNum">     921 </span>            : }</a>
<span class="lineNum">     922 </span>            : 
<span class="lineNum">     923 </span><span class="lineCov">          1 : void i_stream_switch_ioloop(struct istream *stream)</span>
<span class="lineNum">     924 </span>            : {
<span class="lineNum">     925 </span>            :     do {
<span class="lineNum">     926 </span><span class="lineCov">          1 :         if (stream-&gt;real_stream-&gt;switch_ioloop != NULL)</span>
<span class="lineNum">     927 </span><span class="lineNoCov">          0 :             stream-&gt;real_stream-&gt;switch_ioloop(stream-&gt;real_stream);</span>
<span class="lineNum">     928 </span><span class="lineCov">          1 :         stream = stream-&gt;real_stream-&gt;parent;</span>
<span class="lineNum">     929 </span><span class="lineCov">          1 :     } while (stream != NULL);</span>
<a name="930"><span class="lineNum">     930 </span><span class="lineCov">          1 : }</span></a>
<span class="lineNum">     931 </span>            : 
<span class="lineNum">     932 </span><span class="lineCov">         62 : void i_stream_set_io(struct istream *stream, struct io *io)</span>
<span class="lineNum">     933 </span>            : {
<span class="lineNum">     934 </span><span class="lineCov">        145 :     while (stream-&gt;real_stream-&gt;parent != NULL) {</span>
<span class="lineNum">     935 </span><span class="lineCov">         21 :         i_assert(stream-&gt;real_stream-&gt;io == NULL);</span>
<span class="lineNum">     936 </span><span class="lineCov">         21 :         stream = stream-&gt;real_stream-&gt;parent;</span>
<span class="lineNum">     937 </span>            :     }
<span class="lineNum">     938 </span>            : 
<span class="lineNum">     939 </span><span class="lineCov">         62 :     i_assert(stream-&gt;real_stream-&gt;io == NULL);</span>
<span class="lineNum">     940 </span><span class="lineCov">         62 :     stream-&gt;real_stream-&gt;io = io;</span>
<a name="941"><span class="lineNum">     941 </span><span class="lineCov">         62 : }</span></a>
<span class="lineNum">     942 </span>            : 
<span class="lineNum">     943 </span><span class="lineCov">         62 : void i_stream_unset_io(struct istream *stream, struct io *io)</span>
<span class="lineNum">     944 </span>            : {
<span class="lineNum">     945 </span><span class="lineCov">        145 :     while (stream-&gt;real_stream-&gt;parent != NULL) {</span>
<span class="lineNum">     946 </span><span class="lineCov">         21 :         i_assert(stream-&gt;real_stream-&gt;io == NULL);</span>
<span class="lineNum">     947 </span><span class="lineCov">         21 :         stream = stream-&gt;real_stream-&gt;parent;</span>
<span class="lineNum">     948 </span>            :     }
<span class="lineNum">     949 </span>            : 
<span class="lineNum">     950 </span><span class="lineCov">         62 :     i_assert(stream-&gt;real_stream-&gt;io == io);</span>
<span class="lineNum">     951 </span><span class="lineCov">         62 :     stream-&gt;real_stream-&gt;io = NULL;</span>
<span class="lineNum">     952 </span><span class="lineCov">         62 : }</span>
<a name="953"><span class="lineNum">     953 </span>            : </a>
<span class="lineNum">     954 </span>            : static void
<span class="lineNum">     955 </span><span class="lineCov">       1352 : i_stream_default_set_max_buffer_size(struct iostream_private *stream,</span>
<span class="lineNum">     956 </span>            :                      size_t max_size)
<span class="lineNum">     957 </span>            : {
<span class="lineNum">     958 </span><span class="lineCov">       1352 :     struct istream_private *_stream = (struct istream_private *)stream;</span>
<span class="lineNum">     959 </span>            : 
<span class="lineNum">     960 </span><span class="lineCov">       1352 :     _stream-&gt;max_buffer_size = max_size;</span>
<span class="lineNum">     961 </span><span class="lineCov">       1352 :     if (_stream-&gt;parent != NULL)</span>
<span class="lineNum">     962 </span><span class="lineCov">        253 :         i_stream_set_max_buffer_size(_stream-&gt;parent, max_size);</span>
<a name="963"><span class="lineNum">     963 </span><span class="lineCov">       1352 : }</span></a>
<span class="lineNum">     964 </span>            : 
<span class="lineNum">     965 </span><span class="lineCov">      73176 : static void i_stream_default_close(struct iostream_private *stream,</span>
<span class="lineNum">     966 </span>            :                    bool close_parent)
<span class="lineNum">     967 </span>            : {
<span class="lineNum">     968 </span><span class="lineCov">      73176 :     struct istream_private *_stream = (struct istream_private *)stream;</span>
<span class="lineNum">     969 </span>            : 
<span class="lineNum">     970 </span><span class="lineCov">      73176 :     if (close_parent)</span>
<span class="lineNum">     971 </span><span class="lineCov">          5 :         i_stream_close(_stream-&gt;parent);</span>
<a name="972"><span class="lineNum">     972 </span><span class="lineCov">      73176 : }</span></a>
<span class="lineNum">     973 </span>            : 
<span class="lineNum">     974 </span><span class="lineCov">      72664 : static void i_stream_default_destroy(struct iostream_private *stream)</span>
<span class="lineNum">     975 </span>            : {
<span class="lineNum">     976 </span><span class="lineCov">      72664 :     struct istream_private *_stream = (struct istream_private *)stream;</span>
<span class="lineNum">     977 </span>            : 
<span class="lineNum">     978 </span><span class="lineCov">      72664 :     i_stream_free_buffer(_stream);</span>
<span class="lineNum">     979 </span><span class="lineCov">      72664 :     i_stream_unref(&amp;_stream-&gt;parent);</span>
<span class="lineNum">     980 </span><span class="lineCov">      72664 : }</span>
<a name="981"><span class="lineNum">     981 </span>            : </a>
<span class="lineNum">     982 </span>            : static void
<span class="lineNum">     983 </span><span class="lineCov">      30374 : i_stream_default_seek_seekable(struct istream_private *stream,</span>
<span class="lineNum">     984 </span>            :                    uoff_t v_offset, bool mark ATTR_UNUSED)
<span class="lineNum">     985 </span>            : {
<span class="lineNum">     986 </span><span class="lineCov">      30374 :     stream-&gt;istream.v_offset = v_offset;</span>
<span class="lineNum">     987 </span><span class="lineCov">      30374 :     stream-&gt;skip = stream-&gt;pos = 0;</span>
<a name="988"><span class="lineNum">     988 </span><span class="lineCov">      30374 : }</span></a>
<span class="lineNum">     989 </span>            : 
<span class="lineNum">     990 </span><span class="lineCov">       1221 : void i_stream_default_seek_nonseekable(struct istream_private *stream,</span>
<span class="lineNum">     991 </span>            :                        uoff_t v_offset, bool mark ATTR_UNUSED)
<span class="lineNum">     992 </span>            : {
<span class="lineNum">     993 </span>            :     size_t available;
<span class="lineNum">     994 </span>            : 
<span class="lineNum">     995 </span><span class="lineCov">       1221 :     if (stream-&gt;istream.v_offset &gt; v_offset)</span>
<span class="lineNum">     996 </span><span class="lineNoCov">          0 :         i_panic(&quot;stream %s doesn't support seeking backwards&quot;,</span>
<span class="lineNum">     997 </span>            :             i_stream_get_name(&amp;stream-&gt;istream));
<span class="lineNum">     998 </span>            : 
<span class="lineNum">     999 </span><span class="lineCov">      11012 :     while (stream-&gt;istream.v_offset &lt; v_offset) {</span>
<span class="lineNum">    1000 </span><span class="lineCov">       8570 :         (void)i_stream_read(&amp;stream-&gt;istream);</span>
<span class="lineNum">    1001 </span>            : 
<span class="lineNum">    1002 </span><span class="lineCov">       8570 :         available = stream-&gt;pos - stream-&gt;skip;</span>
<span class="lineNum">    1003 </span><span class="lineCov">       8570 :         if (available == 0) {</span>
<span class="lineNum">    1004 </span><span class="lineNoCov">          0 :             if (stream-&gt;istream.stream_errno != 0) {</span>
<span class="lineNum">    1005 </span>            :                 /* read failed */
<span class="lineNum">    1006 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">    1007 </span>            :             }
<span class="lineNum">    1008 </span><span class="lineNoCov">          0 :             io_stream_set_error(&amp;stream-&gt;iostream,</span>
<span class="lineNum">    1009 </span>            :                 &quot;Can't seek to offset %&quot;PRIuUOFF_T
<span class="lineNum">    1010 </span>            :                 &quot;, because we have data only up to offset %&quot;
<span class="lineNum">    1011 </span>            :                 PRIuUOFF_T&quot; (eof=%d)&quot;, v_offset,
<span class="lineNum">    1012 </span><span class="lineNoCov">          0 :                 stream-&gt;istream.v_offset, stream-&gt;istream.eof ? 1 : 0);</span>
<span class="lineNum">    1013 </span><span class="lineNoCov">          0 :             stream-&gt;istream.stream_errno = ESPIPE;</span>
<span class="lineNum">    1014 </span><span class="lineNoCov">          0 :             return;</span>
<span class="lineNum">    1015 </span>            :         }
<span class="lineNum">    1016 </span><span class="lineCov">       8570 :         if (available &lt;= v_offset - stream-&gt;istream.v_offset)</span>
<span class="lineNum">    1017 </span><span class="lineCov">       7401 :             i_stream_skip(&amp;stream-&gt;istream, available);</span>
<span class="lineNum">    1018 </span>            :         else {
<span class="lineNum">    1019 </span><span class="lineCov">       1169 :             i_stream_skip(&amp;stream-&gt;istream,</span>
<span class="lineNum">    1020 </span><span class="lineCov">       1169 :                       v_offset - stream-&gt;istream.v_offset);</span>
<span class="lineNum">    1021 </span>            :         }
<span class="lineNum">    1022 </span>            :     }
<span class="lineNum">    1023 </span>            : }
<a name="1024"><span class="lineNum">    1024 </span>            : </a>
<span class="lineNum">    1025 </span>            : static int
<span class="lineNum">    1026 </span><span class="lineCov">        774 : i_stream_default_stat(struct istream_private *stream, bool exact)</span>
<span class="lineNum">    1027 </span>            : {
<span class="lineNum">    1028 </span>            :     const struct stat *st;
<span class="lineNum">    1029 </span>            : 
<span class="lineNum">    1030 </span><span class="lineCov">        774 :     if (stream-&gt;parent == NULL)</span>
<span class="lineNum">    1031 </span><span class="lineCov">        771 :         return stream-&gt;istream.stream_errno == 0 ? 0 : -1;</span>
<span class="lineNum">    1032 </span>            : 
<span class="lineNum">    1033 </span><span class="lineCov">          3 :     if (i_stream_stat(stream-&gt;parent, exact, &amp;st) &lt; 0) {</span>
<span class="lineNum">    1034 </span><span class="lineNoCov">          0 :         stream-&gt;istream.stream_errno = stream-&gt;parent-&gt;stream_errno;</span>
<span class="lineNum">    1035 </span><span class="lineNoCov">          0 :         return -1;</span>
<span class="lineNum">    1036 </span>            :     }
<span class="lineNum">    1037 </span><span class="lineCov">          3 :     stream-&gt;statbuf = *st;</span>
<span class="lineNum">    1038 </span><span class="lineCov">          3 :     if (exact &amp;&amp; !stream-&gt;stream_size_passthrough) {</span>
<span class="lineNum">    1039 </span>            :         /* exact size is not known, even if parent returned something */
<span class="lineNum">    1040 </span><span class="lineNoCov">          0 :         stream-&gt;statbuf.st_size = -1;</span>
<span class="lineNum">    1041 </span>            :     }
<span class="lineNum">    1042 </span><span class="lineCov">          3 :     return 0;</span>
<span class="lineNum">    1043 </span>            : }
<a name="1044"><span class="lineNum">    1044 </span>            : </a>
<span class="lineNum">    1045 </span>            : static int
<span class="lineNum">    1046 </span><span class="lineCov">         39 : i_stream_default_get_size(struct istream_private *stream,</span>
<span class="lineNum">    1047 </span>            :               bool exact, uoff_t *size_r)
<span class="lineNum">    1048 </span>            : {
<span class="lineNum">    1049 </span><span class="lineCov">         39 :     if (stream-&gt;stat(stream, exact) &lt; 0)</span>
<span class="lineNum">    1050 </span><span class="lineNoCov">          0 :         return -1;</span>
<span class="lineNum">    1051 </span><span class="lineCov">         39 :     if (stream-&gt;statbuf.st_size == -1)</span>
<span class="lineNum">    1052 </span><span class="lineNoCov">          0 :         return 0;</span>
<span class="lineNum">    1053 </span>            : 
<span class="lineNum">    1054 </span><span class="lineCov">         39 :     *size_r = stream-&gt;statbuf.st_size;</span>
<span class="lineNum">    1055 </span><span class="lineCov">         39 :     return 1;</span>
<a name="1056"><span class="lineNum">    1056 </span>            : }</a>
<span class="lineNum">    1057 </span>            : 
<span class="lineNum">    1058 </span><span class="lineCov">      36282 : void i_stream_init_parent(struct istream_private *_stream,</span>
<span class="lineNum">    1059 </span>            :               struct istream *parent)
<span class="lineNum">    1060 </span>            : {
<span class="lineNum">    1061 </span><span class="lineCov">      36282 :     _stream-&gt;access_counter = parent-&gt;real_stream-&gt;access_counter;</span>
<span class="lineNum">    1062 </span><span class="lineCov">      36282 :     _stream-&gt;parent = parent;</span>
<span class="lineNum">    1063 </span><span class="lineCov">      36282 :     _stream-&gt;parent_start_offset = parent-&gt;v_offset;</span>
<span class="lineNum">    1064 </span><span class="lineCov">      36282 :     _stream-&gt;parent_expected_offset = parent-&gt;v_offset;</span>
<span class="lineNum">    1065 </span><span class="lineCov">      36282 :     _stream-&gt;start_offset = parent-&gt;v_offset;</span>
<span class="lineNum">    1066 </span>            :     /* if parent stream is an istream-error, copy the error */
<span class="lineNum">    1067 </span><span class="lineCov">      36282 :     _stream-&gt;istream.stream_errno = parent-&gt;stream_errno;</span>
<span class="lineNum">    1068 </span><span class="lineCov">      36282 :     _stream-&gt;istream.eof = parent-&gt;eof;</span>
<span class="lineNum">    1069 </span><span class="lineCov">      36282 :     i_stream_ref(parent);</span>
<span class="lineNum">    1070 </span><span class="lineCov">      36282 : }</span>
<a name="1071"><span class="lineNum">    1071 </span>            : </a>
<span class="lineNum">    1072 </span>            : struct istream *
<span class="lineNum">    1073 </span><span class="lineCov">      74157 : i_stream_create(struct istream_private *_stream, struct istream *parent, int fd,</span>
<span class="lineNum">    1074 </span>            :         enum istream_create_flag flags)
<span class="lineNum">    1075 </span>            : {
<span class="lineNum">    1076 </span><span class="lineCov">      74157 :     bool noop_snapshot = (flags &amp; ISTREAM_CREATE_FLAG_NOOP_SNAPSHOT) != 0;</span>
<span class="lineNum">    1077 </span>            : 
<span class="lineNum">    1078 </span><span class="lineCov">      74157 :     _stream-&gt;fd = fd;</span>
<span class="lineNum">    1079 </span><span class="lineCov">      74157 :     if (parent != NULL)</span>
<span class="lineNum">    1080 </span><span class="lineCov">      36276 :         i_stream_init_parent(_stream, parent);</span>
<span class="lineNum">    1081 </span><span class="lineCov">      37881 :     else if (_stream-&gt;memarea == NULL &amp;&amp; !noop_snapshot) {</span>
<span class="lineNum">    1082 </span>            :         /* The stream has no parent and no memarea yet. We'll assume
<span class="lineNum">    1083 </span>            :            that it wants to be using memareas for the reads. */
<span class="lineNum">    1084 </span><span class="lineCov">       2926 :         _stream-&gt;memarea = memarea_init_empty();</span>
<span class="lineNum">    1085 </span>            :     }
<span class="lineNum">    1086 </span><span class="lineCov">      74157 :     _stream-&gt;istream.real_stream = _stream;</span>
<span class="lineNum">    1087 </span>            : 
<span class="lineNum">    1088 </span><span class="lineCov">      74157 :     if (_stream-&gt;iostream.close == NULL)</span>
<span class="lineNum">    1089 </span><span class="lineCov">      72958 :         _stream-&gt;iostream.close = i_stream_default_close;</span>
<span class="lineNum">    1090 </span><span class="lineCov">      74157 :     if (_stream-&gt;iostream.destroy == NULL)</span>
<span class="lineNum">    1091 </span><span class="lineCov">      72664 :         _stream-&gt;iostream.destroy = i_stream_default_destroy;</span>
<span class="lineNum">    1092 </span><span class="lineCov">      74157 :     if (_stream-&gt;seek == NULL) {</span>
<span class="lineNum">    1093 </span><span class="lineCov">      72150 :         _stream-&gt;seek = _stream-&gt;istream.seekable ?</span>
<span class="lineNum">    1094 </span><span class="lineCov">      36075 :             i_stream_default_seek_seekable :</span>
<span class="lineNum">    1095 </span>            :             i_stream_default_seek_nonseekable;
<span class="lineNum">    1096 </span>            :     }
<span class="lineNum">    1097 </span><span class="lineCov">      74157 :     if (_stream-&gt;stat == NULL)</span>
<span class="lineNum">    1098 </span><span class="lineCov">      72908 :         _stream-&gt;stat = i_stream_default_stat;</span>
<span class="lineNum">    1099 </span><span class="lineCov">      74157 :     if (_stream-&gt;get_size == NULL)</span>
<span class="lineNum">    1100 </span><span class="lineCov">      73617 :         _stream-&gt;get_size = i_stream_default_get_size;</span>
<span class="lineNum">    1101 </span><span class="lineCov">      74157 :     if (_stream-&gt;snapshot == NULL) {</span>
<span class="lineNum">    1102 </span><span class="lineCov">      74040 :         _stream-&gt;snapshot = noop_snapshot ?</span>
<span class="lineNum">    1103 </span><span class="lineCov">      74040 :             i_stream_noop_snapshot :</span>
<span class="lineNum">    1104 </span>            :             i_stream_default_snapshot;
<span class="lineNum">    1105 </span>            :     }
<span class="lineNum">    1106 </span><span class="lineCov">      74157 :     if (_stream-&gt;iostream.set_max_buffer_size == NULL) {</span>
<span class="lineNum">    1107 </span><span class="lineCov">      73906 :         _stream-&gt;iostream.set_max_buffer_size =</span>
<span class="lineNum">    1108 </span>            :             i_stream_default_set_max_buffer_size;
<span class="lineNum">    1109 </span>            :     }
<span class="lineNum">    1110 </span><span class="lineCov">      74157 :     if (_stream-&gt;init_buffer_size == 0)</span>
<span class="lineNum">    1111 </span><span class="lineCov">      74157 :         _stream-&gt;init_buffer_size = I_STREAM_MIN_SIZE;</span>
<span class="lineNum">    1112 </span>            : 
<span class="lineNum">    1113 </span><span class="lineCov">      74157 :     i_zero(&amp;_stream-&gt;statbuf);</span>
<span class="lineNum">    1114 </span><span class="lineCov">      74157 :     _stream-&gt;statbuf.st_size = -1;</span>
<span class="lineNum">    1115 </span><span class="lineCov">      74157 :     _stream-&gt;statbuf.st_atime =</span>
<span class="lineNum">    1116 </span><span class="lineCov">      74157 :         _stream-&gt;statbuf.st_mtime =</span>
<span class="lineNum">    1117 </span><span class="lineCov">      74157 :         _stream-&gt;statbuf.st_ctime = ioloop_time;</span>
<span class="lineNum">    1118 </span>            : 
<span class="lineNum">    1119 </span><span class="lineCov">      74157 :     io_stream_init(&amp;_stream-&gt;iostream);</span>
<span class="lineNum">    1120 </span>            : 
<span class="lineNum">    1121 </span><span class="lineCov">      74157 :     if (_stream-&gt;istream.stream_errno != 0)</span>
<span class="lineNum">    1122 </span><span class="lineNoCov">          0 :         _stream-&gt;istream.eof = TRUE;</span>
<span class="lineNum">    1123 </span>            : 
<span class="lineNum">    1124 </span><span class="lineCov">      74157 :     return &amp;_stream-&gt;istream;</span>
<a name="1125"><span class="lineNum">    1125 </span>            : }</a>
<span class="lineNum">    1126 </span>            : 
<span class="lineNum">    1127 </span><span class="lineNoCov">          0 : struct istream *i_stream_create_error(int stream_errno)</span>
<span class="lineNum">    1128 </span>            : {
<span class="lineNum">    1129 </span>            :     struct istream_private *stream;
<span class="lineNum">    1130 </span>            : 
<span class="lineNum">    1131 </span><span class="lineNoCov">          0 :     stream = i_new(struct istream_private, 1);</span>
<span class="lineNum">    1132 </span><span class="lineNoCov">          0 :     stream-&gt;istream.closed = TRUE;</span>
<span class="lineNum">    1133 </span><span class="lineNoCov">          0 :     stream-&gt;istream.readable_fd = FALSE;</span>
<span class="lineNum">    1134 </span><span class="lineNoCov">          0 :     stream-&gt;istream.blocking = TRUE;</span>
<span class="lineNum">    1135 </span><span class="lineNoCov">          0 :     stream-&gt;istream.seekable = TRUE;</span>
<span class="lineNum">    1136 </span><span class="lineNoCov">          0 :     stream-&gt;istream.eof = TRUE;</span>
<span class="lineNum">    1137 </span><span class="lineNoCov">          0 :     stream-&gt;istream.stream_errno = stream_errno;</span>
<span class="lineNum">    1138 </span><span class="lineNoCov">          0 :     i_stream_create(stream, NULL, -1, 0);</span>
<span class="lineNum">    1139 </span><span class="lineNoCov">          0 :     i_stream_set_name(&amp;stream-&gt;istream, &quot;(error)&quot;);</span>
<span class="lineNum">    1140 </span><span class="lineNoCov">          0 :     return &amp;stream-&gt;istream;</span>
<span class="lineNum">    1141 </span>            : }
<a name="1142"><span class="lineNum">    1142 </span>            : </a>
<span class="lineNum">    1143 </span>            : struct istream *
<span class="lineNum">    1144 </span><span class="lineNoCov">          0 : i_stream_create_error_str(int stream_errno, const char *fmt, ...)</span>
<span class="lineNum">    1145 </span>            : {
<span class="lineNum">    1146 </span>            :     struct istream *input;
<span class="lineNum">    1147 </span>            :     va_list args;
<span class="lineNum">    1148 </span>            : 
<span class="lineNum">    1149 </span><span class="lineNoCov">          0 :     va_start(args, fmt);</span>
<span class="lineNum">    1150 </span><span class="lineNoCov">          0 :     input = i_stream_create_error(stream_errno);</span>
<span class="lineNum">    1151 </span><span class="lineNoCov">          0 :     io_stream_set_verror(&amp;input-&gt;real_stream-&gt;iostream, fmt, args);</span>
<span class="lineNum">    1152 </span><span class="lineNoCov">          0 :     va_end(args);</span>
<span class="lineNum">    1153 </span><span class="lineNoCov">          0 :     return input;</span>
<span class="lineNum">    1154 </span>            : }
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.10</a></td></tr>
  </table>
  <br>

</body>
</html>
