<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - Dovecot coverage - lib/var-expand.c</title>
  <link rel="stylesheet" type="text/css" href="../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../index.html">top level</a> - <a href="index.html">lib</a> - var-expand.c<span style="font-size: 80%;"> (source / <a href="var-expand.c.func.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">Dovecot coverage</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">350</td>
            <td class="headerCovTableEntry">431</td>
            <td class="headerCovTableEntryMed">81.2 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2021-02-24</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">20</td>
            <td class="headerCovTableEntry">27</td>
            <td class="headerCovTableEntryLo">74.1 %</td>
          </tr>
          <tr>
            <td class="headerItem">Legend:</td>
            <td class="headerValueLeg">            Lines:
            <span class="coverLegendCov">hit</span>
            <span class="coverLegendNoCov">not hit</span>
</td>
            <td></td>
          </tr>
          <tr><td><img src="../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /* Copyright (c) 2003-2018 Dovecot authors, see the included COPYING file */</a>
<span class="lineNum">       2 </span>            : 
<span class="lineNum">       3 </span>            : #include &quot;lib.h&quot;
<span class="lineNum">       4 </span>            : #include &quot;array.h&quot;
<span class="lineNum">       5 </span>            : #include &quot;md5.h&quot;
<span class="lineNum">       6 </span>            : #include &quot;hash.h&quot;
<span class="lineNum">       7 </span>            : #include &quot;hex-binary.h&quot;
<span class="lineNum">       8 </span>            : #include &quot;base64.h&quot;
<span class="lineNum">       9 </span>            : #include &quot;hostpid.h&quot;
<span class="lineNum">      10 </span>            : #include &quot;hmac.h&quot;
<span class="lineNum">      11 </span>            : #include &quot;pkcs5.h&quot;
<span class="lineNum">      12 </span>            : #include &quot;hash-method.h&quot;
<span class="lineNum">      13 </span>            : #include &quot;str.h&quot;
<span class="lineNum">      14 </span>            : #include &quot;strescape.h&quot;
<span class="lineNum">      15 </span>            : #include &quot;var-expand.h&quot;
<span class="lineNum">      16 </span>            : #include &quot;var-expand-private.h&quot;
<span class="lineNum">      17 </span>            : 
<span class="lineNum">      18 </span>            : #include &lt;unistd.h&gt;
<span class="lineNum">      19 </span>            : #include &lt;ctype.h&gt;
<span class="lineNum">      20 </span>            : 
<span class="lineNum">      21 </span>            : #define TABLE_LAST(t) \
<span class="lineNum">      22 </span>            :     ((t)-&gt;key == '\0' &amp;&amp; (t)-&gt;long_key == NULL)
<span class="lineNum">      23 </span>            : 
<span class="lineNum">      24 </span>            : struct var_expand_modifier {
<span class="lineNum">      25 </span>            :     char key;
<span class="lineNum">      26 </span>            :     const char *(*func)(const char *, struct var_expand_context *);
<span class="lineNum">      27 </span>            : };
<span class="lineNum">      28 </span>            : 
<span class="lineNum">      29 </span>            : static ARRAY(struct var_expand_extension_func_table) var_expand_extensions;
<a name="30"><span class="lineNum">      30 </span>            : </a>
<span class="lineNum">      31 </span>            : static const char *
<span class="lineNum">      32 </span><span class="lineNoCov">          0 : m_str_lcase(const char *str, struct var_expand_context *ctx ATTR_UNUSED)</span>
<span class="lineNum">      33 </span>            : {
<span class="lineNum">      34 </span><span class="lineNoCov">          0 :     return t_str_lcase(str);</span>
<span class="lineNum">      35 </span>            : }
<a name="36"><span class="lineNum">      36 </span>            : </a>
<span class="lineNum">      37 </span>            : static const char *
<span class="lineNum">      38 </span><span class="lineNoCov">          0 : m_str_ucase(const char *str, struct var_expand_context *ctx ATTR_UNUSED)</span>
<span class="lineNum">      39 </span>            : {
<span class="lineNum">      40 </span><span class="lineNoCov">          0 :     return t_str_ucase(str);</span>
<span class="lineNum">      41 </span>            : }
<a name="42"><span class="lineNum">      42 </span>            : </a>
<span class="lineNum">      43 </span>            : static const char *
<span class="lineNum">      44 </span><span class="lineNoCov">          0 : m_str_escape(const char *str, struct var_expand_context *ctx ATTR_UNUSED)</span>
<span class="lineNum">      45 </span>            : {
<span class="lineNum">      46 </span><span class="lineNoCov">          0 :     return str_escape(str);</span>
<span class="lineNum">      47 </span>            : }
<a name="48"><span class="lineNum">      48 </span>            : </a>
<span class="lineNum">      49 </span>            : static const char *
<span class="lineNum">      50 </span><span class="lineNoCov">          0 : m_str_hex(const char *str, struct var_expand_context *ctx ATTR_UNUSED)</span>
<span class="lineNum">      51 </span>            : {
<span class="lineNum">      52 </span>            :     unsigned long long l;
<span class="lineNum">      53 </span>            : 
<span class="lineNum">      54 </span><span class="lineNoCov">          0 :     if (str_to_ullong(str, &amp;l) &lt; 0)</span>
<span class="lineNum">      55 </span><span class="lineNoCov">          0 :         l = 0;</span>
<span class="lineNum">      56 </span><span class="lineNoCov">          0 :     return t_strdup_printf(&quot;%llx&quot;, l);</span>
<span class="lineNum">      57 </span>            : }
<a name="58"><span class="lineNum">      58 </span>            : </a>
<span class="lineNum">      59 </span>            : static const char *
<span class="lineNum">      60 </span><span class="lineNoCov">          0 : m_str_reverse(const char *str, struct var_expand_context *ctx ATTR_UNUSED)</span>
<span class="lineNum">      61 </span>            : {
<span class="lineNum">      62 </span><span class="lineNoCov">          0 :     size_t len = strlen(str);</span>
<span class="lineNum">      63 </span>            :     char *p, *rev;
<span class="lineNum">      64 </span>            : 
<span class="lineNum">      65 </span><span class="lineNoCov">          0 :     rev = t_malloc_no0(len + 1);</span>
<span class="lineNum">      66 </span><span class="lineNoCov">          0 :     rev[len] = '\0';</span>
<span class="lineNum">      67 </span>            : 
<span class="lineNum">      68 </span><span class="lineNoCov">          0 :     for (p = rev + len - 1; *str != '\0'; str++)</span>
<span class="lineNum">      69 </span><span class="lineNoCov">          0 :         *p-- = *str;</span>
<span class="lineNum">      70 </span><span class="lineNoCov">          0 :     return rev;</span>
<a name="71"><span class="lineNum">      71 </span>            : }</a>
<span class="lineNum">      72 </span>            : 
<span class="lineNum">      73 </span><span class="lineCov">          2 : static const char *m_str_hash(const char *str, struct var_expand_context *ctx)</span>
<span class="lineNum">      74 </span>            : {
<span class="lineNum">      75 </span><span class="lineCov">          2 :     unsigned int value = str_hash(str);</span>
<span class="lineNum">      76 </span><span class="lineCov">          2 :     string_t *hash = t_str_new(20);</span>
<span class="lineNum">      77 </span>            : 
<span class="lineNum">      78 </span><span class="lineCov">          2 :     if (ctx-&gt;width != 0) {</span>
<span class="lineNum">      79 </span><span class="lineCov">          2 :         value %= ctx-&gt;width;</span>
<span class="lineNum">      80 </span><span class="lineCov">          2 :         ctx-&gt;width = 0;</span>
<span class="lineNum">      81 </span>            :     }
<span class="lineNum">      82 </span>            : 
<span class="lineNum">      83 </span><span class="lineCov">          2 :     str_printfa(hash, &quot;%x&quot;, value);</span>
<span class="lineNum">      84 </span><span class="lineCov">          4 :     while ((int)str_len(hash) &lt; ctx-&gt;offset)</span>
<span class="lineNum">      85 </span><span class="lineNoCov">          0 :         str_insert(hash, 0, &quot;0&quot;);</span>
<span class="lineNum">      86 </span><span class="lineCov">          2 :     ctx-&gt;offset = 0;</span>
<span class="lineNum">      87 </span>            : 
<span class="lineNum">      88 </span><span class="lineCov">          2 :     return str_c(hash);</span>
<span class="lineNum">      89 </span>            : }
<a name="90"><span class="lineNum">      90 </span>            : </a>
<span class="lineNum">      91 </span>            : static const char *
<span class="lineNum">      92 </span><span class="lineCov">          2 : m_str_newhash(const char *str, struct var_expand_context *ctx)</span>
<span class="lineNum">      93 </span>            : {
<span class="lineNum">      94 </span><span class="lineCov">          2 :     string_t *hash = t_str_new(20);</span>
<span class="lineNum">      95 </span>            :     unsigned char result[MD5_RESULTLEN];
<span class="lineNum">      96 </span>            :     unsigned int i;
<span class="lineNum">      97 </span><span class="lineCov">          2 :     uint64_t value = 0;</span>
<span class="lineNum">      98 </span>            : 
<span class="lineNum">      99 </span><span class="lineCov">          2 :     md5_get_digest(str, strlen(str), result);</span>
<span class="lineNum">     100 </span><span class="lineCov">         18 :     for (i = 0; i &lt; sizeof(value); i++) {</span>
<span class="lineNum">     101 </span><span class="lineCov">         16 :         value &lt;&lt;= 8;</span>
<span class="lineNum">     102 </span><span class="lineCov">         16 :         value |= result[i];</span>
<span class="lineNum">     103 </span>            :     }
<span class="lineNum">     104 </span>            : 
<span class="lineNum">     105 </span><span class="lineCov">          2 :     if (ctx-&gt;width != 0) {</span>
<span class="lineNum">     106 </span><span class="lineCov">          2 :         value %= ctx-&gt;width;</span>
<span class="lineNum">     107 </span><span class="lineCov">          2 :         ctx-&gt;width = 0;</span>
<span class="lineNum">     108 </span>            :     }
<span class="lineNum">     109 </span>            : 
<span class="lineNum">     110 </span><span class="lineCov">          2 :     str_printfa(hash, &quot;%x&quot;, (unsigned int)value);</span>
<span class="lineNum">     111 </span><span class="lineCov">          4 :     while ((int)str_len(hash) &lt; ctx-&gt;offset)</span>
<span class="lineNum">     112 </span><span class="lineNoCov">          0 :         str_insert(hash, 0, &quot;0&quot;);</span>
<span class="lineNum">     113 </span><span class="lineCov">          2 :     ctx-&gt;offset = 0;</span>
<span class="lineNum">     114 </span>            : 
<span class="lineNum">     115 </span><span class="lineCov">          2 :     return str_c(hash);</span>
<span class="lineNum">     116 </span>            : }
<a name="117"><span class="lineNum">     117 </span>            : </a>
<span class="lineNum">     118 </span>            : static const char *
<span class="lineNum">     119 </span><span class="lineCov">          1 : m_str_md5(const char *str, struct var_expand_context *ctx ATTR_UNUSED)</span>
<span class="lineNum">     120 </span>            : {
<span class="lineNum">     121 </span>            :     unsigned char digest[16];
<span class="lineNum">     122 </span>            : 
<span class="lineNum">     123 </span><span class="lineCov">          1 :     md5_get_digest(str, strlen(str), digest);</span>
<span class="lineNum">     124 </span>            : 
<span class="lineNum">     125 </span><span class="lineCov">          1 :     return binary_to_hex(digest, sizeof(digest));</span>
<span class="lineNum">     126 </span>            : }
<a name="127"><span class="lineNum">     127 </span>            : </a>
<span class="lineNum">     128 </span>            : static const char *
<span class="lineNum">     129 </span><span class="lineNoCov">          0 : m_str_ldap_dn(const char *str, struct var_expand_context *ctx ATTR_UNUSED)</span>
<span class="lineNum">     130 </span>            : {
<span class="lineNum">     131 </span><span class="lineNoCov">          0 :     string_t *ret = t_str_new(256);</span>
<span class="lineNum">     132 </span>            : 
<span class="lineNum">     133 </span><span class="lineNoCov">          0 :     while (*str != '\0') {</span>
<span class="lineNum">     134 </span><span class="lineNoCov">          0 :         if (*str == '.')</span>
<span class="lineNum">     135 </span><span class="lineNoCov">          0 :             str_append(ret, &quot;,dc=&quot;);</span>
<span class="lineNum">     136 </span>            :         else
<span class="lineNum">     137 </span><span class="lineNoCov">          0 :             str_append_c(ret, *str);</span>
<span class="lineNum">     138 </span><span class="lineNoCov">          0 :         str++;</span>
<span class="lineNum">     139 </span>            :     }
<span class="lineNum">     140 </span>            : 
<span class="lineNum">     141 </span><span class="lineNoCov">          0 :     return str_free_without_data(&amp;ret);</span>
<span class="lineNum">     142 </span>            : }
<a name="143"><span class="lineNum">     143 </span>            : </a>
<span class="lineNum">     144 </span>            : static const char *
<span class="lineNum">     145 </span><span class="lineNoCov">          0 : m_str_trim(const char *str, struct var_expand_context *ctx ATTR_UNUSED)</span>
<span class="lineNum">     146 </span>            : {
<span class="lineNum">     147 </span>            :     size_t len;
<span class="lineNum">     148 </span>            : 
<span class="lineNum">     149 </span><span class="lineNoCov">          0 :     len = strlen(str);</span>
<span class="lineNum">     150 </span><span class="lineNoCov">          0 :     while (len &gt; 0 &amp;&amp; i_isspace(str[len-1]))</span>
<span class="lineNum">     151 </span><span class="lineNoCov">          0 :         len--;</span>
<span class="lineNum">     152 </span><span class="lineNoCov">          0 :     return t_strndup(str, len);</span>
<span class="lineNum">     153 </span>            : }
<span class="lineNum">     154 </span>            : 
<span class="lineNum">     155 </span>            : #define MAX_MODIFIER_COUNT 10
<span class="lineNum">     156 </span>            : static const struct var_expand_modifier modifiers[] = {
<span class="lineNum">     157 </span>            :     { 'L', m_str_lcase },
<span class="lineNum">     158 </span>            :     { 'U', m_str_ucase },
<span class="lineNum">     159 </span>            :     { 'E', m_str_escape },
<span class="lineNum">     160 </span>            :     { 'X', m_str_hex },
<span class="lineNum">     161 </span>            :     { 'R', m_str_reverse },
<span class="lineNum">     162 </span>            :     { 'H', m_str_hash },
<span class="lineNum">     163 </span>            :     { 'N', m_str_newhash },
<span class="lineNum">     164 </span>            :     { 'M', m_str_md5 },
<span class="lineNum">     165 </span>            :     { 'D', m_str_ldap_dn },
<span class="lineNum">     166 </span>            :     { 'T', m_str_trim },
<span class="lineNum">     167 </span>            :     { '\0', NULL }
<span class="lineNum">     168 </span>            : };
<a name="169"><span class="lineNum">     169 </span>            : </a>
<span class="lineNum">     170 </span>            : static int
<span class="lineNum">     171 </span><span class="lineCov">         56 : var_expand_short(const struct var_expand_table *table, char key,</span>
<span class="lineNum">     172 </span>            :          const char **var_r, const char **error_r)
<span class="lineNum">     173 </span>            : {
<span class="lineNum">     174 </span>            :     const struct var_expand_table *t;
<span class="lineNum">     175 </span>            : 
<span class="lineNum">     176 </span><span class="lineCov">         56 :     if (table != NULL) {</span>
<span class="lineNum">     177 </span><span class="lineCov">        295 :         for (t = table; !TABLE_LAST(t); t++) {</span>
<span class="lineNum">     178 </span><span class="lineCov">        295 :             if (t-&gt;key == key) {</span>
<span class="lineNum">     179 </span><span class="lineCov">         56 :                 *var_r = t-&gt;value != NULL ? t-&gt;value : &quot;&quot;;</span>
<span class="lineNum">     180 </span><span class="lineCov">         56 :                 return 1;</span>
<span class="lineNum">     181 </span>            :             }
<span class="lineNum">     182 </span>            :         }
<span class="lineNum">     183 </span>            :     }
<span class="lineNum">     184 </span>            : 
<span class="lineNum">     185 </span>            :     /* not found */
<span class="lineNum">     186 </span><span class="lineNoCov">          0 :     if (key == '%') {</span>
<span class="lineNum">     187 </span><span class="lineNoCov">          0 :         *var_r = &quot;%&quot;;</span>
<span class="lineNum">     188 </span><span class="lineNoCov">          0 :         return 1;</span>
<span class="lineNum">     189 </span>            :     }
<span class="lineNum">     190 </span><span class="lineNoCov">          0 :     if (*error_r == NULL)</span>
<span class="lineNum">     191 </span><span class="lineNoCov">          0 :         *error_r = t_strdup_printf(&quot;Unknown variable '%%%c'&quot;, key);</span>
<span class="lineNum">     192 </span><span class="lineNoCov">          0 :     return 0;</span>
<span class="lineNum">     193 </span>            : }
<a name="194"><span class="lineNum">     194 </span>            : </a>
<span class="lineNum">     195 </span>            : static int
<span class="lineNum">     196 </span><span class="lineCov">          9 : var_expand_hash(struct var_expand_context *ctx,</span>
<span class="lineNum">     197 </span>            :         const char *key, const char *field,
<span class="lineNum">     198 </span>            :         const char **result_r, const char **error_r)
<span class="lineNum">     199 </span>            : {
<span class="lineNum">     200 </span>            :     enum {
<span class="lineNum">     201 </span>            :         FORMAT_HEX,
<span class="lineNum">     202 </span>            :         FORMAT_HEX_UC,
<span class="lineNum">     203 </span>            :         FORMAT_BASE64
<span class="lineNum">     204 </span><span class="lineCov">          9 :     } format = FORMAT_HEX;</span>
<span class="lineNum">     205 </span>            : 
<span class="lineNum">     206 </span><span class="lineCov">          9 :     const char *p = strchr(key, ';');</span>
<span class="lineNum">     207 </span><span class="lineCov">          9 :     const char *const *args = NULL;</span>
<span class="lineNum">     208 </span><span class="lineCov">          9 :     const char *algo = key;</span>
<span class="lineNum">     209 </span>            :     const char *value;
<span class="lineNum">     210 </span>            :     int ret;
<span class="lineNum">     211 </span>            : 
<span class="lineNum">     212 </span><span class="lineCov">          9 :     if (p != NULL) {</span>
<span class="lineNum">     213 </span><span class="lineCov">          5 :         algo = t_strcut(key, ';');</span>
<span class="lineNum">     214 </span><span class="lineCov">          5 :         args = t_strsplit(p+1, &quot;,&quot;);</span>
<span class="lineNum">     215 </span>            :     }
<span class="lineNum">     216 </span>            : 
<span class="lineNum">     217 </span>            :     const struct hash_method *method;
<span class="lineNum">     218 </span><span class="lineCov">          9 :     if (strcmp(algo, &quot;pkcs5&quot;) == 0) {</span>
<span class="lineNum">     219 </span><span class="lineNoCov">          0 :         method = hash_method_lookup(&quot;sha256&quot;);</span>
<span class="lineNum">     220 </span><span class="lineCov">          9 :     } else if ((method = hash_method_lookup(algo)) == NULL) {</span>
<span class="lineNum">     221 </span><span class="lineNoCov">          0 :         return 0;</span>
<span class="lineNum">     222 </span>            :     }
<span class="lineNum">     223 </span>            : 
<span class="lineNum">     224 </span><span class="lineCov">          9 :     string_t *field_value = t_str_new(64);</span>
<span class="lineNum">     225 </span><span class="lineCov">          9 :     string_t *salt = t_str_new(64);</span>
<span class="lineNum">     226 </span><span class="lineCov">          9 :     string_t *tmp = t_str_new(method-&gt;digest_size);</span>
<span class="lineNum">     227 </span>            : 
<span class="lineNum">     228 </span><span class="lineCov">          9 :     if ((ret = var_expand_long(ctx, field, strlen(field),</span>
<span class="lineNum">     229 </span>            :                    &amp;value, error_r)) &lt; 1) {
<span class="lineNum">     230 </span><span class="lineNoCov">          0 :         return ret;</span>
<span class="lineNum">     231 </span>            :     }
<span class="lineNum">     232 </span>            : 
<span class="lineNum">     233 </span><span class="lineCov">          9 :     str_append(field_value, value);</span>
<span class="lineNum">     234 </span>            : 
<span class="lineNum">     235 </span>            :     /* default values */
<span class="lineNum">     236 </span><span class="lineCov">          9 :     unsigned int rounds = 1;</span>
<span class="lineNum">     237 </span><span class="lineCov">          9 :     unsigned int truncbits = 0;</span>
<span class="lineNum">     238 </span>            : 
<span class="lineNum">     239 </span><span class="lineCov">          9 :     if (strcmp(algo, &quot;pkcs5&quot;) == 0) {</span>
<span class="lineNum">     240 </span><span class="lineNoCov">          0 :         rounds = 2048;</span>
<span class="lineNum">     241 </span><span class="lineNoCov">          0 :         str_append(salt, field);</span>
<span class="lineNum">     242 </span>            :     }
<span class="lineNum">     243 </span>            : 
<span class="lineNum">     244 </span><span class="lineCov">         23 :     while(args != NULL &amp;&amp; *args != NULL) {</span>
<span class="lineNum">     245 </span><span class="lineCov">          7 :         const char *k = t_strcut(*args, '=');</span>
<span class="lineNum">     246 </span><span class="lineCov">          7 :         const char *value = strchr(*args, '=');</span>
<span class="lineNum">     247 </span><span class="lineCov">          7 :         if (value == NULL) {</span>
<span class="lineNum">     248 </span><span class="lineNoCov">          0 :             args++;</span>
<span class="lineNum">     249 </span><span class="lineNoCov">          0 :             continue;</span>
<span class="lineNum">     250 </span>            :         } else {
<span class="lineNum">     251 </span><span class="lineCov">          7 :             value++;</span>
<span class="lineNum">     252 </span>            :         }
<span class="lineNum">     253 </span><span class="lineCov">          7 :         if (strcmp(k, &quot;rounds&quot;) == 0) {</span>
<span class="lineNum">     254 </span><span class="lineCov">          2 :             if (str_to_uint(value, &amp;rounds)&lt;0) {</span>
<span class="lineNum">     255 </span><span class="lineNoCov">          0 :                 *error_r = t_strdup_printf(</span>
<span class="lineNum">     256 </span>            :                     &quot;Cannot parse hash arguments:&quot;
<span class="lineNum">     257 </span>            :                     &quot;'%s' is not number for rounds&quot;,
<span class="lineNum">     258 </span>            :                     value);
<span class="lineNum">     259 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">     260 </span>            :             }
<span class="lineNum">     261 </span><span class="lineCov">          2 :             if (rounds &lt; 1) {</span>
<span class="lineNum">     262 </span><span class="lineNoCov">          0 :                 *error_r = t_strdup_printf(</span>
<span class="lineNum">     263 </span>            :                     &quot;Cannot parse hash arguments:&quot;
<span class="lineNum">     264 </span>            :                     &quot;rounds must be at least 1&quot;);
<span class="lineNum">     265 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">     266 </span>            :             }
<span class="lineNum">     267 </span><span class="lineCov">          5 :         } else if (strcmp(k, &quot;truncate&quot;) == 0) {</span>
<span class="lineNum">     268 </span><span class="lineCov">          2 :             if (str_to_uint(value, &amp;truncbits)&lt;0) {</span>
<span class="lineNum">     269 </span><span class="lineNoCov">          0 :                 *error_r = t_strdup_printf(</span>
<span class="lineNum">     270 </span>            :                     &quot;Cannot parse hash arguments:&quot;
<span class="lineNum">     271 </span>            :                     &quot;'%s' is not number for truncbits&quot;,
<span class="lineNum">     272 </span>            :                     value);
<span class="lineNum">     273 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">     274 </span>            :             }
<span class="lineNum">     275 </span><span class="lineCov">          2 :             truncbits = I_MIN(truncbits, method-&gt;digest_size*8);</span>
<span class="lineNum">     276 </span><span class="lineCov">          3 :         } else if (strcmp(k, &quot;salt&quot;) == 0) {</span>
<span class="lineNum">     277 </span><span class="lineCov">          2 :             str_truncate(salt, 0);</span>
<span class="lineNum">     278 </span><span class="lineCov">          2 :             if (var_expand_with_funcs(salt, value, ctx-&gt;table,</span>
<span class="lineNum">     279 </span>            :                           ctx-&gt;func_table, ctx-&gt;context,
<span class="lineNum">     280 </span>            :                           error_r) &lt; 0) {
<span class="lineNum">     281 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">     282 </span>            :             }
<span class="lineNum">     283 </span><span class="lineCov">          2 :             break;</span>
<span class="lineNum">     284 </span><span class="lineCov">          1 :         } else if (strcmp(k, &quot;format&quot;) == 0) {</span>
<span class="lineNum">     285 </span><span class="lineCov">          1 :             if (strcmp(value, &quot;hex&quot;) == 0) {</span>
<span class="lineNum">     286 </span><span class="lineNoCov">          0 :                 format = FORMAT_HEX;</span>
<span class="lineNum">     287 </span><span class="lineCov">          1 :             } else if (strcmp(value, &quot;hexuc&quot;) == 0){</span>
<span class="lineNum">     288 </span><span class="lineNoCov">          0 :                 format = FORMAT_HEX_UC;</span>
<span class="lineNum">     289 </span><span class="lineCov">          1 :             } else if (strcmp(value, &quot;base64&quot;) == 0) {</span>
<span class="lineNum">     290 </span><span class="lineCov">          1 :                 format = FORMAT_BASE64;</span>
<span class="lineNum">     291 </span>            :             } else {
<span class="lineNum">     292 </span><span class="lineNoCov">          0 :                 *error_r = t_strdup_printf(</span>
<span class="lineNum">     293 </span>            :                     &quot;Cannot parse hash arguments:&quot;
<span class="lineNum">     294 </span>            :                     &quot;'%s' is not supported format&quot;,
<span class="lineNum">     295 </span>            :                     value);
<span class="lineNum">     296 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">     297 </span>            :             }
<span class="lineNum">     298 </span>            :         }
<span class="lineNum">     299 </span><span class="lineCov">          5 :         args++;</span>
<span class="lineNum">     300 </span>            :     }
<span class="lineNum">     301 </span>            : 
<span class="lineNum">     302 </span><span class="lineCov">          9 :     str_truncate(tmp, 0);</span>
<span class="lineNum">     303 </span>            : 
<span class="lineNum">     304 </span><span class="lineCov">          9 :     if (strcmp(algo, &quot;pkcs5&quot;) == 0) {</span>
<span class="lineNum">     305 </span><span class="lineNoCov">          0 :         if (pkcs5_pbkdf(PKCS5_PBKDF2, method,</span>
<span class="lineNum">     306 </span><span class="lineNoCov">          0 :                 field_value-&gt;data, field_value-&gt;used,</span>
<span class="lineNum">     307 </span><span class="lineNoCov">          0 :                 salt-&gt;data, salt-&gt;used,</span>
<span class="lineNum">     308 </span>            :                 rounds, HMAC_MAX_CONTEXT_SIZE, tmp) != 0) {
<span class="lineNum">     309 </span><span class="lineNoCov">          0 :             *error_r = &quot;Cannot hash: PKCS5_PBKDF2 failed&quot;;</span>
<span class="lineNum">     310 </span><span class="lineNoCov">          0 :             return -1;</span>
<span class="lineNum">     311 </span>            :         }
<span class="lineNum">     312 </span>            :     } else {
<span class="lineNum">     313 </span><span class="lineCov">          9 :         void *context = t_malloc_no0(method-&gt;context_size);</span>
<span class="lineNum">     314 </span>            : 
<span class="lineNum">     315 </span><span class="lineCov">          9 :         str_append_str(tmp, field_value);</span>
<span class="lineNum">     316 </span>            : 
<span class="lineNum">     317 </span><span class="lineCov">       2016 :         for(;rounds&gt;0;rounds--) {</span>
<span class="lineNum">     318 </span><span class="lineCov">       2007 :             method-&gt;init(context);</span>
<span class="lineNum">     319 </span><span class="lineCov">       2007 :             if (salt-&gt;used &gt; 0)</span>
<span class="lineNum">     320 </span><span class="lineCov">       2000 :                 method-&gt;loop(context, salt-&gt;data, salt-&gt;used);</span>
<span class="lineNum">     321 </span><span class="lineCov">       2007 :             method-&gt;loop(context, tmp-&gt;data, tmp-&gt;used);</span>
<span class="lineNum">     322 </span><span class="lineCov">       2007 :             unsigned char *digest =</span>
<span class="lineNum">     323 </span>            :                 buffer_get_modifiable_data(tmp, NULL);
<span class="lineNum">     324 </span><span class="lineCov">       2007 :             method-&gt;result(context, digest);</span>
<span class="lineNum">     325 </span><span class="lineCov">       2007 :             if (tmp-&gt;used != method-&gt;digest_size)</span>
<span class="lineNum">     326 </span><span class="lineCov">          9 :                 buffer_set_used_size(tmp, method-&gt;digest_size);</span>
<span class="lineNum">     327 </span>            :         }
<span class="lineNum">     328 </span>            :     }
<span class="lineNum">     329 </span>            : 
<span class="lineNum">     330 </span><span class="lineCov">          9 :     if (truncbits &gt; 0)</span>
<span class="lineNum">     331 </span><span class="lineCov">          2 :         buffer_truncate_rshift_bits(tmp, truncbits);</span>
<span class="lineNum">     332 </span>            : 
<span class="lineNum">     333 </span><span class="lineCov">          9 :     switch(format) {</span>
<span class="lineNum">     334 </span>            :         case FORMAT_HEX:
<span class="lineNum">     335 </span><span class="lineCov">          8 :             *result_r = binary_to_hex(tmp-&gt;data, tmp-&gt;used);</span>
<span class="lineNum">     336 </span><span class="lineCov">          8 :             return 1;</span>
<span class="lineNum">     337 </span>            :         case FORMAT_HEX_UC:
<span class="lineNum">     338 </span><span class="lineNoCov">          0 :             *result_r = binary_to_hex(tmp-&gt;data, tmp-&gt;used);</span>
<span class="lineNum">     339 </span><span class="lineNoCov">          0 :             return 1;</span>
<span class="lineNum">     340 </span>            :         case FORMAT_BASE64: {
<span class="lineNum">     341 </span><span class="lineCov">          1 :             string_t *dest = t_str_new(64);</span>
<span class="lineNum">     342 </span><span class="lineCov">          1 :             base64_encode(tmp-&gt;data, tmp-&gt;used, dest);</span>
<span class="lineNum">     343 </span><span class="lineCov">          1 :             *result_r = str_c(dest);</span>
<span class="lineNum">     344 </span><span class="lineCov">          1 :             return 1;</span>
<span class="lineNum">     345 </span>            :         }
<span class="lineNum">     346 </span>            :     }
<span class="lineNum">     347 </span>            : 
<span class="lineNum">     348 </span><span class="lineNoCov">          0 :     i_unreached();</span>
<span class="lineNum">     349 </span>            : }
<a name="350"><span class="lineNum">     350 </span>            : </a>
<span class="lineNum">     351 </span>            : static int
<span class="lineNum">     352 </span><span class="lineCov">         32 : var_expand_func(const struct var_expand_func_table *func_table,</span>
<span class="lineNum">     353 </span>            :         const char *key, const char *data, void *context,
<span class="lineNum">     354 </span>            :         const char **var_r, const char **error_r)
<span class="lineNum">     355 </span>            : {
<span class="lineNum">     356 </span><span class="lineCov">         32 :     const char *value = NULL;</span>
<span class="lineNum">     357 </span>            :     int ret;
<span class="lineNum">     358 </span>            : 
<span class="lineNum">     359 </span><span class="lineCov">         32 :     if (strcmp(key, &quot;env&quot;) == 0) {</span>
<span class="lineNum">     360 </span><span class="lineCov">          1 :         value = getenv(data);</span>
<span class="lineNum">     361 </span><span class="lineCov">          1 :         *var_r = value != NULL ? value : &quot;&quot;;</span>
<span class="lineNum">     362 </span><span class="lineCov">          1 :         return 1;</span>
<span class="lineNum">     363 </span>            :     }
<span class="lineNum">     364 </span><span class="lineCov">         31 :     if (func_table != NULL) {</span>
<span class="lineNum">     365 </span><span class="lineCov">         62 :         for (; func_table-&gt;key != NULL; func_table++) {</span>
<span class="lineNum">     366 </span><span class="lineCov">         62 :             if (strcmp(func_table-&gt;key, key) == 0) {</span>
<span class="lineNum">     367 </span><span class="lineCov">         28 :                 ret = func_table-&gt;func(data, context, &amp;value, error_r);</span>
<span class="lineNum">     368 </span><span class="lineCov">         28 :                 *var_r = value != NULL ? value : &quot;&quot;;</span>
<span class="lineNum">     369 </span><span class="lineCov">         28 :                 return ret;</span>
<span class="lineNum">     370 </span>            :             }
<span class="lineNum">     371 </span>            :         }
<span class="lineNum">     372 </span>            :     }
<span class="lineNum">     373 </span><span class="lineCov">          3 :     if (*error_r == NULL)</span>
<span class="lineNum">     374 </span><span class="lineCov">          3 :         *error_r = t_strdup_printf(&quot;Unknown variable '%%%s'&quot;, key);</span>
<span class="lineNum">     375 </span><span class="lineCov">          3 :     *var_r = t_strdup_printf(&quot;UNSUPPORTED_VARIABLE_%s&quot;, key);</span>
<span class="lineNum">     376 </span><span class="lineCov">          3 :     return 0;</span>
<span class="lineNum">     377 </span>            : }
<a name="378"><span class="lineNum">     378 </span>            : </a>
<span class="lineNum">     379 </span>            : static int
<span class="lineNum">     380 </span><span class="lineCov">       2119 : var_expand_try_extension(struct var_expand_context *ctx,</span>
<span class="lineNum">     381 </span>            :              const char *key, const char *data,
<span class="lineNum">     382 </span>            :              const char **var_r, const char **error_r)
<span class="lineNum">     383 </span>            : {
<span class="lineNum">     384 </span>            :     int ret;
<span class="lineNum">     385 </span><span class="lineCov">       2119 :     const char *sep = strchr(key, ';');</span>
<span class="lineNum">     386 </span>            : 
<span class="lineNum">     387 </span><span class="lineCov">       2119 :     if (sep == NULL) sep = key + strlen(key);</span>
<span class="lineNum">     388 </span>            : 
<span class="lineNum">     389 </span>            :     /* try with extensions */
<span class="lineNum">     390 </span>            :     const struct var_expand_extension_func_table *f;
<span class="lineNum">     391 </span><span class="lineCov">       4093 :     array_foreach(&amp;var_expand_extensions, f) {</span>
<span class="lineNum">     392 </span>            :         /* ensure we won't match abbreviations */
<span class="lineNum">     393 </span><span class="lineCov">       4061 :         size_t len = sep-key;</span>
<span class="lineNum">     394 </span><span class="lineCov">       4061 :         if (strncasecmp(key, f-&gt;key, len) == 0 &amp;&amp; f-&gt;key[len] == '\0')</span>
<span class="lineNum">     395 </span><span class="lineCov">       2087 :             return f-&gt;func(ctx, key, data, var_r, error_r);</span>
<span class="lineNum">     396 </span>            :     }
<span class="lineNum">     397 </span><span class="lineCov">         32 :     if ((ret = var_expand_func(ctx-&gt;func_table, key, data,</span>
<span class="lineNum">     398 </span>            :                    ctx-&gt;context, var_r, error_r)) == 0) {
<span class="lineNum">     399 </span><span class="lineCov">          6 :         *error_r = t_strdup_printf(&quot;Unknown variable '%%%s'&quot;, key);</span>
<span class="lineNum">     400 </span>            :     }
<span class="lineNum">     401 </span><span class="lineCov">         32 :     return ret;</span>
<span class="lineNum">     402 </span>            : }
<span class="lineNum">     403 </span>            : 
<a name="404"><span class="lineNum">     404 </span>            : </a>
<span class="lineNum">     405 </span>            : int
<span class="lineNum">     406 </span><span class="lineCov">       6244 : var_expand_long(struct var_expand_context *ctx,</span>
<span class="lineNum">     407 </span>            :         const void *key_start, size_t key_len,
<span class="lineNum">     408 </span>            :         const char **var_r, const char **error_r)
<span class="lineNum">     409 </span>            : {
<span class="lineNum">     410 </span>            :     const struct var_expand_table *t;
<span class="lineNum">     411 </span><span class="lineCov">       6244 :     const char *key, *value = NULL;</span>
<span class="lineNum">     412 </span><span class="lineCov">       6244 :     int ret = 1;</span>
<span class="lineNum">     413 </span>            : 
<span class="lineNum">     414 </span><span class="lineCov">       6244 :     if (ctx-&gt;table != NULL) {</span>
<span class="lineNum">     415 </span><span class="lineCov">      31387 :         for (t = ctx-&gt;table; !TABLE_LAST(t); t++) {</span>
<span class="lineNum">     416 </span><span class="lineCov">      58458 :             if (t-&gt;long_key != NULL &amp;&amp;</span>
<span class="lineNum">     417 </span><span class="lineCov">      33317 :                 strncmp(t-&gt;long_key, key_start, key_len) == 0 &amp;&amp;</span>
<span class="lineNum">     418 </span><span class="lineCov">       4125 :                 t-&gt;long_key[key_len] == '\0') {</span>
<span class="lineNum">     419 </span><span class="lineCov">       4123 :                 *var_r = t-&gt;value != NULL ? t-&gt;value : &quot;&quot;;</span>
<span class="lineNum">     420 </span><span class="lineCov">       4123 :                 return 1;</span>
<span class="lineNum">     421 </span>            :             }
<span class="lineNum">     422 </span>            :         }
<span class="lineNum">     423 </span>            :     }
<span class="lineNum">     424 </span><span class="lineCov">       2121 :     key = t_strndup(key_start, key_len);</span>
<span class="lineNum">     425 </span>            : 
<span class="lineNum">     426 </span>            :     /* built-in variables: */
<span class="lineNum">     427 </span><span class="lineCov">       2121 :     switch (key_len) {</span>
<span class="lineNum">     428 </span>            :     case 3:
<span class="lineNum">     429 </span><span class="lineCov">          2 :         if (strcmp(key, &quot;pid&quot;) == 0)</span>
<span class="lineNum">     430 </span><span class="lineCov">          1 :             value = my_pid;</span>
<span class="lineNum">     431 </span><span class="lineCov">          1 :         else if (strcmp(key, &quot;uid&quot;) == 0)</span>
<span class="lineNum">     432 </span><span class="lineNoCov">          0 :             value = dec2str(geteuid());</span>
<span class="lineNum">     433 </span><span class="lineCov">          1 :         else if (strcmp(key, &quot;gid&quot;) == 0)</span>
<span class="lineNum">     434 </span><span class="lineNoCov">          0 :             value = dec2str(getegid());</span>
<span class="lineNum">     435 </span><span class="lineCov">          2 :         break;</span>
<span class="lineNum">     436 </span>            :     case 8:
<span class="lineNum">     437 </span><span class="lineCov">          3 :         if (strcmp(key, &quot;hostname&quot;) == 0)</span>
<span class="lineNum">     438 </span><span class="lineCov">          1 :             value = my_hostname;</span>
<span class="lineNum">     439 </span><span class="lineCov">          3 :         break;</span>
<span class="lineNum">     440 </span>            :     }
<span class="lineNum">     441 </span>            : 
<span class="lineNum">     442 </span><span class="lineCov">       2121 :     if (value == NULL) {</span>
<span class="lineNum">     443 </span><span class="lineCov">       2119 :         const char *data = strchr(key, ':');</span>
<span class="lineNum">     444 </span>            : 
<span class="lineNum">     445 </span><span class="lineCov">       2119 :         if (data != NULL)</span>
<span class="lineNum">     446 </span><span class="lineCov">       2040 :             key = t_strdup_until(key, data++);</span>
<span class="lineNum">     447 </span>            :         else
<span class="lineNum">     448 </span><span class="lineCov">         79 :             data = &quot;&quot;;</span>
<span class="lineNum">     449 </span>            : 
<span class="lineNum">     450 </span><span class="lineCov">       2119 :         ret = var_expand_try_extension(ctx, key, data, &amp;value, error_r);</span>
<span class="lineNum">     451 </span>            : 
<span class="lineNum">     452 </span><span class="lineCov">       2119 :         if (ret &lt;= 0 &amp;&amp; value == NULL) {</span>
<span class="lineNum">     453 </span><span class="lineCov">         10 :             value = &quot;&quot;;</span>
<span class="lineNum">     454 </span>            :         }
<span class="lineNum">     455 </span>            :     }
<span class="lineNum">     456 </span><span class="lineCov">       2121 :     *var_r = value;</span>
<span class="lineNum">     457 </span><span class="lineCov">       2121 :     return ret;</span>
<a name="458"><span class="lineNum">     458 </span>            : }</a>
<span class="lineNum">     459 </span>            : 
<span class="lineNum">     460 </span><span class="lineCov">       4465 : int var_expand_with_funcs(string_t *dest, const char *str,</span>
<span class="lineNum">     461 </span>            :               const struct var_expand_table *table,
<span class="lineNum">     462 </span>            :               const struct var_expand_func_table *func_table,
<span class="lineNum">     463 </span>            :               void *context, const char **error_r)
<span class="lineNum">     464 </span>            : {
<span class="lineNum">     465 </span>            :     const struct var_expand_modifier *m;
<span class="lineNum">     466 </span>            :     const char *var;
<span class="lineNum">     467 </span>            :     struct var_expand_context ctx;
<span class="lineNum">     468 </span>            :     const char *(*modifier[MAX_MODIFIER_COUNT])
<span class="lineNum">     469 </span>            :         (const char *, struct var_expand_context *);
<span class="lineNum">     470 </span>            :     const char *end;
<span class="lineNum">     471 </span>            :     unsigned int i, modifier_count;
<span class="lineNum">     472 </span>            :     size_t len;
<span class="lineNum">     473 </span><span class="lineCov">       4465 :     int ret, final_ret = 1;</span>
<span class="lineNum">     474 </span>            : 
<span class="lineNum">     475 </span><span class="lineCov">       4465 :     *error_r = NULL;</span>
<span class="lineNum">     476 </span>            : 
<span class="lineNum">     477 </span><span class="lineCov">       4465 :     i_zero(&amp;ctx);</span>
<span class="lineNum">     478 </span><span class="lineCov">       4465 :     ctx.table = table;</span>
<span class="lineNum">     479 </span><span class="lineCov">       4465 :     ctx.func_table = func_table;</span>
<span class="lineNum">     480 </span><span class="lineCov">       4465 :     ctx.context = context;</span>
<span class="lineNum">     481 </span>            : 
<span class="lineNum">     482 </span><span class="lineCov">       9788 :     for (; *str != '\0'; str++) {</span>
<span class="lineNum">     483 </span><span class="lineCov">       5323 :         if (*str != '%')</span>
<span class="lineNum">     484 </span><span class="lineCov">       1040 :             str_append_c(dest, *str);</span>
<span class="lineNum">     485 </span>            :         else {
<span class="lineNum">     486 </span><span class="lineCov">       4283 :             int sign = 1;</span>
<span class="lineNum">     487 </span>            : 
<span class="lineNum">     488 </span><span class="lineCov">       4283 :             str++;</span>
<span class="lineNum">     489 </span>            : 
<span class="lineNum">     490 </span>            :             /* reset per-field modifiers */
<span class="lineNum">     491 </span><span class="lineCov">       4283 :             ctx.offset = 0;</span>
<span class="lineNum">     492 </span><span class="lineCov">       4283 :             ctx.width = 0;</span>
<span class="lineNum">     493 </span><span class="lineCov">       4283 :             ctx.zero_padding = FALSE;</span>
<span class="lineNum">     494 </span>            : 
<span class="lineNum">     495 </span>            :             /* [&lt;offset&gt;.]&lt;width&gt;[&lt;modifiers&gt;]&lt;variable&gt; */
<span class="lineNum">     496 </span><span class="lineCov">       4283 :             if (*str == '-') {</span>
<span class="lineNum">     497 </span><span class="lineCov">          2 :                 sign = -1;</span>
<span class="lineNum">     498 </span><span class="lineCov">          2 :                 str++;</span>
<span class="lineNum">     499 </span>            :             }
<span class="lineNum">     500 </span><span class="lineCov">       4283 :             if (*str == '0') {</span>
<span class="lineNum">     501 </span><span class="lineCov">          1 :                 ctx.zero_padding = TRUE;</span>
<span class="lineNum">     502 </span><span class="lineCov">          1 :                 str++;</span>
<span class="lineNum">     503 </span>            :             }
<span class="lineNum">     504 </span><span class="lineCov">       8580 :             while (*str &gt;= '0' &amp;&amp; *str &lt;= '9') {</span>
<span class="lineNum">     505 </span><span class="lineCov">         14 :                 ctx.width = ctx.width*10 + (*str - '0');</span>
<span class="lineNum">     506 </span><span class="lineCov">         14 :                 str++;</span>
<span class="lineNum">     507 </span>            :             }
<span class="lineNum">     508 </span>            : 
<span class="lineNum">     509 </span><span class="lineCov">       4283 :             if (*str == '.') {</span>
<span class="lineNum">     510 </span><span class="lineCov">          6 :                 ctx.offset = sign * ctx.width;</span>
<span class="lineNum">     511 </span><span class="lineCov">          6 :                 sign = 1;</span>
<span class="lineNum">     512 </span><span class="lineCov">          6 :                 ctx.width = 0;</span>
<span class="lineNum">     513 </span><span class="lineCov">          6 :                 str++;</span>
<span class="lineNum">     514 </span>            : 
<span class="lineNum">     515 </span>            :                 /* if offset was prefixed with zero (or it was
<span class="lineNum">     516 </span>            :                    plain zero), just ignore that. zero padding
<span class="lineNum">     517 </span>            :                    is done with the width. */
<span class="lineNum">     518 </span><span class="lineCov">          6 :                 ctx.zero_padding = FALSE;</span>
<span class="lineNum">     519 </span><span class="lineCov">          6 :                 if (*str == '0') {</span>
<span class="lineNum">     520 </span><span class="lineNoCov">          0 :                     ctx.zero_padding = TRUE;</span>
<span class="lineNum">     521 </span><span class="lineNoCov">          0 :                     str++;</span>
<span class="lineNum">     522 </span>            :                 }
<span class="lineNum">     523 </span><span class="lineCov">          6 :                 if (*str == '-') {</span>
<span class="lineNum">     524 </span><span class="lineCov">          3 :                     sign = -1;</span>
<span class="lineNum">     525 </span><span class="lineCov">          3 :                     str++;</span>
<span class="lineNum">     526 </span>            :                 }
<span class="lineNum">     527 </span>            : 
<span class="lineNum">     528 </span><span class="lineCov">         18 :                 while (*str &gt;= '0' &amp;&amp; *str &lt;= '9') {</span>
<span class="lineNum">     529 </span><span class="lineCov">          6 :                     ctx.width = ctx.width*10 + (*str - '0');</span>
<span class="lineNum">     530 </span><span class="lineCov">          6 :                     str++;</span>
<span class="lineNum">     531 </span>            :                 }
<span class="lineNum">     532 </span><span class="lineCov">          6 :                 ctx.width = sign * ctx.width;</span>
<span class="lineNum">     533 </span>            :             }
<span class="lineNum">     534 </span>            : 
<span class="lineNum">     535 </span><span class="lineCov">       4283 :             modifier_count = 0;</span>
<span class="lineNum">     536 </span><span class="lineCov">       8571 :             while (modifier_count &lt; MAX_MODIFIER_COUNT) {</span>
<span class="lineNum">     537 </span><span class="lineCov">       4288 :                 modifier[modifier_count] = NULL;</span>
<span class="lineNum">     538 </span><span class="lineCov">      47147 :                 for (m = modifiers; m-&gt;key != '\0'; m++) {</span>
<span class="lineNum">     539 </span><span class="lineCov">      42864 :                     if (m-&gt;key == *str) {</span>
<span class="lineNum">     540 </span>            :                         /* @UNSAFE */
<span class="lineNum">     541 </span><span class="lineCov">          5 :                         modifier[modifier_count] =</span>
<span class="lineNum">     542 </span><span class="lineCov">          5 :                             m-&gt;func;</span>
<span class="lineNum">     543 </span><span class="lineCov">          5 :                         str++;</span>
<span class="lineNum">     544 </span><span class="lineCov">          5 :                         break;</span>
<span class="lineNum">     545 </span>            :                     }
<span class="lineNum">     546 </span>            :                 }
<span class="lineNum">     547 </span><span class="lineCov">       4288 :                 if (modifier[modifier_count] == NULL)</span>
<span class="lineNum">     548 </span><span class="lineCov">       4283 :                     break;</span>
<span class="lineNum">     549 </span><span class="lineCov">          5 :                 modifier_count++;</span>
<span class="lineNum">     550 </span>            :             }
<span class="lineNum">     551 </span>            : 
<span class="lineNum">     552 </span><span class="lineCov">       4283 :             if (*str == '\0')</span>
<span class="lineNum">     553 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     554 </span>            : 
<span class="lineNum">     555 </span><span class="lineCov">       4283 :             var = NULL;</span>
<span class="lineNum">     556 </span><span class="lineCov">       8510 :             if (*str == '{' &amp;&amp; (end = strchr(str, '}')) != NULL) {</span>
<span class="lineNum">     557 </span>            :                 /* %{long_key} */
<span class="lineNum">     558 </span><span class="lineCov">       4227 :                 unsigned int ctr = 1;</span>
<span class="lineNum">     559 </span><span class="lineCov">       4227 :                 bool escape = FALSE;</span>
<span class="lineNum">     560 </span><span class="lineCov">       4227 :                 end = str;</span>
<span class="lineNum">     561 </span><span class="lineCov">     112778 :                 while(*++end != '\0' &amp;&amp; ctr &gt; 0) {</span>
<span class="lineNum">     562 </span><span class="lineCov">     104324 :                     if (!escape &amp;&amp; *end == '\\') {</span>
<span class="lineNum">     563 </span><span class="lineCov">          2 :                         escape = TRUE;</span>
<span class="lineNum">     564 </span><span class="lineCov">          2 :                         continue;</span>
<span class="lineNum">     565 </span>            :                     }
<span class="lineNum">     566 </span><span class="lineCov">     104322 :                     if (escape) {</span>
<span class="lineNum">     567 </span><span class="lineCov">          2 :                         escape = FALSE;</span>
<span class="lineNum">     568 </span><span class="lineCov">          2 :                         continue;</span>
<span class="lineNum">     569 </span>            :                     }
<span class="lineNum">     570 </span><span class="lineCov">     104320 :                     if (*end == '{') ctr++;</span>
<span class="lineNum">     571 </span><span class="lineCov">     104320 :                     if (*end == '}') ctr--;</span>
<span class="lineNum">     572 </span>            :                 }
<span class="lineNum">     573 </span><span class="lineCov">       4227 :                 if (ctr == 0)</span>
<span class="lineNum">     574 </span>            :                     /* it needs to come back a bit */
<span class="lineNum">     575 </span><span class="lineCov">       4227 :                     end--;</span>
<span class="lineNum">     576 </span>            :                 /* if there is no } it will consume rest of the
<span class="lineNum">     577 </span>            :                    string */
<span class="lineNum">     578 </span><span class="lineCov">       4227 :                 len = end - (str + 1);</span>
<span class="lineNum">     579 </span><span class="lineCov">       4227 :                 ret = var_expand_long(&amp;ctx, str+1, len,</span>
<span class="lineNum">     580 </span>            :                               &amp;var, error_r);
<span class="lineNum">     581 </span><span class="lineCov">       4227 :                 i_assert(var != NULL);</span>
<span class="lineNum">     582 </span><span class="lineCov">       4227 :                 str = end;</span>
<span class="lineNum">     583 </span>            :             } else {
<span class="lineNum">     584 </span><span class="lineCov">         56 :                 ret = var_expand_short(ctx.table, *str,</span>
<span class="lineNum">     585 </span>            :                                &amp;var, error_r);
<span class="lineNum">     586 </span>            :             }
<span class="lineNum">     587 </span><span class="lineCov">       4283 :             if (final_ret &gt; ret)</span>
<span class="lineNum">     588 </span><span class="lineCov">         18 :                 final_ret = ret;</span>
<span class="lineNum">     589 </span>            : 
<span class="lineNum">     590 </span><span class="lineCov">       4283 :             if (var != NULL) {</span>
<span class="lineNum">     591 </span><span class="lineCov">       4288 :                 for (i = 0; i &lt; modifier_count; i++)</span>
<span class="lineNum">     592 </span><span class="lineCov">          5 :                     var = modifier[i](var, &amp;ctx);</span>
<span class="lineNum">     593 </span>            : 
<span class="lineNum">     594 </span><span class="lineCov">       4283 :                 if (ctx.offset &lt; 0) {</span>
<span class="lineNum">     595 </span>            :                     /* if offset is &lt; 0 then we want to
<span class="lineNum">     596 </span>            :                        start at the end */
<span class="lineNum">     597 </span><span class="lineCov">          2 :                     size_t len = strlen(var);</span>
<span class="lineNum">     598 </span>            : 
<span class="lineNum">     599 </span><span class="lineCov">          2 :                     if (len &gt; (size_t)-ctx.offset)</span>
<span class="lineNum">     600 </span><span class="lineCov">          2 :                         var += len + ctx.offset;</span>
<span class="lineNum">     601 </span>            :                 } else {
<span class="lineNum">     602 </span><span class="lineCov">       8572 :                     while (*var != '\0' &amp;&amp; ctx.offset &gt; 0) {</span>
<span class="lineNum">     603 </span><span class="lineCov">         10 :                         ctx.offset--;</span>
<span class="lineNum">     604 </span><span class="lineCov">         10 :                         var++;</span>
<span class="lineNum">     605 </span>            :                     }
<span class="lineNum">     606 </span>            :                 }
<span class="lineNum">     607 </span><span class="lineCov">       4283 :                 if (ctx.width == 0)</span>
<span class="lineNum">     608 </span><span class="lineCov">       4276 :                     str_append(dest, var);</span>
<span class="lineNum">     609 </span><span class="lineCov">          7 :                 else if (!ctx.zero_padding) {</span>
<span class="lineNum">     610 </span><span class="lineCov">          7 :                     if (ctx.width &lt; 0)</span>
<span class="lineNum">     611 </span><span class="lineCov">          3 :                         ctx.width = strlen(var) - (-ctx.width);</span>
<span class="lineNum">     612 </span><span class="lineCov">          7 :                     str_append_n(dest, var, ctx.width);</span>
<span class="lineNum">     613 </span>            :                 } else {
<span class="lineNum">     614 </span>            :                     /* %05d -like padding. no truncation. */
<span class="lineNum">     615 </span><span class="lineNoCov">          0 :                     ssize_t len = strlen(var);</span>
<span class="lineNum">     616 </span><span class="lineNoCov">          0 :                     while (len &lt; ctx.width) {</span>
<span class="lineNum">     617 </span><span class="lineNoCov">          0 :                         str_append_c(dest, '0');</span>
<span class="lineNum">     618 </span><span class="lineNoCov">          0 :                         ctx.width--;</span>
<span class="lineNum">     619 </span>            :                     }
<span class="lineNum">     620 </span><span class="lineNoCov">          0 :                     str_append(dest, var);</span>
<span class="lineNum">     621 </span>            :                 }
<span class="lineNum">     622 </span>            :             }
<span class="lineNum">     623 </span>            :         }
<span class="lineNum">     624 </span>            :     }
<span class="lineNum">     625 </span><span class="lineCov">       4465 :     return final_ret;</span>
<a name="626"><span class="lineNum">     626 </span>            : }</a>
<span class="lineNum">     627 </span>            : 
<span class="lineNum">     628 </span><span class="lineCov">       2102 : int var_expand(string_t *dest, const char *str,</span>
<span class="lineNum">     629 </span>            :            const struct var_expand_table *table, const char **error_r)
<span class="lineNum">     630 </span>            : {
<span class="lineNum">     631 </span><span class="lineCov">       2102 :     return var_expand_with_funcs(dest, str, table, NULL, NULL, error_r);</span>
<span class="lineNum">     632 </span>            : }
<a name="633"><span class="lineNum">     633 </span>            : </a>
<span class="lineNum">     634 </span>            : static bool
<span class="lineNum">     635 </span><span class="lineCov">         71 : var_get_key_range_full(const char *str, unsigned int *idx_r,</span>
<span class="lineNum">     636 </span>            :                unsigned int *size_r)
<span class="lineNum">     637 </span>            : {
<span class="lineNum">     638 </span>            :     const struct var_expand_modifier *m;
<span class="lineNum">     639 </span><span class="lineCov">         71 :     unsigned int i = 0;</span>
<span class="lineNum">     640 </span>            : 
<span class="lineNum">     641 </span>            :     /* [&lt;offset&gt;.]&lt;width&gt;[&lt;modifiers&gt;]&lt;variable&gt; */
<span class="lineNum">     642 </span><span class="lineCov">        174 :     while ((str[i] &gt;= '0' &amp;&amp; str[i] &lt;= '9') || str[i] == '-')</span>
<span class="lineNum">     643 </span><span class="lineCov">         32 :         i++;</span>
<span class="lineNum">     644 </span>            : 
<span class="lineNum">     645 </span><span class="lineCov">         71 :     if (str[i] == '.') {</span>
<span class="lineNum">     646 </span><span class="lineCov">         10 :         i++;</span>
<span class="lineNum">     647 </span><span class="lineCov">         30 :         while ((str[i] &gt;= '0' &amp;&amp; str[i] &lt;= '9') || str[i] == '-')</span>
<span class="lineNum">     648 </span><span class="lineCov">         10 :             i++;</span>
<span class="lineNum">     649 </span>            :     }
<span class="lineNum">     650 </span>            : 
<span class="lineNum">     651 </span>            :     do {
<span class="lineNum">     652 </span><span class="lineCov">        918 :         for (m = modifiers; m-&gt;key != '\0'; m++) {</span>
<span class="lineNum">     653 </span><span class="lineCov">        847 :             if (m-&gt;key == str[i]) {</span>
<span class="lineNum">     654 </span><span class="lineCov">         22 :                 i++;</span>
<span class="lineNum">     655 </span><span class="lineCov">         22 :                 break;</span>
<span class="lineNum">     656 </span>            :             }
<span class="lineNum">     657 </span>            :         }
<span class="lineNum">     658 </span><span class="lineCov">         93 :     } while (m-&gt;key != '\0');</span>
<span class="lineNum">     659 </span>            : 
<span class="lineNum">     660 </span><span class="lineCov">         71 :     if (str[i] != '{') {</span>
<span class="lineNum">     661 </span>            :         /* short key */
<span class="lineNum">     662 </span><span class="lineCov">         46 :         *idx_r = i;</span>
<span class="lineNum">     663 </span><span class="lineCov">         46 :         *size_r = str[i] == '\0' ? 0 : 1;</span>
<span class="lineNum">     664 </span><span class="lineCov">         46 :         return FALSE;</span>
<span class="lineNum">     665 </span>            :     } else {
<span class="lineNum">     666 </span><span class="lineCov">         25 :         unsigned int depth = 1;</span>
<span class="lineNum">     667 </span><span class="lineCov">         25 :         bool escape = FALSE;</span>
<span class="lineNum">     668 </span>            :         /* long key */
<span class="lineNum">     669 </span><span class="lineCov">         25 :         *idx_r = ++i;</span>
<span class="lineNum">     670 </span><span class="lineCov">        179 :         for (; str[i] != '\0'; i++) {</span>
<span class="lineNum">     671 </span><span class="lineCov">        177 :             if (!escape &amp;&amp; str[i] == '\\') {</span>
<span class="lineNum">     672 </span><span class="lineNoCov">          0 :                 escape = TRUE;</span>
<span class="lineNum">     673 </span><span class="lineNoCov">          0 :                 continue;</span>
<span class="lineNum">     674 </span>            :             }
<span class="lineNum">     675 </span><span class="lineCov">        177 :             if (escape) {</span>
<span class="lineNum">     676 </span><span class="lineNoCov">          0 :                 escape = FALSE;</span>
<span class="lineNum">     677 </span><span class="lineNoCov">          0 :                 continue;</span>
<span class="lineNum">     678 </span>            :             }
<span class="lineNum">     679 </span><span class="lineCov">        177 :             if (str[i] == '{')</span>
<span class="lineNum">     680 </span><span class="lineCov">          2 :                 depth++;</span>
<span class="lineNum">     681 </span><span class="lineCov">        177 :             if (str[i] == '}') {</span>
<span class="lineNum">     682 </span><span class="lineCov">         25 :                 if (--depth==0)</span>
<span class="lineNum">     683 </span><span class="lineCov">         23 :                     break;</span>
<span class="lineNum">     684 </span>            :             }
<span class="lineNum">     685 </span>            :         }
<span class="lineNum">     686 </span><span class="lineCov">         25 :         *size_r = i - *idx_r;</span>
<span class="lineNum">     687 </span><span class="lineCov">         25 :         return TRUE;</span>
<span class="lineNum">     688 </span>            :     }
<a name="689"><span class="lineNum">     689 </span>            : }</a>
<span class="lineNum">     690 </span>            : 
<span class="lineNum">     691 </span><span class="lineCov">         27 : char var_get_key(const char *str)</span>
<span class="lineNum">     692 </span>            : {
<span class="lineNum">     693 </span>            :     unsigned int idx, size;
<span class="lineNum">     694 </span>            : 
<span class="lineNum">     695 </span><span class="lineCov">         27 :     if (var_get_key_range_full(str, &amp;idx, &amp;size))</span>
<span class="lineNum">     696 </span><span class="lineCov">          7 :         return '{';</span>
<span class="lineNum">     697 </span><span class="lineCov">         20 :     return str[idx];</span>
<a name="698"><span class="lineNum">     698 </span>            : }</a>
<span class="lineNum">     699 </span>            : 
<span class="lineNum">     700 </span><span class="lineCov">         44 : void var_get_key_range(const char *str, unsigned int *idx_r,</span>
<span class="lineNum">     701 </span>            :                unsigned int *size_r)
<span class="lineNum">     702 </span>            : {
<span class="lineNum">     703 </span><span class="lineCov">         44 :     (void)var_get_key_range_full(str, idx_r, size_r);</span>
<a name="704"><span class="lineNum">     704 </span><span class="lineCov">         44 : }</span></a>
<span class="lineNum">     705 </span>            : 
<span class="lineNum">     706 </span><span class="lineCov">          3 : static bool var_has_long_key(const char **str, const char *long_key)</span>
<span class="lineNum">     707 </span>            : {
<span class="lineNum">     708 </span>            :     const char *start, *end;
<span class="lineNum">     709 </span>            : 
<span class="lineNum">     710 </span><span class="lineCov">          3 :     start = strchr(*str, '{');</span>
<span class="lineNum">     711 </span><span class="lineCov">          3 :     i_assert(start != NULL);</span>
<span class="lineNum">     712 </span>            : 
<span class="lineNum">     713 </span><span class="lineCov">          3 :     end = strchr(++start, '}');</span>
<span class="lineNum">     714 </span><span class="lineCov">          3 :     if (end == NULL)</span>
<span class="lineNum">     715 </span><span class="lineNoCov">          0 :         return FALSE;</span>
<span class="lineNum">     716 </span>            : 
<span class="lineNum">     717 </span><span class="lineCov">          6 :     if (strncmp(start, long_key, end-start) == 0 &amp;&amp;</span>
<span class="lineNum">     718 </span><span class="lineCov">          3 :         long_key[end-start] == '\0')</span>
<span class="lineNum">     719 </span><span class="lineCov">          3 :         return TRUE;</span>
<span class="lineNum">     720 </span>            : 
<span class="lineNum">     721 </span><span class="lineNoCov">          0 :     *str = end;</span>
<span class="lineNum">     722 </span><span class="lineNoCov">          0 :     return FALSE;</span>
<a name="723"><span class="lineNum">     723 </span>            : }</a>
<span class="lineNum">     724 </span>            : 
<span class="lineNum">     725 </span><span class="lineCov">          9 : bool var_has_key(const char *str, char key, const char *long_key)</span>
<span class="lineNum">     726 </span>            : {
<span class="lineNum">     727 </span>            :     char c;
<span class="lineNum">     728 </span>            : 
<span class="lineNum">     729 </span><span class="lineCov">         22 :     for (; *str != '\0'; str++) {</span>
<span class="lineNum">     730 </span><span class="lineCov">         19 :         if (*str == '%' &amp;&amp; str[1] != '\0') {</span>
<span class="lineNum">     731 </span><span class="lineCov">         11 :             str++;</span>
<span class="lineNum">     732 </span><span class="lineCov">         11 :             c = var_get_key(str);</span>
<span class="lineNum">     733 </span><span class="lineCov">         11 :             if (c == key &amp;&amp; key != '\0')</span>
<span class="lineNum">     734 </span><span class="lineCov">          3 :                 return TRUE;</span>
<span class="lineNum">     735 </span>            : 
<span class="lineNum">     736 </span><span class="lineCov">          8 :             if (c == '{' &amp;&amp; long_key != NULL) {</span>
<span class="lineNum">     737 </span><span class="lineCov">          3 :                 if (var_has_long_key(&amp;str, long_key))</span>
<span class="lineNum">     738 </span><span class="lineCov">          3 :                     return TRUE;</span>
<span class="lineNum">     739 </span>            :             }
<span class="lineNum">     740 </span>            :         }
<span class="lineNum">     741 </span>            :     }
<span class="lineNum">     742 </span><span class="lineCov">          3 :     return FALSE;</span>
<a name="743"><span class="lineNum">     743 </span>            : }</a>
<span class="lineNum">     744 </span>            : 
<span class="lineNum">     745 </span><span class="lineCov">         88 : void var_expand_extensions_deinit(void)</span>
<span class="lineNum">     746 </span>            : {
<span class="lineNum">     747 </span><span class="lineCov">         88 :     array_free(&amp;var_expand_extensions);</span>
<a name="748"><span class="lineNum">     748 </span><span class="lineCov">         88 : }</span></a>
<span class="lineNum">     749 </span>            : 
<span class="lineNum">     750 </span><span class="lineCov">         88 : void var_expand_extensions_init(void)</span>
<span class="lineNum">     751 </span>            : {
<span class="lineNum">     752 </span><span class="lineCov">         88 :     i_array_init(&amp;var_expand_extensions, 32);</span>
<span class="lineNum">     753 </span>            : 
<span class="lineNum">     754 </span>            :     /* put all hash methods there */
<span class="lineNum">     755 </span><span class="lineCov">        880 :     for(const struct hash_method **meth = hash_methods;</span>
<span class="lineNum">     756 </span><span class="lineCov">        792 :         *meth != NULL;</span>
<span class="lineNum">     757 </span><span class="lineCov">        704 :         meth++) {</span>
<span class="lineNum">     758 </span><span class="lineCov">        704 :         struct var_expand_extension_func_table *func =</span>
<span class="lineNum">     759 </span>            :             array_append_space(&amp;var_expand_extensions);
<span class="lineNum">     760 </span><span class="lineCov">        704 :         func-&gt;key = (*meth)-&gt;name;</span>
<span class="lineNum">     761 </span><span class="lineCov">        704 :         func-&gt;func = var_expand_hash;</span>
<span class="lineNum">     762 </span>            :     }
<span class="lineNum">     763 </span>            : 
<span class="lineNum">     764 </span>            :     /* pkcs5 */
<span class="lineNum">     765 </span><span class="lineCov">         88 :     struct var_expand_extension_func_table *func =</span>
<span class="lineNum">     766 </span>            :         array_append_space(&amp;var_expand_extensions);
<span class="lineNum">     767 </span><span class="lineCov">         88 :     func-&gt;key = &quot;pkcs5&quot;;</span>
<span class="lineNum">     768 </span><span class="lineCov">         88 :     func-&gt;func = var_expand_hash;</span>
<span class="lineNum">     769 </span>            : 
<span class="lineNum">     770 </span>            :     /* if */
<span class="lineNum">     771 </span><span class="lineCov">         88 :     func = array_append_space(&amp;var_expand_extensions);</span>
<span class="lineNum">     772 </span><span class="lineCov">         88 :     func-&gt;key = &quot;if&quot;;</span>
<span class="lineNum">     773 </span><span class="lineCov">         88 :     func-&gt;func = var_expand_if;</span>
<span class="lineNum">     774 </span><span class="lineCov">         88 : }</span>
<a name="775"><span class="lineNum">     775 </span>            : </a>
<span class="lineNum">     776 </span>            : void
<span class="lineNum">     777 </span><span class="lineCov">          2 : var_expand_register_func_array(const struct var_expand_extension_func_table *funcs)</span>
<span class="lineNum">     778 </span>            : {
<span class="lineNum">     779 </span><span class="lineCov">          8 :     for(const struct var_expand_extension_func_table *ptr = funcs;</span>
<span class="lineNum">     780 </span><span class="lineCov">          6 :         ptr-&gt;key != NULL;</span>
<span class="lineNum">     781 </span><span class="lineCov">          4 :         ptr++) {</span>
<span class="lineNum">     782 </span><span class="lineCov">          4 :         i_assert(*ptr-&gt;key != '\0');</span>
<span class="lineNum">     783 </span><span class="lineCov">          4 :         array_insert(&amp;var_expand_extensions, 0, ptr, 1);</span>
<span class="lineNum">     784 </span>            :     }
<span class="lineNum">     785 </span><span class="lineCov">          2 : }</span>
<a name="786"><span class="lineNum">     786 </span>            : </a>
<span class="lineNum">     787 </span>            : void
<span class="lineNum">     788 </span><span class="lineCov">          2 : var_expand_unregister_func_array(const struct var_expand_extension_func_table *funcs)</span>
<span class="lineNum">     789 </span>            : {
<span class="lineNum">     790 </span><span class="lineCov">          8 :     for(const struct var_expand_extension_func_table *ptr = funcs;</span>
<span class="lineNum">     791 </span><span class="lineCov">          6 :         ptr-&gt;key != NULL;</span>
<span class="lineNum">     792 </span><span class="lineCov">          4 :         ptr++) {</span>
<span class="lineNum">     793 </span><span class="lineCov">          4 :         i_assert(ptr-&gt;func != NULL);</span>
<span class="lineNum">     794 </span><span class="lineCov">         46 :         for(unsigned int i = 0; i &lt; array_count(&amp;var_expand_extensions); i++) {</span>
<span class="lineNum">     795 </span><span class="lineCov">         42 :             const struct var_expand_extension_func_table *func =</span>
<span class="lineNum">     796 </span>            :                 array_idx(&amp;var_expand_extensions, i);
<span class="lineNum">     797 </span><span class="lineCov">         42 :             if (strcasecmp(func-&gt;key, ptr-&gt;key) == 0) {</span>
<span class="lineNum">     798 </span><span class="lineCov">          4 :                 array_delete(&amp;var_expand_extensions, i, 1);</span>
<span class="lineNum">     799 </span>            :             }
<span class="lineNum">     800 </span>            :         }
<span class="lineNum">     801 </span>            :     }
<span class="lineNum">     802 </span><span class="lineCov">          2 : }</span>
<a name="803"><span class="lineNum">     803 </span>            : </a>
<span class="lineNum">     804 </span>            : struct var_expand_table *
<span class="lineNum">     805 </span><span class="lineCov">          1 : var_expand_merge_tables(pool_t pool, const struct var_expand_table *a,</span>
<span class="lineNum">     806 </span>            :             const struct var_expand_table *b)
<span class="lineNum">     807 </span>            : {
<span class="lineNum">     808 </span>            :     ARRAY(struct var_expand_table) table;
<span class="lineNum">     809 </span><span class="lineCov">          1 :     size_t a_size = var_expand_table_size(a);</span>
<span class="lineNum">     810 </span><span class="lineCov">          1 :     size_t b_size = var_expand_table_size(b);</span>
<span class="lineNum">     811 </span><span class="lineCov">          1 :     p_array_init(&amp;table, pool, a_size + b_size + 1);</span>
<span class="lineNum">     812 </span><span class="lineCov">          3 :     for(size_t i=0; i&lt;a_size; i++) {</span>
<span class="lineNum">     813 </span><span class="lineCov">          2 :         struct var_expand_table *entry =</span>
<span class="lineNum">     814 </span>            :             array_append_space(&amp;table);
<span class="lineNum">     815 </span><span class="lineCov">          2 :         entry-&gt;key = a[i].key;</span>
<span class="lineNum">     816 </span><span class="lineCov">          2 :         entry-&gt;value = p_strdup(pool, a[i].value);</span>
<span class="lineNum">     817 </span><span class="lineCov">          2 :         entry-&gt;long_key = p_strdup(pool, a[i].long_key);</span>
<span class="lineNum">     818 </span>            :     }
<span class="lineNum">     819 </span><span class="lineCov">          3 :     for(size_t i=0; i&lt;b_size; i++) {</span>
<span class="lineNum">     820 </span><span class="lineCov">          2 :         struct var_expand_table *entry =</span>
<span class="lineNum">     821 </span>            :             array_append_space(&amp;table);
<span class="lineNum">     822 </span><span class="lineCov">          2 :         entry-&gt;key = b[i].key;</span>
<span class="lineNum">     823 </span><span class="lineCov">          2 :         entry-&gt;value = p_strdup(pool, b[i].value);</span>
<span class="lineNum">     824 </span><span class="lineCov">          2 :         entry-&gt;long_key = p_strdup(pool, b[i].long_key);</span>
<span class="lineNum">     825 </span>            :     }
<span class="lineNum">     826 </span><span class="lineCov">          1 :     array_append_zero(&amp;table);</span>
<span class="lineNum">     827 </span><span class="lineCov">          1 :     return array_idx_modifiable(&amp;table, 0);</span>
<span class="lineNum">     828 </span>            : }
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.10</a></td></tr>
  </table>
  <br>

</body>
</html>
